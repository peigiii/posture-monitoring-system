<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å§¿åŠ¿ç›‘æµ‹ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1635988162/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="styles/main.css">
    <!-- CSS å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ styles/main.css -->
    <script src="js/constants.js"></script>
    <!-- å¸¸é‡å®šä¹‰å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/constants.js -->
    <script src="js/utils.js"></script>
    <!-- å·¥å…·å‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/utils.js -->
    <script src="js/algorithms.js"></script>
    <!-- ç®—æ³•ç±»å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/algorithms.js -->
    <script src="js/i18n.js"></script>
    <!-- å¤šè¯­è¨€æ”¯æŒå·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/i18n.js -->
    <script src="js/posture-analysis.js"></script>
    <!-- å§¿åŠ¿åˆ†æå‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/posture-analysis.js -->
    <script src="js/data-export.js"></script>
    <!-- æ•°æ®å¯¼å‡ºå’ŒæŠ¥å‘Šç”Ÿæˆå‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/data-export.js -->
    <script src="js/drawing-utils.js"></script>
    <!-- ç»˜åˆ¶å·¥å…·å‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/drawing-utils.js -->
    <script src="js/data-handler.js"></script>
    <!-- æ•°æ®å¤„ç†å‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/data-handler.js -->
    <script src="js/ui-utils.js"></script>
    <!-- UI å·¥å…·å‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/ui-utils.js -->
    <script src="js/alert-system.js"></script>
    <!-- è­¦æŠ¥ç³»ç»Ÿå‡½æ•°å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/alert-system.js -->
    <script src="js/accessibility.js"></script>
    <!-- æ— éšœç¢è®¿é—®æ¨¡å—å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/accessibility.js -->
    <script src="js/rehabilitation-dashboard.js"></script>
    <!-- åº·å¤ä»ªè¡¨æ¿æ¨¡å—å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/rehabilitation-dashboard.js -->
    <script src="js/personalized-suggestions.js"></script>
    <!-- ä¸ªæ€§åŒ–åº·å¤å»ºè®®æ¨¡å—å·²æå–åˆ°å¤–éƒ¨æ–‡ä»¶ js/personalized-suggestions.js -->
    <!-- AngleChart å’Œ AngleGauge ç»„ä»¶ç”±äº file:// åè®® CORS é™åˆ¶ï¼Œæš‚æ—¶å†…è”åœ¨ HTML ä¸­ -->
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // ============================================================================
        // æµ‹è¯•ï¼šç¡®ä¿è„šæœ¬èƒ½å¤Ÿæ‰§è¡Œ
        // ============================================================================
        console.log('âœ… Babel è„šæœ¬å¼€å§‹æ‰§è¡Œ...');
        
        // ============================================================================
        // React Hooks è§£æ„ - å¿…é¡»åœ¨ä½¿ç”¨å‰ä» React ä¸­è§£æ„
        // ============================================================================
        if (typeof React === 'undefined') {
            console.error('âŒ React æœªåŠ è½½ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ');
            document.body.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šReact æœªåŠ è½½</h1><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®</p><p>å¦‚æœä½¿ç”¨ file:// åè®®ï¼Œè¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ</p></div>';
            throw new Error('React is not loaded');
        }
        const { useState, useEffect, useRef } = React;
        
        // ============================================================================
        // React ç»„ä»¶ - å†…è”ï¼ˆç”±äº file:// åè®® CORS é™åˆ¶ï¼‰
        // ============================================================================
        
        // AngleChart ç»„ä»¶ - å®æ—¶è§’åº¦å›¾è¡¨ç»„ä»¶ï¼ˆä½¿ç”¨ Chart.jsï¼‰
        // æ³¨æ„ï¼šuseState, useEffect, useRef å·²åœ¨ä¸»ç»„ä»¶ä¸­å£°æ˜ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤å£°æ˜
        function AngleChart({ neckAngle, torsoAngle, neckThreshold, torsoThreshold, language = 'zh' }) {
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);
            const dataRef = useRef({
                labels: [],
                neckData: [],
                torsoData: []
            });
            const lastUpdateRef = useRef(0);
            
            useEffect(() => {
                if (!chartRef.current) return;
                
                const ctx = chartRef.current.getContext('2d');
                
                // åˆå§‹åŒ–å›¾è¡¨
                if (!chartInstanceRef.current) {
                    chartInstanceRef.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: language === 'zh' ? 'é¢ˆéƒ¨è§’åº¦' : 'Neck Angle',
                                    data: [],
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: language === 'zh' ? 'èº¯å¹²è§’åº¦' : 'Torso Angle',
                                    data: [],
                                    borderColor: 'rgb(168, 85, 247)',
                                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: language === 'zh' ? 'é¢ˆéƒ¨é˜ˆå€¼' : 'Neck Threshold',
                                    data: [],
                                    borderColor: 'rgba(59, 130, 246, 0.3)',
                                    borderDash: [5, 5],
                                    pointRadius: 0,
                                    fill: false
                                },
                                {
                                    label: language === 'zh' ? 'èº¯å¹²é˜ˆå€¼' : 'Torso Threshold',
                                    data: [],
                                    borderColor: 'rgba(168, 85, 247, 0.3)',
                                    borderDash: [5, 5],
                                    pointRadius: 0,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 60,
                                    title: {
                                        display: true,
                                        text: language === 'zh' ? 'è§’åº¦ (Â°)' : 'Angle (Â°)',
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: language === 'zh' ? 'æ—¶é—´' : 'Time',
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: 'rgba(255, 255, 255, 0.9)',
                                    bodyColor: 'rgba(255, 255, 255, 0.8)'
                                }
                            }
                        }
                    });
                }
                
                // æ›´æ–°æ•°æ®ï¼ˆä½¿ç”¨èŠ‚æµï¼Œæ¯2ç§’æœ€å¤šæ›´æ–°ä¸€æ¬¡ï¼‰
                const updateChart = () => {
                    const now = Date.now();
                    if (now - lastUpdateRef.current < 2000) return; // èŠ‚æµï¼šæ¯2ç§’æœ€å¤šæ›´æ–°ä¸€æ¬¡
                    lastUpdateRef.current = now;
                    
                    const timeStr = new Date().toLocaleTimeString();
                    dataRef.current.labels.push(timeStr);
                    dataRef.current.neckData.push(neckAngle);
                    dataRef.current.torsoData.push(torsoAngle);
                    
                    // åªä¿ç•™æœ€è¿‘30ä¸ªæ•°æ®ç‚¹
                    const maxPoints = 30;
                    if (dataRef.current.labels.length > maxPoints) {
                        dataRef.current.labels.shift();
                        dataRef.current.neckData.shift();
                        dataRef.current.torsoData.shift();
                    }
                    
                    // æ›´æ–°å›¾è¡¨
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.data.labels = dataRef.current.labels;
                        chartInstanceRef.current.data.datasets[0].data = dataRef.current.neckData;
                        chartInstanceRef.current.data.datasets[1].data = dataRef.current.torsoData;
                        chartInstanceRef.current.data.datasets[2].data = new Array(dataRef.current.labels.length).fill(neckThreshold);
                        chartInstanceRef.current.data.datasets[3].data = new Array(dataRef.current.labels.length).fill(torsoThreshold);
                        chartInstanceRef.current.update('none');
                    }
                };
                
                // åœ¨è§’åº¦å˜åŒ–æ—¶æ›´æ–°
                updateChart();
                
                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }
                };
            }, [neckAngle, torsoAngle, neckThreshold, torsoThreshold, language]);
            
            return (
                <div className="w-full h-64 bg-gray-800 rounded-lg p-2">
                    <canvas ref={chartRef} id="angle-chart-canvas" />
                </div>
            );
        }

        // AngleGauge ç»„ä»¶ - è§’åº¦ä»ªè¡¨ç›˜ç»„ä»¶
        function AngleGauge({ angle, threshold, label, color, language = 'zh' }) {
            const percentage = Math.min(100, (angle / threshold) * 100);
            const isGood = angle < threshold;
            
            return (
                <div className="flex flex-col items-center p-4 bg-gray-700 rounded-lg">
                    <p className="text-sm text-gray-300 mb-2">{label}</p>
                    <div className="relative w-32 h-32">
                        <svg className="transform -rotate-90" width="128" height="128">
                            <circle
                                cx="64"
                                cy="64"
                                r="56"
                                stroke="rgba(255, 255, 255, 0.1)"
                                strokeWidth="8"
                                fill="none"
                            />
                            <circle
                                cx="64"
                                cy="64"
                                r="56"
                                stroke={isGood ? '#10b981' : '#ef4444'}
                                strokeWidth="8"
                                fill="none"
                                strokeDasharray={`${2 * Math.PI * 56}`}
                                strokeDashoffset={`${2 * Math.PI * 56 * (1 - percentage / 100)}`}
                                strokeLinecap="round"
                            />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="text-center">
                                <p className="text-2xl font-bold" style={{ color: isGood ? '#10b981' : '#ef4444' }}>
                                    {angle.toFixed(1)}Â°
                                </p>
                                <p className="text-xs text-gray-400">/{threshold}Â°</p>
                            </div>
                        </div>
                    </div>
                    <p className={`text-xs mt-2 ${isGood ? 'text-green-400' : 'text-red-400'}`}>
                        {isGood ? (language === 'zh' ? 'è‰¯å¥½' : 'Good') : (language === 'zh' ? 'éœ€æ”¹å–„' : 'Needs Improvement')}
                    </p>
                </div>
            );
        }

        // ============================================================================
        // ============================================================================
        // å®æ—¶å§¿åŠ¿ç›‘æµ‹ç³»ç»Ÿ - ä¸»åº”ç”¨æ–‡ä»¶
        // Real-time Posture Monitoring System - Main Application File
        // ============================================================================
        // 
        // æ–‡ä»¶ç»“æ„è¯´æ˜ï¼š
        // 1. å¸¸é‡å®šä¹‰åŒºåŸŸ (CONSTANTS) - å·²æå–åˆ° js/constants.js
        // 2. å·¥å…·å‡½æ•°åŒºåŸŸ (UTILITY FUNCTIONS)
        // 3. æ ¸å¿ƒç®—æ³•ç±»åŒºåŸŸ (CORE ALGORITHM CLASSES)
        // 4. å§¿åŠ¿åˆ†æå‡½æ•°åŒºåŸŸ (POSTURE ANALYSIS FUNCTIONS)
        // 5. å¤šè¯­è¨€æ”¯æŒåŒºåŸŸ (I18N)
        // 6. React ç»„ä»¶åŒºåŸŸ (REACT COMPONENTS)
        // 7. åº”ç”¨å…¥å£ (APPLICATION ENTRY)
        //
        // ============================================================================
        // 2. å·¥å…·å‡½æ•°åŒºåŸŸ (UTILITY FUNCTIONS) - å·²æå–åˆ° js/utils.js
        // ============================================================================
        
        // ============================================================================
        // 3. æ ¸å¿ƒç®—æ³•ç±»åŒºåŸŸ (CORE ALGORITHM CLASSES) - å·²æå–åˆ° js/algorithms.js
        // ============================================================================

        // ============================================================================
        // 4. å¤šè¯­è¨€æ”¯æŒåŒºåŸŸ (I18N - Internationalization) - å·²æå–åˆ° js/i18n.js
        // ============================================================================

        // ============================================================================
        // 5. å§¿åŠ¿åˆ†æå‡½æ•°åŒºåŸŸ (POSTURE ANALYSIS FUNCTIONS) - å·²æå–åˆ° js/posture-analysis.js
        // ============================================================================
        // è¿™äº›å‡½æ•°ç°åœ¨ä»å¤–éƒ¨æ¨¡å—ä¸­è·å–
        const detectViewAngle = window.detectViewAngle || function(landmarks, canvasWidth) {
            console.error('detectViewAngle å‡½æ•°æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ js/posture-analysis.js æ˜¯å¦æ­£ç¡®åŠ è½½');
            return { mode: 'transitioning', confidence: 'low', message: 'å‡½æ•°æœªåŠ è½½', type: 'unknown' };
        };

        // ============================================================================
        // 5. å§¿åŠ¿åˆ†æå‡½æ•°åŒºåŸŸ (POSTURE ANALYSIS FUNCTIONS) - å·²æå–åˆ° js/posture-analysis.js
        // ============================================================================

        // ============================================================================
        // 6. React ç»„ä»¶åŒºåŸŸ (REACT COMPONENTS)
        // ============================================================================
        // åŒ…å«æ‰€æœ‰ React ç»„ä»¶å®šä¹‰
        // ============================================================================

        // ============================================================================
        // å§¿åŠ¿åˆ†æå‡½æ•° - å·²æå–åˆ° js/posture-analysis.js
        // ============================================================================
        // è¿™äº›å‡½æ•°ç°åœ¨è°ƒç”¨å¤–éƒ¨æ¨¡å—ä¸­çš„å‡½æ•°
        const calculatePostureScoreFront = window.calculatePostureScoreFront;
        const calculatePostureScoreSide = window.calculatePostureScoreSide;
        const analyzeFrontPosture = window.analyzeFrontPosture;
        const analyzeSidePosture = window.analyzeSidePosture;
        const generatePostureSuggestions = window.generatePostureSuggestions;
        const median = window.median;
        const calculateAngleWithFusion = window.calculateAngleWithFusion;

        // ============================================================================
        // ç»˜åˆ¶å·¥å…·å‡½æ•° - å·²æå–åˆ° js/drawing-utils.js
        // ============================================================================
        // è¿™äº›å‡½æ•°ç°åœ¨è°ƒç”¨å¤–éƒ¨æ¨¡å—ä¸­çš„å‡½æ•°
        const drawSideViewLines = window.drawSideViewLines;
        const drawFrontViewLines = window.drawFrontViewLines;

        // ============================= CHART COMPONENTS ==============================
        // 3. å®æ—¶è§’åº¦å›¾è¡¨ç»„ä»¶ - å·²å†…è”åˆ° HTMLï¼ˆé¿å… CORS é—®é¢˜ï¼‰
        // 4. è§’åº¦ä»ªè¡¨ç›˜ç»„ä»¶ - å·²å†…è”åˆ° HTMLï¼ˆé¿å… CORS é—®é¢˜ï¼‰

        // ============================================================================
        // 5. React ç»„ä»¶åŒºåŸŸ (REACT COMPONENTS)
        // ============================================================================
        // åŒ…å«æ‰€æœ‰ React ç»„ä»¶ï¼ŒåŒ…æ‹¬ä¸»åº”ç”¨ç»„ä»¶å’Œå­ç»„ä»¶
        // ============================================================================

        // ============================= MAIN COMPONENT ================================
        // ä¸»åº”ç”¨ç»„ä»¶ï¼šPostureMonitor
        // åŠŸèƒ½ï¼šç®¡ç†æ•´ä¸ªåº”ç”¨çš„çŠ¶æ€ã€MediaPipe åˆå§‹åŒ–ã€å§¿åŠ¿æ£€æµ‹é€»è¾‘
        // ============================================================================
        function PostureMonitor() {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const poseRef = useRef(null);
            const cameraRef = useRef(null);
            
            // æ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡çŠ¶æ€
            const [cameraSize, setCameraSize] = useState({ width: 640, height: 480 });
            
            const [isAligned, setIsAligned] = useState(false);
            const [neckInclination, setNeckInclination] = useState(0);
            const [torsoInclination, setTorsoInclination] = useState(0);
            const goodFramesRef = useRef(0);
            const badFramesRef = useRef(0);
            const [goodFrames, setGoodFrames] = useState(0);
            const [badFrames, setBadFrames] = useState(0);
            const [isGoodPosture, setIsGoodPosture] = useState(false);
            
            // æ”¹è¿›åŠŸèƒ½ï¼šè¯­è¨€æ”¯æŒå’Œå¹³æ»‘å¤„ç†
            const [language, setLanguage] = useState(() => {
                const saved = localStorage.getItem('postureLanguage');
                return saved || 'zh';
            });
            
            // è¯­è¨€åˆ‡æ¢å¤„ç†å‡½æ•°
            const handleLanguageChange = (newLang) => {
                setLanguage(newLang);
                localStorage.setItem('postureLanguage', newLang);
            };
            
            // ç¿»è¯‘è¾…åŠ©å‡½æ•°
            const t = (key, fallback = '') => {
                const keys = key.split('.');
                let value = i18n[language];
                for (const k of keys) {
                    value = value?.[k];
                }
                return value !== undefined ? value : (fallback || key);
            };
            // ========== Phase 1 ä¼˜åŒ–ï¼šè§’åº¦å¹³æ»‘å™¨å’Œæ»åé˜ˆå€¼ç³»ç»Ÿ ==========
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å·²åŠ è½½
            const AngleSmootherClass = window.AngleSmoother;
            const SMOOTHING_WINDOW_SIZE_VALUE = typeof SMOOTHING_WINDOW_SIZE !== 'undefined' ? SMOOTHING_WINDOW_SIZE : 10;
            const DEFAULT_NECK_THRESHOLD_VALUE = typeof DEFAULT_NECK_THRESHOLD !== 'undefined' ? DEFAULT_NECK_THRESHOLD : 40;
            
            if (!AngleSmootherClass) {
                console.error('AngleSmoother ç±»æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ js/algorithms.js æ˜¯å¦æ­£ç¡®åŠ è½½');
            }
            
            const angleSmootherRef = useRef(AngleSmootherClass ? new AngleSmootherClass(SMOOTHING_WINDOW_SIZE_VALUE) : null); // åŠ æƒç§»åŠ¨å¹³å‡
            const [smoothedNeck, setSmoothedNeck] = useState(0);
            const [smoothedTorso, setSmoothedTorso] = useState(0);
            
            const [neckThreshold, setNeckThreshold] = useState(DEFAULT_NECK_THRESHOLD_VALUE);
            const [torsoThreshold, setTorsoThreshold] = useState(15); // ä»10æ”¹ä¸º15ï¼Œæ›´åˆç†
            
            // ========== Phase 2 ä¼˜åŒ–ï¼šè‡ªé€‚åº”é˜ˆå€¼ç®¡ç†å™¨ ==========
            const AdaptiveThresholdManagerClass = window.AdaptiveThresholdManager;
            if (!AdaptiveThresholdManagerClass) {
                console.error('AdaptiveThresholdManager ç±»æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ js/algorithms.js æ˜¯å¦æ­£ç¡®åŠ è½½');
            }
            const adaptiveThresholdRef = useRef(AdaptiveThresholdManagerClass ? new AdaptiveThresholdManagerClass(
                DEFAULT_NECK_THRESHOLD_VALUE,
                15
            ) : null);
            const [useAdaptiveThreshold, setUseAdaptiveThreshold] = useState(false); // æ˜¯å¦å¯ç”¨è‡ªé€‚åº”é˜ˆå€¼
            
            // æ»åé˜ˆå€¼è¯„ä¼°å™¨ï¼ˆé˜²æ­¢çŠ¶æ€é¢‘ç¹åˆ‡æ¢ï¼‰
            const HysteresisEvaluatorClass = window.HysteresisEvaluator;
            if (!HysteresisEvaluatorClass) {
                console.error('HysteresisEvaluator ç±»æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ js/algorithms.js æ˜¯å¦æ­£ç¡®åŠ è½½');
            }
            const DEFAULT_TORSO_THRESHOLD_VALUE = typeof DEFAULT_TORSO_THRESHOLD !== 'undefined' ? DEFAULT_TORSO_THRESHOLD : 15;
            const hysteresisRef = useRef(HysteresisEvaluatorClass ? new HysteresisEvaluatorClass(
                DEFAULT_NECK_THRESHOLD_VALUE, 
                DEFAULT_TORSO_THRESHOLD_VALUE, 
                2 // æ»åå€¼ï¼š2åº¦
            ) : null);
            
            // å½“å†å²æ•°æ®æ›´æ–°æ—¶ï¼Œæ›´æ–°è‡ªé€‚åº”é˜ˆå€¼ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            useEffect(() => {
                if (useAdaptiveThreshold && history.length > 0) {
                    // æ›´æ–°åº·å¤é˜¶æ®µ
                    adaptiveThresholdRef.current.updateRehabLevel(history);
                    const adaptiveThresholds = adaptiveThresholdRef.current.getThresholds();
                    
                    // åªåœ¨é˜ˆå€¼å®é™…æ”¹å˜æ—¶æ›´æ–°ï¼ˆé¿å…å¾ªç¯ï¼‰
                    if (Math.abs(adaptiveThresholds.neck - neckThreshold) > 0.5 || 
                        Math.abs(adaptiveThresholds.torso - torsoThreshold) > 0.5) {
                        setNeckThreshold(adaptiveThresholds.neck);
                        setTorsoThreshold(adaptiveThresholds.torso);
                    }
                }
            }, [useAdaptiveThreshold, history]); // ç§»é™¤ neckThreshold, torsoThreshold ä¾èµ–
            
            // å½“é˜ˆå€¼æ”¹å˜æ—¶ï¼Œæ›´æ–°æ»åé˜ˆå€¼è¯„ä¼°å™¨
            useEffect(() => {
                if (hysteresisRef.current) {
                    hysteresisRef.current.updateThresholds(neckThreshold, torsoThreshold);
                }
            }, [neckThreshold, torsoThreshold]);
            
            // ä¿å­˜è¯­è¨€è®¾ç½®
            useEffect(() => {
                localStorage.setItem('postureLanguage', language);
            }, [language]);
            
            // è§’åº¦å¹³æ»‘å¤„ç†ï¼ˆä½¿ç”¨åŠ æƒç§»åŠ¨å¹³å‡ï¼‰
            useEffect(() => {
                if (neckInclination > 0 && torsoInclination > 0 && angleSmootherRef.current) {
                    const smoothed = angleSmootherRef.current.smooth(neckInclination, torsoInclination);
                    setSmoothedNeck(smoothed.neck);
                    setSmoothedTorso(smoothed.torso);
                }
            }, [neckInclination, torsoInclination]);
            const [shoulderThreshold, setShoulderThreshold] = useState(50); // æ­£é¢æ£€æµ‹ï¼šè‚©è†€é˜ˆå€¼
            const [headThreshold, setHeadThreshold] = useState(40); // æ­£é¢æ£€æµ‹ï¼šå¤´éƒ¨é˜ˆå€¼
            
            // SCIæ¨¡å¼çŠ¶æ€è·Ÿè¸ª
            const [currentThresholdMode, setCurrentThresholdModeState] = useState(() => {
                try {
                    const saved = localStorage.getItem('postureThresholdMode');
                    return saved && SCI_THRESHOLDS[saved] ? saved : 'standard';
                } catch (e) {
                    return 'standard';
                }
            });
            
            // åº·å¤é˜¶æ®µçŠ¶æ€
            const [rehabStage, setRehabStage] = useState(() => {
                try {
                    const saved = localStorage.getItem('rehabStage');
                    return saved || 'acute'; // acute | recovery | stable
                } catch (e) {
                    return 'acute';
                }
            });
            
            // é«˜å¯¹æ¯”åº¦æ¨¡å¼çŠ¶æ€
            const [highContrastMode, setHighContrastMode] = useState(() => {
                try {
                    // ä»localStorageè¯»å–ï¼Œå¦‚æœaccessibilityManagerè¿˜æ²¡åˆå§‹åŒ–ï¼Œç¨ååŒæ­¥
                    const saved = localStorage.getItem('accessibility_highContrast');
                    return saved === 'true';
                } catch (e) {
                    return false;
                }
            });
            
            // å­—ä½“å¤§å°çŠ¶æ€ï¼ˆç”¨äºå—æ§ç»„ä»¶ï¼‰
            const [fontSize, setFontSize] = useState(() => {
                try {
                    const saved = localStorage.getItem('accessibility_fontSize');
                    return saved ? parseInt(saved) : 100;
                } catch (e) {
                    return 100;
                }
            });
            
            // åˆå§‹åŒ–æ—¶åŒæ­¥é«˜å¯¹æ¯”åº¦çŠ¶æ€å’Œå­—ä½“å¤§å°
            useEffect(() => {
                if (window.accessibilityManager) {
                    // åŒæ­¥é«˜å¯¹æ¯”åº¦çŠ¶æ€
                    const currentContrastState = window.accessibilityManager.isHighContrast();
                    if (currentContrastState !== highContrastMode) {
                        setHighContrastMode(currentContrastState);
                    }
                    
                    // åŒæ­¥å­—ä½“å¤§å°
                    const currentFontSize = window.accessibilityManager.getFontSize();
                    if (currentFontSize !== fontSize) {
                        setFontSize(currentFontSize);
                    }
                } else {
                    // å¦‚æœaccessibilityManagerè¿˜æ²¡åˆå§‹åŒ–ï¼Œç­‰å¾…ä¸€ä¸‹å†åŒæ­¥
                    const timer = setTimeout(() => {
                        if (window.accessibilityManager) {
                            const currentFontSize = window.accessibilityManager.getFontSize();
                            setFontSize(currentFontSize);
                        }
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, []);
            
            // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„å­—ä½“å¤§å°
            useEffect(() => {
                if (window.accessibilityManager && fontSize) {
                    window.accessibilityManager.setFontSize(fontSize);
                }
            }, []); // åªåœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
            
            // ç®€åŒ–è§†å›¾æ¨¡å¼çŠ¶æ€
            const [simplifiedView, setSimplifiedView] = useState(() => {
                try {
                    const saved = localStorage.getItem('simplifiedView');
                    return saved === 'true';
                } catch (e) {
                    return false;
                }
            });
            
            // ä¿å­˜ç®€åŒ–è§†å›¾çŠ¶æ€
            useEffect(() => {
                localStorage.setItem('simplifiedView', simplifiedView.toString());
            }, [simplifiedView]);
            
            // åº”ç”¨åº·å¤é˜¶æ®µé˜ˆå€¼çš„è¾…åŠ©å‡½æ•°
            const applyRehabStageThresholds = (stage) => {
                if (!adaptiveThresholdRef.current) return;
                
                // å°†åº·å¤é˜¶æ®µæ˜ å°„åˆ°AdaptiveThresholdManagerçš„é˜¶æ®µ
                // acute -> early (å®½æ¾é˜ˆå€¼: é¢ˆéƒ¨60Â°, èº¯å¹²30Â°)
                // recovery -> middle (ä¸­ç­‰é˜ˆå€¼: é¢ˆéƒ¨48Â°, èº¯å¹²22.5Â°)
                // stable -> late (æ ‡å‡†é˜ˆå€¼: é¢ˆéƒ¨40Â°, èº¯å¹²15Â°)
                let rehabLevel = 'early';
                if (stage === 'recovery') {
                    rehabLevel = 'middle';
                } else if (stage === 'stable') {
                    rehabLevel = 'late';
                }
                
                // è®¾ç½®åº·å¤é˜¶æ®µ
                adaptiveThresholdRef.current.setRehabLevel(rehabLevel);
                
                // è·å–æ–°çš„é˜ˆå€¼
                const thresholds = adaptiveThresholdRef.current.getThresholds();
                
                // æ›´æ–°é˜ˆå€¼çŠ¶æ€
                setNeckThreshold(Math.round(thresholds.neck));
                setTorsoThreshold(Math.round(thresholds.torso));
                
                // æ›´æ–°æ»åé˜ˆå€¼è¯„ä¼°å™¨
                if (hysteresisRef.current) {
                    hysteresisRef.current.updateThresholds(thresholds.neck, thresholds.torso);
                }
                
                const stageNames = {
                    acute: { zh: 'æ€¥æ€§æœŸ', en: 'Acute Stage' },
                    recovery: { zh: 'æ¢å¤æœŸ', en: 'Recovery Stage' },
                    stable: { zh: 'ç¨³å®šæœŸ', en: 'Stable Stage' }
                };
                
                console.log(`âœ… åº·å¤é˜¶æ®µ: ${stageNames[stage][language]} (${rehabLevel})`);
                console.log(`   é˜ˆå€¼: é¢ˆéƒ¨=${thresholds.neck.toFixed(1)}Â°, èº¯å¹²=${thresholds.torso.toFixed(1)}Â°`);
            };
            
            // å½“åº·å¤é˜¶æ®µæ”¹å˜æ—¶ï¼Œæ›´æ–°é˜ˆå€¼ï¼ˆä»…å½“ä¸æ˜¯æ ‡å‡†æ¨¡å¼æ—¶ï¼‰
            useEffect(() => {
                // åªæœ‰åœ¨SCIæ‚£è€…æ¨¡å¼ä¸‹æ‰åº”ç”¨åº·å¤é˜¶æ®µé˜ˆå€¼
                if (currentThresholdMode !== 'standard' && adaptiveThresholdRef.current) {
                    applyRehabStageThresholds(rehabStage);
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('rehabStage', rehabStage);
            }, [rehabStage, currentThresholdMode]); // å½“rehabStageæˆ–currentThresholdModeæ”¹å˜æ—¶æ‰§è¡Œ
            
            // è¯„åˆ†ä¿¡æ¯æ˜¾ç¤ºçŠ¶æ€
            const [showScoreInfo, setShowScoreInfo] = useState(true);
            
            // P1: æ”¹è¿›å½•åˆ¶åŠŸèƒ½ - ä»…æ•°æ®å½•åˆ¶ï¼ˆç§»é™¤è§†é¢‘å½•åˆ¶ï¼‰
            const [recordingState, setRecordingState] = useState({
                status: 'idle', // idle | recording | processing
                duration: 0, // ç§’
                startTime: null
            });
            const [recordingData, setRecordingData] = useState([]);
            const recordingTimerRef = useRef(null);
            const [history, setHistory] = useState(() => {
                // ä½¿ç”¨å¤–éƒ¨æ¨¡å—åŠ è½½å†å²è®°å½•
                return window.loadHistory ? window.loadHistory() : [];
            });
            
            // ========== æ–°å¢ï¼šå½•åˆ¶ä¼šè¯ç®¡ç† ==========
            const [currentSession, setCurrentSession] = useState(null);
            const recordingIntervalRef = useRef(null);
            
            // ========== ä¿®å¤ä»»åŠ¡1: ä½¿ç”¨refå­˜å‚¨å®æ—¶æ•°æ®ï¼Œä¾›setIntervalè®¿é—® ==========
            const currentPostureDataRef = useRef({
                viewMode: 'transitioning',
                isGoodPosture: false,
                neckAngle: 0,
                torsoAngle: 0,
                shoulderTilt: 0,
                headTilt: 0
            });
            
            // ========== ä¿®å¤ä»»åŠ¡4: è­¦æŠ¥ç³»ç»ŸçŠ¶æ€ ==========
            const [badPostureTimer, setBadPostureTimer] = useState(0); // æŒç»­ä¸è‰¯å§¿åŠ¿çš„æ¯«ç§’æ•°ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰
            const badPostureTimerRef = useRef(0); // ä½¿ç”¨refå­˜å‚¨å®é™…è®¡æ—¶ï¼Œé¿å…é¢‘ç¹çŠ¶æ€æ›´æ–°
            const lastAlertTimeRef = useRef(0); // ä¸Šæ¬¡è­¦æŠ¥æ—¶é—´
            const alertSoundRef = useRef(null); // éŸ³æ•ˆä¸Šä¸‹æ–‡
            const [shouldAlert, setShouldAlert] = useState(false); // æ˜¯å¦éœ€è¦è§¦å‘è­¦æŠ¥
            const [alertInterval, setAlertInterval] = useState(() => {
                const saved = localStorage.getItem('postureAlertInterval');
                return saved ? parseInt(saved) : 5; // é»˜è®¤5ç§’
            });
            const [alertSoundEnabled, setAlertSoundEnabled] = useState(() => {
                const saved = localStorage.getItem('alertSoundEnabled');
                return saved !== 'false'; // é»˜è®¤å¯ç”¨
            });
            const [alertNotificationEnabled, setAlertNotificationEnabled] = useState(() => {
                const saved = localStorage.getItem('alertNotificationEnabled');
                return saved !== 'false'; // é»˜è®¤å¯ç”¨
            });
            
            // éŸ³æ•ˆä¸Šä¸‹æ–‡æ”¹ä¸ºæ‡’åŠ è½½ï¼ˆä¸åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œé¿å…å¡é¡¿ï¼‰
            
            // ä¿å­˜è­¦æŠ¥è®¾ç½®
            useEffect(() => {
                localStorage.setItem('postureAlertInterval', alertInterval.toString());
            }, [alertInterval]);
            useEffect(() => {
                localStorage.setItem('alertSoundEnabled', alertSoundEnabled.toString());
            }, [alertSoundEnabled]);
            useEffect(() => {
                localStorage.setItem('alertNotificationEnabled', alertNotificationEnabled.toString());
            }, [alertNotificationEnabled]);
            const warningShownRef = useRef(false);
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            useEffect(() => {
                if (alertNotificationEnabled && 'Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            }, [alertNotificationEnabled]);
            
            // P2: æš‚åœåŠŸèƒ½
            const [isPaused, setIsPaused] = useState(false);
            const noDetectionCountRef = useRef(0);
            
            // ç›‘æµ‹çŠ¶æ€ï¼ˆå¼€å§‹/æš‚åœç›‘æµ‹ï¼‰
            const [isMonitoring, setIsMonitoring] = useState(true); // é»˜è®¤å¼€å§‹ç›‘æµ‹
            
            // å†å²è®°å½•æŠ˜å çŠ¶æ€ï¼ˆé»˜è®¤æŠ˜å ï¼‰
            const [historyCollapsed, setHistoryCollapsed] = useState(() => {
                try {
                    // ä»localStorageè¯»å–ä¿å­˜çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸ºtrueï¼ˆæŠ˜å ï¼‰
                    const saved = localStorage.getItem('historyCollapsed');
                    return saved !== null ? saved === 'true' : true;
                } catch (e) {
                    return true; // é»˜è®¤æŠ˜å 
                }
            });
            
            // ä¿å­˜å†å²è®°å½•æŠ˜å çŠ¶æ€åˆ°localStorage
            useEffect(() => {
                localStorage.setItem('historyCollapsed', historyCollapsed.toString());
            }, [historyCollapsed]);
            
            // P3: æ€§èƒ½è‡ªé€‚åº”
            const [performanceMode, setPerformanceMode] = useState('high'); // high | low
            
            // P2: è°ƒè¯•ä¿¡æ¯çŠ¶æ€
            const [debugInfo, setDebugInfo] = useState({
                fps: 0,
                viewAngle: 'unknown',
                landmarkVisibility: {},
                rawCoordinates: {},
                showDebug: false
            });
            const [fps, setFps] = useState(0);
            const lastFrameTimeRef = useRef(performance.now());
            const fpsHistoryRef = useRef([]);
            
            // P4: é¦–æ¬¡ä½¿ç”¨å¼•å¯¼å’ŒSCIæ¨¡å¼
            const [showGuide, setShowGuide] = useState(false);
            const [isSCIMode, setIsSCIMode] = useState(false);
            const [hasSeenGuide, setHasSeenGuide] = useState(() => {
                try {
                    return localStorage.getItem('hasSeenGuide') === 'true';
                } catch (e) {
                    return false;
                }
            });
            
            // Onboarding Flow çŠ¶æ€
            const [onboardingStep, setOnboardingStep] = useState(() => {
                // å¦‚æœå·²ç»çœ‹è¿‡å¼•å¯¼ï¼Œä¸æ˜¾ç¤º onboarding
                try {
                    if (localStorage.getItem('hasSeenGuide') === 'true') {
                        return -1; // -1 è¡¨ç¤ºå·²å®Œæˆ
                    }
                    return 0; // 0 è¡¨ç¤ºæœªå¼€å§‹ï¼Œ1-4 è¡¨ç¤ºæ­¥éª¤
                } catch (e) {
                    return 0;
                }
            });
            const [cameraPermissionGranted, setCameraPermissionGranted] = useState(false);
            
            // P0: åŒæ¨¡å¼æ£€æµ‹çŠ¶æ€
            const [viewMode, setViewMode] = useState('transitioning'); // side | front | transitioning
            const [frontAnalysis, setFrontAnalysis] = useState(null);
            const [sideAnalysis, setSideAnalysis] = useState(null);

            // Initialize MediaPipe Pose
            useEffect(() => {
                // Wait for MediaPipe to load
                const initPose = () => {
                    // Check if MediaPipe is available (may be in different namespaces)
                    let Pose, Camera;
                    if (typeof window.Pose !== 'undefined') {
                        Pose = window.Pose;
                        Camera = window.Camera;
                    } else if (typeof window.mediapipe !== 'undefined' && window.mediapipe.pose) {
                        Pose = window.mediapipe.pose.Pose;
                        Camera = window.mediapipe.camera_utils.Camera;
                    } else {
                        console.log('Waiting for MediaPipe to load...');
                        setTimeout(initPose, 100);
                        return;
                    }

                    const pose = new Pose({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1635988162/${file}`;
                        }
                    });

                    pose.setOptions({
                        modelComplexity: 1,
                        smoothLandmarks: true,
                        enableSegmentation: false,
                        smoothSegmentation: false,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });

                    pose.onResults(onResults);
                    poseRef.current = pose;

                    // Start camera with error handling - ä½¿ç”¨æ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡
                    console.log('ğŸ¥ å‡†å¤‡åˆå§‹åŒ–æ‘„åƒå¤´...');
                    console.log('videoRef.current:', videoRef.current ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    if (videoRef.current) {
                        console.log('âœ… videoRef.current å­˜åœ¨ï¼Œå¼€å§‹åˆå§‹åŒ–æ‘„åƒå¤´');
                        // ç›‘å¬videoçš„loadedmetadataäº‹ä»¶ï¼Œè·å–æ‘„åƒå¤´å®é™…åˆ†è¾¨ç‡
                        const handleVideoLoadedMetadata = () => {
                            if (videoRef.current) {
                                const actualWidth = videoRef.current.videoWidth;
                                const actualHeight = videoRef.current.videoHeight;
                                if (actualWidth > 0 && actualHeight > 0) {
                                    setCameraSize({ width: actualWidth, height: actualHeight });
                                    console.log(`âœ… æ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡: ${actualWidth}x${actualHeight}`);
                                    
                                    // æ›´æ–°Canvaså°ºå¯¸ä»¥åŒ¹é…æ‘„åƒå¤´åˆ†è¾¨ç‡
                                    if (canvasRef.current) {
                                        canvasRef.current.width = actualWidth;
                                        canvasRef.current.height = actualHeight;
                                    }
                                }
                            }
                        };
                        
                        videoRef.current.addEventListener('loadedmetadata', handleVideoLoadedMetadata);
                        
                        const camera = new Camera(videoRef.current, {
                            onFrame: async () => {
                                if (poseRef.current && videoRef.current) {
                                    await poseRef.current.send({ image: videoRef.current });
                                }
                            }
                            // ç§»é™¤widthå’Œheighté™åˆ¶ï¼Œä½¿ç”¨æ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡
                        });
                        
                        console.log('ğŸ¥ è°ƒç”¨ camera.start() è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                        camera.start().then(() => {
                            console.log('âœ… æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼');
                        }).catch((error) => {
                            console.error('âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                            console.error('é”™è¯¯ç±»å‹:', error.name);
                            console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                            const currentLang = language || 'zh';
                            if (error.name === 'NotAllowedError') {
                                alert(currentLang === 'zh' ? 'è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´è®¿é—®æƒé™' : 'Please allow camera access in browser settings');
                            } else if (error.name === 'NotFoundError') {
                                alert(currentLang === 'zh' ? 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è¿æ¥' : 'Camera device not found, please check connection');
                            } else {
                                alert(currentLang === 'zh' ? `æ‘„åƒå¤´é”™è¯¯: ${error.message}` : `Camera error: ${error.message}`);
                            }
                        });
                        
                        cameraRef.current = camera;
                    }
                };

                initPose();

                // Load history from localStorage (å·²é€šè¿‡useStateåˆå§‹åŒ–åŠ è½½)
                
                // P4: æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
                const hasSeenGuideBefore = localStorage.getItem('hasSeenGuide');
                if (!hasSeenGuideBefore) {
                    setShowGuide(true);
                } else {
                    setHasSeenGuide(true);
                }
                
                // P4: åŠ è½½SCIæ¨¡å¼è®¾ç½®
                const savedSCIMode = localStorage.getItem('isSCIMode');
                if (savedSCIMode === 'true') {
                    setIsSCIMode(true);
                    setTorsoThreshold(20); // SCIæ¨¡å¼é»˜è®¤èº¯å¹²é˜ˆå€¼ä¸º20Â°
                }

                return () => {
                    if (cameraRef.current) {
                        cameraRef.current.stop();
                    }
                    // æ¸…ç†å½•åˆ¶å®šæ—¶å™¨
                    if (recordingIntervalRef.current) {
                        clearInterval(recordingIntervalRef.current);
                    }
                };
            }, []);
            
            // P3: æ€§èƒ½è‡ªé€‚åº”ç›‘æ§ï¼ˆåœ¨poseåˆå§‹åŒ–åï¼‰
            useEffect(() => {
                if (!poseRef.current) return;
                
                const checkPerformance = setInterval(() => {
                    if (fps < 20 && performanceMode === 'high') {
                        setPerformanceMode('low');
                        poseRef.current.setOptions({ modelComplexity: 0 }); // åˆ‡æ¢åˆ°è½»é‡çº§æ¨¡å‹
                        console.log('âš ï¸ æ€§èƒ½ä¸è¶³ï¼Œå·²åˆ‡æ¢åˆ°çœç”µæ¨¡å¼');
                    } else if (fps > 28 && performanceMode === 'low') {
                        setPerformanceMode('high');
                        poseRef.current.setOptions({ modelComplexity: 1 }); // åˆ‡æ¢å›æ ‡å‡†æ¨¡å‹
                        console.log('âœ“ æ€§èƒ½æ¢å¤ï¼Œå·²åˆ‡æ¢å›æ ‡å‡†æ¨¡å¼');
                    }
                }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                
                return () => clearInterval(checkPerformance);
            }, [fps, performanceMode]);

            // Process MediaPipe results
            // ä½¿ç”¨ useRef æ¥å­˜å‚¨æœ€æ–°çš„ language å€¼ï¼Œç¡®ä¿ç»˜åˆ¶æ—¶ä½¿ç”¨æ­£ç¡®çš„è¯­è¨€
            const languageRef = useRef(language);
            useEffect(() => {
                languageRef.current = language;
            }, [language]);
            
            function onResults(results) {
                const canvas = canvasRef.current;
                const video = videoRef.current;
                if (!canvas || !video) return;
                
                // ä½¿ç”¨ ref è·å–æœ€æ–°çš„è¯­è¨€è®¾ç½®
                const currentLanguage = languageRef.current;

                // P2: è®¡ç®—FPS
                const now = performance.now();
                const deltaTime = now - lastFrameTimeRef.current;
                lastFrameTimeRef.current = now;
                const currentFps = 1000 / deltaTime;
                fpsHistoryRef.current.push(currentFps);
                if (fpsHistoryRef.current.length > 30) {
                    fpsHistoryRef.current.shift();
                }
                const avgFps = fpsHistoryRef.current.reduce((a, b) => a + b, 0) / fpsHistoryRef.current.length;
                setFps(Math.round(avgFps));

                const ctx = canvas.getContext('2d');
                
                // ä½¿ç”¨æ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡ï¼Œé¿å…å‹ç¼©å½±å“ç®—æ³•ç²¾åº¦
                const videoWidth = video.videoWidth || 640;
                const videoHeight = video.videoHeight || 480;
                
                // è®¾ç½®Canvaså®é™…å°ºå¯¸ä¸ºæ‘„åƒå¤´åŸå§‹åˆ†è¾¨ç‡ï¼ˆé‡è¦ï¼ï¼‰
                if (canvas.width !== videoWidth || canvas.height !== videoHeight) {
                    canvas.width = videoWidth;
                    canvas.height = videoHeight;
                }
                
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;

                // Clear canvas
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);

                // Draw video frame (mirror flip)
                ctx.save();
                ctx.scale(-1, 1);
                ctx.drawImage(video, -canvasWidth, 0, canvasWidth, canvasHeight);
                ctx.restore();

                // P1: æ£€æŸ¥æ˜¯å¦æ£€æµ‹åˆ°äººä½“
                // P2: è‡ªåŠ¨æš‚åœé€»è¾‘
                if (!results.poseLandmarks) {
                    noDetectionCountRef.current++;
                    
                    // 3ç§’æ— æ£€æµ‹ï¼ˆ90å¸§ @ 30fpsï¼‰è‡ªåŠ¨æš‚åœ
                    if (noDetectionCountRef.current > 90 && !isPaused) {
                        setIsPaused(true);
                        // æ˜¾ç¤ºé€šçŸ¥ï¼ˆå¯ä»¥é€šè¿‡çŠ¶æ€æ˜¾ç¤ºï¼‰
                    }
                    
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    ctx.fillStyle = COLORS.yellow;
                    ctx.font = '20px Arial';
                    const pauseText = isPaused ? `â¸ï¸ ${i18n[currentLanguage].autoPausedNoDetection}` : i18n[currentLanguage].noDetectionAdjust;
                    ctx.fillText(pauseText, canvasWidth / 2 - 200, canvasHeight / 2);
                    return;
                }
                
                // æ£€æµ‹åˆ°äººä½“åè‡ªåŠ¨æ¢å¤
                if (isPaused && noDetectionCountRef.current > 90) {
                    setIsPaused(false);
                }
                noDetectionCountRef.current = 0;
                
                // P2: å¦‚æœæš‚åœï¼Œä¸å¤„ç†æ£€æµ‹
                if (isPaused) {
                    ctx.fillStyle = COLORS.yellow;
                    ctx.font = '20px Arial';
                    ctx.fillText(`â¸ï¸ ${i18n[currentLanguage].monitoringPaused}`, canvasWidth / 2 - 100, canvasHeight / 2);
                    return;
                }
                
                if (results.poseLandmarks) {
                    const landmarks = results.poseLandmarks;

                    // æ­¥éª¤1: è¯†åˆ«è§†è§’
                    const viewModeResult = detectViewAngle(landmarks, canvasWidth);
                    setViewMode(viewModeResult.mode);
                    
                    // æ­¥éª¤2: æ ¹æ®è§†è§’é€‰æ‹©ç®—æ³•
                    let analysisResult = null;
                    let aligned = false;
                    let offset = 0;
                    let alignmentStatus = { text: i18n[currentLanguage].notAligned, color: COLORS.red, icon: 'âœ—' };
                    
                    if (viewModeResult.mode === 'side') {
                        // ä¾§é¢æ¨¡å¼
                        analysisResult = analyzeSidePosture(landmarks, canvasWidth, canvasHeight);
                        setSideAnalysis(analysisResult);
                        setFrontAnalysis(null);
                        
                        // ä¾§é¢å¯¹é½æ£€æµ‹
                        const lShoulder = landmarks[POSE_LANDMARKS.LEFT_SHOULDER];
                        const rShoulder = landmarks[POSE_LANDMARKS.RIGHT_SHOULDER];
                        const lShoulderX = (1 - lShoulder.x) * canvasWidth;
                        const lShoulderY = lShoulder.y * canvasHeight;
                        const rShoulderX = (1 - rShoulder.x) * canvasWidth;
                        const rShoulderY = rShoulder.y * canvasHeight;
                        offset = findDistance(lShoulderX, lShoulderY, rShoulderX, rShoulderY);
                        
                        if (offset < ALIGNMENT_THRESHOLD_PERFECT) {
                            alignmentStatus = { text: i18n[currentLanguage].perfectAligned, color: COLORS.green, icon: 'âœ“' };
                        } else if (offset < ALIGNMENT_THRESHOLD) {
                            alignmentStatus = { text: i18n[currentLanguage].alignedSide, color: COLORS.lightGreen, icon: 'âš ï¸' };
                        } else {
                            alignmentStatus = { text: i18n[currentLanguage].notAligned, color: COLORS.red, icon: 'âœ—' };
                        }
                        aligned = offset < ALIGNMENT_THRESHOLD;
                        
                        // æ›´æ–°è§’åº¦çŠ¶æ€ï¼ˆç”¨äºå…¼å®¹ç°æœ‰UIï¼‰
                        setNeckInclination(analysisResult.neckAngle);
                        setTorsoInclination(analysisResult.torsoAngle);
                        
                        // ç»˜åˆ¶ä¾§é¢è§†å›¾
                        drawSideViewLines(ctx, landmarks, analysisResult, currentLanguage);
                        
                    } else if (viewModeResult.mode === 'front') {
                        // æ­£é¢æ¨¡å¼
                        analysisResult = analyzeFrontPosture(landmarks, canvasHeight, shoulderThreshold, headThreshold);
                        setFrontAnalysis(analysisResult);
                        setSideAnalysis(null);
                        
                        // æ­£é¢å¯¹é½æ£€æµ‹
                        const lShoulder = landmarks[POSE_LANDMARKS.LEFT_SHOULDER];
                        const rShoulder = landmarks[POSE_LANDMARKS.RIGHT_SHOULDER];
                        const lShoulderY = lShoulder.y * canvasHeight;
                        const rShoulderY = rShoulder.y * canvasHeight;
                        const heightDiff = Math.abs(lShoulderY - rShoulderY);
                        offset = heightDiff;
                        
                        if (heightDiff < 20) {
                            alignmentStatus = { text: i18n[currentLanguage].perfectAligned, color: COLORS.green, icon: 'âœ“' };
                        } else if (heightDiff < 30) {
                            alignmentStatus = { text: i18n[currentLanguage].alignedFront, color: COLORS.lightGreen, icon: 'âš ï¸' };
                        } else {
                            alignmentStatus = { text: i18n[currentLanguage].notAligned, color: COLORS.red, icon: 'âœ—' };
                        }
                        aligned = heightDiff < 30;
                        
                        // æ›´æ–°è§’åº¦çŠ¶æ€ï¼ˆæ­£é¢æ¨¡å¼ä¸æ˜¾ç¤ºè§’åº¦ï¼Œä½†ä¿æŒçŠ¶æ€å…¼å®¹ï¼‰
                        setNeckInclination(0);
                        setTorsoInclination(0);
                        
                        // ç»˜åˆ¶æ­£é¢è§†å›¾
                        drawFrontViewLines(ctx, landmarks, analysisResult, currentLanguage);
                        
                    } else {
                        // è¿‡æ¸¡çŠ¶æ€ï¼Œç­‰å¾…ç¨³å®š
                        ctx.fillStyle = COLORS.yellow;
                        ctx.font = '20px Arial';
                        const detectingText = `â³ ${i18n[currentLanguage].detectingViewAngle}`;
                        ctx.fillText(detectingText, canvasWidth / 2 - 150, canvasHeight / 2);
                        return;
                    }
                    
                    setIsAligned(aligned);
                    
                    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
                    const lShoulderLandmark = landmarks[POSE_LANDMARKS.LEFT_SHOULDER];
                    const rShoulderLandmark = landmarks[POSE_LANDMARKS.RIGHT_SHOULDER];
                    const lEarLandmark = landmarks[POSE_LANDMARKS.LEFT_EAR];
                    const lHipLandmark = landmarks[POSE_LANDMARKS.LEFT_HIP];
                    
                    setDebugInfo({
                        fps: Math.round(avgFps),
                        viewAngle: viewModeResult.mode,
                        depthDiff: viewModeResult.shoulderDistance,
                        landmarkVisibility: {
                            lShoulder: isLandmarkValid(lShoulderLandmark) ? lShoulderLandmark.visibility.toFixed(2) : 'N/A',
                            rShoulder: isLandmarkValid(rShoulderLandmark) ? rShoulderLandmark.visibility.toFixed(2) : 'N/A',
                            lEar: isLandmarkValid(lEarLandmark) ? lEarLandmark.visibility.toFixed(2) : 'N/A',
                            lHip: isLandmarkValid(lHipLandmark) ? lHipLandmark.visibility.toFixed(2) : 'N/A'
                        },
                        rawCoordinates: {},
                        showDebug: debugInfo.showDebug
                    });

                    // ========== Phase 1+2 ä¼˜åŒ–ï¼šä½¿ç”¨æ»åé˜ˆå€¼ç³»ç»Ÿ + è‡ªé€‚åº”é˜ˆå€¼åˆ¤å®šå§¿åŠ¿çŠ¶æ€ ==========
                    // è·å–æœ‰æ•ˆé˜ˆå€¼ï¼ˆä¼˜å…ˆä½¿ç”¨SCIé˜ˆå€¼ç³»ç»Ÿï¼Œç„¶åè€ƒè™‘è‡ªé€‚åº”é˜ˆå€¼å’Œæ‰‹åŠ¨è®¾ç½®ï¼‰
                    let sciThresholds;
                    if (typeof window.getCurrentThresholds === 'function') {
                        sciThresholds = window.getCurrentThresholds();
                    } else if (typeof SCI_THRESHOLDS !== 'undefined' && SCI_THRESHOLDS[currentThresholdMode]) {
                        sciThresholds = SCI_THRESHOLDS[currentThresholdMode];
                    } else {
                        sciThresholds = { neck: 40, torso: 15, shoulder: 30, hip: 25, head: 25 };
                    }
                    let effectiveNeckThreshold = sciThresholds.neck;
                    let effectiveTorsoThreshold = sciThresholds.torso;
                    
                    // å¦‚æœç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº†é˜ˆå€¼ï¼Œä½¿ç”¨æ‰‹åŠ¨è®¾ç½®ï¼ˆä½†ä¿ç•™SCIè¯„åˆ†é˜ˆå€¼ï¼‰
                    if (neckThreshold !== sciThresholds.neck || torsoThreshold !== sciThresholds.torso) {
                        effectiveNeckThreshold = neckThreshold;
                        effectiveTorsoThreshold = torsoThreshold;
                    }
                    
                    // Phase 2: å¦‚æœå¯ç”¨è‡ªé€‚åº”é˜ˆå€¼ï¼Œä½¿ç”¨è‡ªé€‚åº”é˜ˆå€¼
                    if (useAdaptiveThreshold) {
                        const adaptiveThresholds = adaptiveThresholdRef.current.getThresholds();
                        effectiveNeckThreshold = adaptiveThresholds.neck;
                        effectiveTorsoThreshold = adaptiveThresholds.torso;
                    }
                    
                    let goodPosture = false;
                    
                    if (viewModeResult.mode === 'side') {
                        // ä¾§é¢æ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨åŠ æƒè¯„åˆ†ç³»ç»Ÿï¼ˆå¦‚æœanalysisResultæœ‰scoreï¼‰
                        if (analysisResult.score !== undefined) {
                            // ä½¿ç”¨åŠ æƒè¯„åˆ†ç»“æœ
                            goodPosture = analysisResult.isGoodPosture && aligned;
                        } else {
                            // å›é€€åˆ°æ»åé˜ˆå€¼ç³»ç»Ÿï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
                            const currentSmoothedNeck = smoothedNeck || analysisResult.neckAngle;
                            const currentSmoothedTorso = smoothedTorso || analysisResult.torsoAngle;
                            
                            // æ›´æ–°æ»åé˜ˆå€¼è¯„ä¼°å™¨çš„é˜ˆå€¼
                            hysteresisRef.current.updateThresholds(effectiveNeckThreshold, effectiveTorsoThreshold);
                            
                            // ä½¿ç”¨æ»åé˜ˆå€¼ç³»ç»Ÿè¯„ä¼°ï¼ˆé˜²æ­¢åœ¨é˜ˆå€¼è¾¹ç•Œé¢‘ç¹åˆ‡æ¢ï¼‰
                            goodPosture = hysteresisRef.current.evaluate(currentSmoothedNeck, currentSmoothedTorso) && aligned;
                        }
                    } else if (viewModeResult.mode === 'front') {
                        // æ­£é¢æ¨¡å¼ï¼šä½¿ç”¨åŠ æƒè¯„åˆ†ç»“æœ
                        goodPosture = analysisResult.isGoodPosture && aligned;
                    }
                    
                    setIsGoodPosture(goodPosture);

                    // Update frame counters
                    if (goodPosture) {
                        goodFramesRef.current = goodFramesRef.current + 1;
                        badFramesRef.current = 0;
                        warningShownRef.current = false;
                        lastAlertTimeRef.current = 0;
                    } else {
                        goodFramesRef.current = 0;
                        badFramesRef.current = badFramesRef.current + 1;
                        // Check warning with configurable interval
                        const badTime = (badFramesRef.current / FPS);
                        const now = Date.now();
                        const timeSinceLastAlert = now - lastAlertTimeRef.current;
                        const alertIntervalMs = alertInterval * 1000;
                        
                        if (badTime > alertInterval && timeSinceLastAlert >= alertIntervalMs) {
                            sendEnhancedWarning(badTime);
                            warningShownRef.current = true;
                            lastAlertTimeRef.current = now;
                        } else if (badTime <= alertInterval) {
                            warningShownRef.current = false;
                        }
                    }
                    setGoodFrames(goodFramesRef.current);
                    setBadFrames(badFramesRef.current);

                    // Draw text overlays
                    const textColor = goodPosture ? COLORS.lightGreen : COLORS.red;
                    ctx.font = '18px Arial';
                    ctx.fillStyle = textColor;
                    
                    // æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯
                    ctx.fillStyle = COLORS.yellow;
                    const modeText = viewModeResult.mode === 'side' ? i18n[currentLanguage].canvasModeSide : 
                                   viewModeResult.mode === 'front' ? i18n[currentLanguage].canvasModeFront : 
                                   i18n[currentLanguage].canvasModeDetecting;
                    ctx.fillText(modeText, 10, 30);
                    
                    // æ˜¾ç¤ºå¯¹é½çŠ¶æ€
                    ctx.fillStyle = alignmentStatus.color;
                    ctx.fillText(
                        `${Math.round(offset)} ${alignmentStatus.icon} ${alignmentStatus.text}`,
                        canvasWidth - 280, 30
                    );
                    
                    // ä¾§é¢æ¨¡å¼æ˜¾ç¤ºè§’åº¦
                    if (viewModeResult.mode === 'side' && analysisResult) {
                        ctx.fillStyle = textColor;
                        const angleText = `${i18n[currentLanguage].canvasNeckAngle}: ${Math.round(analysisResult.neckAngle)}Â°  ${i18n[currentLanguage].canvasTorsoAngle}: ${Math.round(analysisResult.torsoAngle)}Â°`;
                        ctx.fillText(angleText, 10, 60);
                    }
                    
                    // æ­£é¢æ¨¡å¼æ˜¾ç¤ºå€¾æ–œå€¼
                    if (viewModeResult.mode === 'front' && analysisResult) {
                        ctx.fillStyle = textColor;
                        const tiltText = `${i18n[currentLanguage].canvasShoulderTilt}: ${Math.round(analysisResult.shoulderTilt)}px  ${i18n[currentLanguage].canvasHeadTilt}: ${Math.round(analysisResult.headTilt)}px`;
                        ctx.fillText(tiltText, 10, 60);
                    }

                    // Time display
                    const currentGoodTime = (goodFramesRef.current / FPS);
                    const currentBadTime = (badFramesRef.current / FPS);
                    ctx.fillStyle = currentGoodTime > 0 ? COLORS.green : COLORS.red;
                    const timeText = currentGoodTime > 0 
                        ? `${i18n[currentLanguage].canvasGoodTime}: ${currentGoodTime.toFixed(1)}${i18n[currentLanguage].secondsShort}`
                        : `${i18n[currentLanguage].canvasBadTime}: ${currentBadTime.toFixed(1)}${i18n[currentLanguage].secondsShort}`;
                    ctx.fillText(timeText, 10, canvasHeight - 20);
                    
                    // ========== ä¿®å¤ä»»åŠ¡4: æ˜¾ç¤ºè­¦æŠ¥å€’è®¡æ—¶ ==========
                    if (!goodPosture && badPostureTimer > 0) {
                        const seconds = Math.floor(badPostureTimer / 1000);
                        const remaining = alertInterval - seconds;
                        
                        if (remaining > 0 && remaining <= 5) {
                            ctx.save();
                            ctx.fillStyle = 'rgba(255, 0, 0, 0.9)';
                            ctx.font = 'bold 48px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(remaining.toString(), canvasWidth / 2, canvasHeight / 2);
                            
                            ctx.font = 'bold 20px Arial';
                            const alertText = i18n[currentLanguage].secondsUntilAlert;
                            ctx.fillText(alertText, canvasWidth / 2, canvasHeight / 2 + 40);
                            ctx.restore();
                        }
                    }

                    // Record data if recording
                    if (recordingState.status === 'recording') {
                        const timestamp = new Date().toISOString();
                        setRecordingData(prev => {
                            const newData = [...prev, {
                                timestamp,
                                viewMode: viewModeResult.mode,
                                neckAngle: viewModeResult.mode === 'side' ? analysisResult.neckAngle : 0,
                                torsoAngle: viewModeResult.mode === 'side' ? analysisResult.torsoAngle : 0,
                                shoulderTilt: viewModeResult.mode === 'front' ? analysisResult.shoulderTilt : 0,
                                headTilt: viewModeResult.mode === 'front' ? analysisResult.headTilt : 0,
                                isGoodPosture: goodPosture,
                                offset
                            }];
                            // Keep only last 5 minutes (5 * 60 * FPS frames)
                            return newData.slice(-(5 * 60 * FPS));
                        });
                        
                        // ========== ä¿®å¤ä»»åŠ¡1: å®æ—¶é‡‡é›†æ•°æ®åˆ°currentSession ==========
                        // æ³¨æ„ï¼šè¿™é‡Œæ¯å¸§éƒ½ä¼šæ›´æ–°ï¼Œä½†å®é™…å¿«ç…§æ˜¯åœ¨setIntervalä¸­æ¯ç§’æ”¶é›†ä¸€æ¬¡
                        // è¿™é‡Œåªæ˜¯ç¡®ä¿æ•°æ®å¯ç”¨ï¼ŒçœŸæ­£çš„å¿«ç…§æ”¶é›†åœ¨startRecordingçš„setIntervalä¸­
                    }
                    
                    // ========== ä¿®å¤ä»»åŠ¡1: æ›´æ–°å®æ—¶æ•°æ®ref ==========
                    currentPostureDataRef.current = {
                        viewMode: viewModeResult.mode,
                        isGoodPosture: goodPosture,
                        neckAngle: viewModeResult.mode === 'side' ? (analysisResult ? analysisResult.neckAngle : 0) : 0,
                        torsoAngle: viewModeResult.mode === 'side' ? (analysisResult ? analysisResult.torsoAngle : 0) : 0,
                        shoulderTilt: viewModeResult.mode === 'front' ? (analysisResult ? analysisResult.shoulderTilt : 0) : 0,
                        headTilt: viewModeResult.mode === 'front' ? (analysisResult ? analysisResult.headTilt : 0) : 0
                    };
                    
                    // ========== ä¿®å¤ä»»åŠ¡4: æ£€æŸ¥å§¿åŠ¿è­¦æŠ¥ ==========
                    checkPostureAlert(goodPosture);
                    
                    // Debug: æ£€æŸ¥å½•åˆ¶æ•°æ®
                    if (recordingState.status === 'recording' || recordingState.status === 'processing') {
                        console.log('Recording status:', recordingState.status, 'Data frames:', recordingData.length);
                    }
                }
            }

            // Send warning (å®Œå…¨å¤åˆ» Python)
            // P1: å¢åŠ è­¦æŠ¥è®¡æ•°
            function sendWarning(badTime) {
                alertCountRef.current++;
                alert(`è­¦å‘Šï¼šæ‚¨å·²ä¿æŒä¸è‰¯å§¿åŠ¿è¶…è¿‡ ${Math.round(badTime)} ç§’ï¼è¯·è°ƒæ•´æ‚¨çš„åå§¿ã€‚`);
            }
            
            // å¢å¼ºç‰ˆè­¦å‘Šç³»ç»Ÿï¼ˆæ”¯æŒæ¡Œé¢é€šçŸ¥å’ŒéŸ³æ•ˆï¼‰
            function sendEnhancedWarning(badTime) {
                alertCountRef.current++;
                const message = language === 'zh' 
                    ? `è­¦å‘Šï¼šæ‚¨å·²ä¿æŒä¸è‰¯å§¿åŠ¿è¶…è¿‡ ${Math.round(badTime)} ç§’ï¼è¯·è°ƒæ•´æ‚¨çš„åå§¿ã€‚`
                    : `Warning: You have maintained bad posture for over ${Math.round(badTime)} seconds! Please adjust your posture.`;
                
                // æ¡Œé¢é€šçŸ¥ï¼ˆä½¿ç”¨æ­£ç¡®çš„å˜é‡åï¼‰
                if (alertNotificationEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification(language === 'zh' ? 'å§¿åŠ¿æé†’' : 'Posture Alert', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
                        tag: 'posture-warning',
                        requireInteraction: false
                    });
                }
                
                // éŸ³æ•ˆæé†’ï¼ˆä½¿ç”¨Web Audio APIç”Ÿæˆæç¤ºéŸ³ï¼Œä½¿ç”¨æ­£ç¡®çš„å˜é‡åï¼‰
                if (alertSoundEnabled) {
                    playAlertSound(); // ä½¿ç”¨ç»Ÿä¸€çš„éŸ³æ•ˆæ’­æ”¾å‡½æ•°
                }
                
                // å¦‚æœé€šçŸ¥å’ŒéŸ³æ•ˆéƒ½ç¦ç”¨ï¼Œåˆ™ä½¿ç”¨ä¼ ç»Ÿalert
                if (!alertNotificationEnabled && !alertSoundEnabled) {
                    alert(message);
                }
            }

            // P1: æ”¹è¿›çš„å†å²è®°å½•ä¿å­˜ï¼ˆå®šæœŸä¿å­˜ï¼Œé¿å…è¿‡åº¦å†™å…¥ï¼‰
            // æ·»åŠ è§’åº¦ç»Ÿè®¡å’Œè­¦æŠ¥è®¡æ•°
            const historySaveIntervalRef = useRef(null);
            const angleHistoryRef = useRef([]); // å­˜å‚¨è§’åº¦å†å²ç”¨äºè®¡ç®—å¹³å‡å€¼å’Œè¶‹åŠ¿åˆ†æ
            const alertCountRef = useRef(0); // è­¦æŠ¥è®¡æ•°
            
            useEffect(() => {
                // æ¯5ç§’ä¿å­˜ä¸€æ¬¡å†å²è®°å½•
                historySaveIntervalRef.current = setInterval(() => {
                    if (goodFrames > 0 || badFrames > 0) {
                        const today = new Date().toISOString().split('T')[0];
                        const goodTime = (goodFrames / FPS);
                        const badTime = (badFrames / FPS);
                        
                        // è®¡ç®—å¹³å‡è§’åº¦
                        const recentAngles = angleHistoryRef.current.slice(-300); // æœ€è¿‘10ç§’çš„æ•°æ®
                        const avgNeck = recentAngles.length > 0 
                            ? recentAngles.reduce((sum, a) => sum + (a.neck || 0), 0) / recentAngles.length 
                            : smoothedNeck || neckInclination;
                        const avgTorso = recentAngles.length > 0 
                            ? recentAngles.reduce((sum, a) => sum + (a.torso || 0), 0) / recentAngles.length 
                            : smoothedTorso || torsoInclination;
                        
                        setHistory(prev => {
                            const updated = [...prev];
                            const todayIndex = updated.findIndex(h => h.date === today);
                            
                            if (todayIndex >= 0) {
                                // æ›´æ–°ä»Šæ—¥æ•°æ®ï¼ˆä½¿ç”¨å½“å‰ç´¯è®¡å€¼ï¼‰
                                updated[todayIndex] = {
                                    ...updated[todayIndex],
                                    goodTime: Math.max(updated[todayIndex].goodTime, goodTime),
                                    badTime: Math.max(updated[todayIndex].badTime, badTime),
                                    avgNeck: avgNeck,
                                    avgTorso: avgTorso,
                                    alertCount: alertCountRef.current,
                                    lastUpdate: new Date().toISOString()
                                };
                            } else {
                                updated.push({
                                    date: today,
                                    goodTime,
                                    badTime,
                                    avgNeck: avgNeck,
                                    avgTorso: avgTorso,
                                    alertCount: alertCountRef.current,
                                    lastUpdate: new Date().toISOString()
                                });
                            }
                            
                            // åªä¿ç•™æœ€è¿‘30å¤©çš„è®°å½•
                            const filtered = updated.filter(h => {
                                const recordDate = new Date(h.date);
                                const daysDiff = (new Date() - recordDate) / (1000 * 60 * 60 * 24);
                                return daysDiff <= 30;
                            });
                            
                            localStorage.setItem('postureHistory', JSON.stringify(filtered));
                            return filtered;
                        });
                    }
                }, 5000); // æ¯5ç§’ä¿å­˜ä¸€æ¬¡
                
                return () => {
                    if (historySaveIntervalRef.current) {
                        clearInterval(historySaveIntervalRef.current);
                    }
                };
            }, [goodFrames, badFrames, neckInclination, torsoInclination]);
            
            // è®°å½•è§’åº¦å†å²ï¼ˆç”¨äºè¶‹åŠ¿åˆ†æå’Œå¹³å‡å€¼è®¡ç®—ï¼‰
            useEffect(() => {
                if (!isPaused && smoothedNeck > 0 && smoothedTorso > 0) {
                    angleHistoryRef.current.push({
                        neck: smoothedNeck,
                        torso: smoothedTorso,
                        timestamp: Date.now(),
                        isGoodPosture: smoothedNeck < neckThreshold && smoothedTorso < torsoThreshold
                    });
                    // åªä¿ç•™æœ€è¿‘5åˆ†é’Ÿçš„æ•°æ®ï¼ˆç”¨äºè¶‹åŠ¿åˆ†æï¼‰
                    const maxEntries = 5 * 60 * 2; // 5åˆ†é’Ÿ * 60ç§’ * æ¯2ç§’ä¸€æ¬¡
                    if (angleHistoryRef.current.length > maxEntries) {
                        angleHistoryRef.current.shift();
                    }
                }
            }, [smoothedNeck, smoothedTorso, isPaused, neckThreshold, torsoThreshold]);

            // æ›´æ–°åº·å¤é‡Œç¨‹ç¢‘ï¼ˆå½“å†å²è®°å½•å˜åŒ–æ—¶ï¼‰
            useEffect(() => {
                if (history.length > 0 && window.rehabilitationDashboard) {
                    window.rehabilitationDashboard.updateMilestones(history);
                }
            }, [history.length]);
            
            // è®¡ç®—è§’åº¦è¶‹åŠ¿
            const calculateAngleTrend = () => {
                if (angleHistoryRef.current.length < 10) {
                    return { neckTrend: 'stable', torsoTrend: 'stable', neckChange: 0, torsoChange: 0 };
                }
                
                const recent = angleHistoryRef.current.slice(-10);
                const older = angleHistoryRef.current.slice(-20, -10);
                
                if (older.length === 0) {
                    return { neckTrend: 'stable', torsoTrend: 'stable', neckChange: 0, torsoChange: 0 };
                }
                
                const avgRecentNeck = recent.reduce((sum, e) => sum + e.neck, 0) / recent.length;
                const avgOlderNeck = older.reduce((sum, e) => sum + e.neck, 0) / older.length;
                const avgRecentTorso = recent.reduce((sum, e) => sum + e.torso, 0) / recent.length;
                const avgOlderTorso = older.reduce((sum, e) => sum + e.torso, 0) / older.length;
                
                const neckChange = avgRecentNeck - avgOlderNeck;
                const torsoChange = avgRecentTorso - avgOlderTorso;
                
                const neckTrend = Math.abs(neckChange) < 1 ? 'stable' : (neckChange > 0 ? 'worsening' : 'improving');
                const torsoTrend = Math.abs(torsoChange) < 1 ? 'stable' : (torsoChange > 0 ? 'worsening' : 'improving');
                
                return { neckTrend, torsoTrend, neckChange, torsoChange };
            };
            
            const [angleTrend, setAngleTrend] = useState({ neckTrend: 'stable', torsoTrend: 'stable', neckChange: 0, torsoChange: 0 });
            
            // æ›´æ–°è¶‹åŠ¿ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
            useEffect(() => {
                const trendInterval = setInterval(() => {
                    const trend = calculateAngleTrend();
                    setAngleTrend(trend);
                }, 5000);
                
                return () => clearInterval(trendInterval);
            }, [angleHistoryRef.current.length]);

            // P1: æ”¹è¿›çš„å½•åˆ¶åŠŸèƒ½ï¼ˆä»…æ•°æ®å½•åˆ¶ï¼Œå·²ç§»é™¤è§†é¢‘å½•åˆ¶ï¼‰
            function startRecording() {
                if (recordingState.status === 'recording') return;
                
                // åˆ›å»ºæ–°çš„å½•åˆ¶ä¼šè¯
                const sessionId = Date.now();
                const startTime = new Date();
                
                const newSession = {
                    id: sessionId,
                    startTime: startTime.toISOString(),
                    duration: 0,
                    goodFrames: 0,
                    badFrames: 0,
                    snapshots: [],
                    viewMode: viewMode
                };
                
                setCurrentSession(newSession);
                setRecordingState({
                    status: 'recording',
                    duration: 0,
                    startTime: Date.now()
                });
                setRecordingData([]);
                
                // æ¯ç§’è®°å½•ä¸€æ¬¡æ•°æ®å¿«ç…§
                // ========== ä¿®å¤ä»»åŠ¡1: ä½¿ç”¨refæ¥è·å–æœ€æ–°çŠ¶æ€å€¼ ==========
                recordingIntervalRef.current = setInterval(() => {
                    setCurrentSession(session => {
                        if (!session) return null;
                        
                        // ä»refä¸­è·å–æœ€æ–°çš„å®æ—¶æ•°æ®
                        const currentData = currentPostureDataRef.current;
                        
                        // å¢å¼ºæ•°æ®å¿«ç…§ï¼šæ·»åŠ å…³é”®ç‚¹åæ ‡ï¼ˆç”¨äºåç»­åˆ†æå’Œé‡ç°ï¼‰
                        const snapshot = {
                            timestamp: new Date().toISOString(),
                            viewMode: currentData.viewMode,
                            isGoodPosture: currentData.isGoodPosture,
                            neckAngle: currentData.neckAngle,
                            torsoAngle: currentData.torsoAngle,
                            shoulderTilt: currentData.shoulderTilt,
                            headTilt: currentData.headTilt,
                            // æ·»åŠ å…³é”®ç‚¹åæ ‡ï¼ˆå½’ä¸€åŒ–åæ ‡ï¼Œå¯ç”¨äºé‡ç°æ£€æµ‹ç»“æœï¼‰
                            landmarks: currentData.landmarks ? currentData.landmarks.map(l => ({
                                x: parseFloat(l.x.toFixed(4)), // ä¿ç•™4ä½å°æ•°ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
                                y: parseFloat(l.y.toFixed(4)),
                                z: parseFloat(l.z.toFixed(4)),
                                visibility: parseFloat(l.visibility.toFixed(4))
                            })) : null
                        };
                        
                        const updatedSession = {
                            ...session,
                            duration: session.duration + 1,
                            snapshots: [...session.snapshots, snapshot]
                        };
                        
                        // æ›´æ–°è®¡æ•°
                        if (currentData.isGoodPosture) {
                            updatedSession.goodFrames += 1;
                        } else {
                            updatedSession.badFrames += 1;
                        }
                        
                        return updatedSession;
                    });
                }, 1000);
                
                // å¼€å§‹è®¡æ—¶å™¨
                recordingTimerRef.current = setInterval(() => {
                    setRecordingState(prev => {
                        if (prev.status !== 'recording') {
                            clearInterval(recordingTimerRef.current);
                            return prev;
                        }
                        const elapsed = Math.floor((Date.now() - prev.startTime) / 1000);
                        
                        // æœ€é•¿5åˆ†é’Ÿ
                        if (elapsed >= 300) {
                            stopRecording();
                            return prev;
                        }
                        
                        return { ...prev, duration: elapsed };
                    });
                }, 1000);
                
                console.log('âœ… å¼€å§‹æ•°æ®å½•åˆ¶ï¼ˆå·²ç§»é™¤è§†é¢‘å½•åˆ¶åŠŸèƒ½ï¼‰');
            }
            
            function stopRecording() {
                // åœæ­¢æ•°æ®å¿«ç…§æ”¶é›†
                if (recordingIntervalRef.current) {
                    clearInterval(recordingIntervalRef.current);
                    recordingIntervalRef.current = null;
                }
                
                // åœæ­¢è®¡æ—¶å™¨
                if (recordingTimerRef.current) {
                    clearInterval(recordingTimerRef.current);
                    recordingTimerRef.current = null;
                }
                
                console.log('âœ… åœæ­¢æ•°æ®å½•åˆ¶');
                
                // ä¿å­˜ä¼šè¯åˆ°å†å²è®°å½•
                if (currentSession) {
                    const endTime = new Date();
                    const totalFrames = currentSession.goodFrames + currentSession.badFrames;
                    const goodPercentage = totalFrames > 0 
                        ? ((currentSession.goodFrames / totalFrames) * 100).toFixed(1)
                        : 0;
                    
                    // ========== ä¿®å¤ä»»åŠ¡2: ä¿®æ­£å¹³å‡è§’åº¦è®¡ç®—ï¼ˆè¿‡æ»¤0å€¼ï¼Œä¿ç•™1ä½å°æ•°ï¼‰ ==========
                    // è®¡ç®—å¹³å‡è§’åº¦ï¼ˆåªè®¡ç®—æœ‰æ•ˆå€¼ï¼Œè¿‡æ»¤æ‰0å€¼ï¼‰
                    const validNeckSnapshots = currentSession.snapshots.filter(s => s.neckAngle > 0);
                    const avgNeck = validNeckSnapshots.length > 0
                        ? validNeckSnapshots.reduce((sum, s) => sum + s.neckAngle, 0) / validNeckSnapshots.length
                        : 0;
                    const avgNeckAngle = isNaN(avgNeck) ? 0 : parseFloat(avgNeck.toFixed(1));
                    
                    const validTorsoSnapshots = currentSession.snapshots.filter(s => s.torsoAngle > 0);
                    const avgTorso = validTorsoSnapshots.length > 0
                        ? validTorsoSnapshots.reduce((sum, s) => sum + s.torsoAngle, 0) / validTorsoSnapshots.length
                        : 0;
                    const avgTorsoAngle = isNaN(avgTorso) ? 0 : parseFloat(avgTorso.toFixed(1));
                    
                    const finalRecord = {
                        ...currentSession,
                        endTime: endTime.toISOString(),
                        duration: currentSession.duration,
                        summary: {
                            totalDuration: currentSession.duration,
                            goodPercentage: parseFloat(goodPercentage),
                            badPercentage: (100 - parseFloat(goodPercentage)).toFixed(1),
                            avgNeckAngle: avgNeckAngle,
                            avgTorsoAngle: avgTorsoAngle,
                            alertCount: Math.floor(currentSession.badFrames / 5) // æ¯5å¸§ç®—1æ¬¡è­¦æŠ¥
                        }
                    };
                    
                    saveHistory(finalRecord);
                    setCurrentSession(null);
                    console.log('âœ… æ•°æ®å½•åˆ¶å·²ä¿å­˜åˆ°å†å²è®°å½•');
                }
                
                // æ›´æ–°çŠ¶æ€ä¸ºidleï¼ˆå·²ç§»é™¤è§†é¢‘å½•åˆ¶åŠŸèƒ½ï¼‰
                setRecordingState(prev => ({
                    ...prev,
                    status: 'idle'
                }));
            }
            
            // æ ¼å¼åŒ–å½•åˆ¶æ—¶é•¿ - å·²æå–åˆ° js/ui-utils.js
            const formatRecordingTime = window.formatRecordingTime || function(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            // ========== æ–°å¢ï¼šæ•°æ®å­˜å‚¨å‡½æ•° ==========
            // è¯»å–å†å²è®°å½•
            function loadHistory() {
                try {
                    const savedHistory = localStorage.getItem('postureHistory');
                    if (savedHistory) {
                        const parsed = JSON.parse(savedHistory);
                        // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆåªæœ‰dateå­—æ®µï¼‰ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼
                        const converted = parsed.map(record => {
                            if (record.id && record.snapshots) {
                                // æ–°æ ¼å¼ï¼Œç›´æ¥è¿”å›
                                return record;
                            } else {
                                // æ—§æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
                                return {
                                    id: Date.now() + Math.random(),
                                    startTime: record.date ? new Date(record.date).toISOString() : new Date().toISOString(),
                                    endTime: record.lastUpdate || new Date().toISOString(),
                                    duration: (record.goodTime || 0) + (record.badTime || 0),
                                    goodFrames: Math.floor((record.goodTime || 0) * FPS),
                                    badFrames: Math.floor((record.badTime || 0) * FPS),
                                    snapshots: [],
                                    viewMode: 'side',
                                    summary: {
                                        totalDuration: (record.goodTime || 0) + (record.badTime || 0),
                                        goodPercentage: record.goodTime && record.badTime 
                                            ? ((record.goodTime / (record.goodTime + record.badTime)) * 100).toFixed(1)
                                            : '0',
                                        badPercentage: record.goodTime && record.badTime
                                            ? ((record.badTime / (record.goodTime + record.badTime)) * 100).toFixed(1)
                                            : '0',
                                        avgNeckAngle: record.avgNeck || 0,
                                        avgTorsoAngle: record.avgTorso || 0,
                                        alertCount: record.alertCount || 0
                                    }
                                };
                            }
                        });
                        setHistory(converted);
                        console.log('âœ… æˆåŠŸåŠ è½½', converted.length, 'æ¡å†å²è®°å½•');
                    }
                } catch (error) {
                    console.error('âŒ è¯»å–å†å²è®°å½•å¤±è´¥:', error);
                }
            }
            
            // æ•°æ®å‹ç¼©å·¥å…·å‡½æ•°ï¼ˆç®€å•çš„JSONå‹ç¼©ï¼‰
            function compressData(data) {
                try {
                    const jsonString = JSON.stringify(data);
                    // ç®€å•çš„å‹ç¼©ï¼šç§»é™¤ä¸å¿…è¦çš„ç©ºæ ¼å’Œæ¢è¡Œï¼ˆå¯¹äºå·²æ ¼å¼åŒ–çš„JSONï¼‰
                    const compressed = jsonString.replace(/\s+/g, ' ').trim();
                    return compressed;
                } catch (error) {
                    console.error('å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®:', error);
                    return JSON.stringify(data);
                }
            }
            
            // ============================================================================
            // æ•°æ®å¤„ç†å‡½æ•° - å·²æå–åˆ° js/data-handler.js
            // ============================================================================
            // è¿™äº›å‡½æ•°ç°åœ¨è°ƒç”¨å¤–éƒ¨æ¨¡å—ä¸­çš„å‡½æ•°
            function checkStorageSpace() {
                return window.checkStorageSpace ? window.checkStorageSpace() : { usage: 0, limit: 0, percentage: 0, warning: false };
                }
            
            function saveHistory(newRecord) {
                if (window.saveHistory) {
                    window.saveHistory(newRecord, history, setHistory, language, formatDuration);
                }
            }
            
            function formatDuration(seconds) {
                return window.formatDuration ? window.formatDuration(seconds, language) : `${seconds}s`;
            }
            
            // ============================================================================
            // æ•°æ®å¯¼å‡ºå’ŒæŠ¥å‘Šç”Ÿæˆå‡½æ•° - å·²æå–åˆ° js/data-export.js
            // ============================================================================
            // è¿™äº›å‡½æ•°ç°åœ¨è°ƒç”¨å¤–éƒ¨æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œä¼ å…¥å¿…è¦çš„å‚æ•°
            function exportRecording() {
                window.exportRecording({ currentSession, recordingData, language });
                    }
            
            function cleanDataForExport(data) {
                return window.cleanDataForExport(data);
                            }
            
            function exportAllHistoryData() {
                window.exportAllHistoryData({ history, language });
            }
            
            function exportRecordingCSV() {
                window.exportRecordingCSV({ recordingData, language });
            }
            
            function exportHistoryCSV() {
                window.exportHistoryCSV({ history, language });
            }
            
            function generatePostureReport(historyData, lang = 'zh') {
                return window.generatePostureReport(historyData, lang);
            }
            
            function formatReport(report, lang = 'zh') {
                return window.formatReport(report, lang);
                    }
            
            function exportRecordingVideo() {
                window.exportRecordingVideo({ recordingState, getSupportedMimeType });
            }

            function exportReport() {
                window.exportReport({ neckInclination, torsoInclination, isGoodPosture, isAligned, goodFrames, badFrames, history, FPS });
            }
            
            // ========== ä¿®å¤ä»»åŠ¡4: è­¦æŠ¥ç³»ç»Ÿå‡½æ•° - å·²æå–åˆ° js/alert-system.js ==========
            // ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»ºè­¦æŠ¥ç³»ç»Ÿ
            const alertSystem = window.createAlertSystem ? window.createAlertSystem({
                badPostureTimerRef,
                setBadPostureTimer,
                lastAlertTimeRef,
                setShouldAlert,
                alertSoundEnabled,
                alertNotificationEnabled,
                alertSoundRef,
                alertInterval,
                language
            }) : null;
            
            // æ£€æŸ¥å§¿åŠ¿è­¦æŠ¥ï¼ˆä¼˜åŒ–ç‰ˆï¼šä½¿ç”¨refé¿å…é¢‘ç¹çŠ¶æ€æ›´æ–°ï¼‰
            const lastDisplayUpdateRef = useRef(0);
            function checkPostureAlert(isGoodPosture) {
                if (alertSystem && alertSystem.checkPostureAlert) {
                    // ä½¿ç”¨æå–çš„è­¦æŠ¥ç³»ç»Ÿï¼Œä½†éœ€è¦ä¼ å…¥ shouldAlert çŠ¶æ€
                    alertSystem.checkPostureAlert(isGoodPosture, shouldAlert);
                } else {
                    // å›é€€åˆ°åŸå§‹å®ç°
                if (isGoodPosture) {
                    // å§¿åŠ¿è‰¯å¥½ï¼Œé‡ç½®è®¡æ—¶å™¨
                    badPostureTimerRef.current = 0;
                    setBadPostureTimer(0);
                    setShouldAlert(false);
                    lastDisplayUpdateRef.current = 0;
                } else {
                    // å§¿åŠ¿ä¸è‰¯ï¼Œç´¯è®¡æ—¶é—´ï¼ˆå‡è®¾30fpsï¼Œæ¯å¸§çº¦33msï¼‰
                    badPostureTimerRef.current += (1000 / 30); // åªæ›´æ–°refï¼Œä¸è§¦å‘æ¸²æŸ“
                    
                    const seconds = Math.floor(badPostureTimerRef.current / 1000);
                    
                    // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ˜¾ç¤ºï¼ˆå‡å°‘çŠ¶æ€æ›´æ–°é¢‘ç‡ï¼‰
                    const now = Date.now();
                    if (now - lastDisplayUpdateRef.current >= 1000) {
                        setBadPostureTimer(badPostureTimerRef.current);
                        lastDisplayUpdateRef.current = now;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘è­¦æŠ¥ï¼ˆä½¿ç”¨å†·å´æ—¶é—´ï¼‰
                    const alertCooldown = 10000; // 10ç§’å†·å´æ—¶é—´
                    
                    if (seconds >= alertInterval && 
                        now - lastAlertTimeRef.current > alertCooldown && 
                        !shouldAlert) {
                        setShouldAlert(true);
                            if (alertSystem && alertSystem.triggerAlert) {
                                alertSystem.triggerAlert();
                            } else {
                        triggerAlert();
                            }
                        lastAlertTimeRef.current = now;
                        }
                    }
                }
            }
            
            // è§¦å‘è­¦æŠ¥ï¼ˆæ·»åŠ é˜²æŠ–å’Œå†·å´æ—¶é—´æ£€æŸ¥ï¼‰- å›é€€å‡½æ•°
            function triggerAlert() {
                if (alertSystem && alertSystem.triggerAlert) {
                    alertSystem.triggerAlert();
                    return;
                }
                
                const now = Date.now();
                const alertCooldown = 10000; // 10ç§’å†·å´æ—¶é—´
                
                // æ£€æŸ¥å†·å´æ—¶é—´
                if (now - lastAlertTimeRef.current < alertCooldown) {
                    console.log('â³ è­¦æŠ¥å†·å´ä¸­...');
                    return;
                }
                
                lastAlertTimeRef.current = now;
                console.log('ğŸš¨ è§¦å‘è­¦æŠ¥ï¼');
                
                // 1. æ’­æ”¾éŸ³æ•ˆ
                if (alertSoundEnabled) {
                    if (alertSystem && alertSystem.playAlertSound) {
                        alertSystem.playAlertSound();
                    } else {
                    playAlertSound();
                    }
                }
                
                // 2. æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥ï¼ˆé™æµï¼‰
                if (alertNotificationEnabled) {
                    if (alertSystem && alertSystem.showNotification) {
                        alertSystem.showNotification();
                    } else {
                    showNotification();
                    }
                }
                
                // 3. éœ‡åŠ¨ï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒï¼‰
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
            }
            
            // æ’­æ”¾è­¦æŠ¥éŸ³æ•ˆï¼ˆæ‡’åŠ è½½AudioContextï¼‰- å›é€€å‡½æ•°
            function playAlertSound() {
                if (alertSystem && alertSystem.playAlertSound) {
                    alertSystem.playAlertSound();
                    return;
                }
                
                try {
                    // æ‡’åŠ è½½AudioContextï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æ’­æ”¾æ—¶åˆå§‹åŒ–ï¼‰
                    if (!alertSoundRef.current) {
                        alertSoundRef.current = new (window.AudioContext || window.webkitAudioContext)();
                        console.log('âœ… éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–');
                    }
                    
                    const audioContext = alertSoundRef.current;
                    
                    // æ¢å¤è¢«æš‚åœçš„ä¸Šä¸‹æ–‡ï¼ˆæµè§ˆå™¨è‡ªåŠ¨æš‚åœç­–ç•¥ï¼‰
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„"å“”"å£°
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // é¢‘ç‡800Hz
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    
                    console.log('ğŸ”Š éŸ³æ•ˆå·²æ’­æ”¾');
                } catch (error) {
                    console.error('âŒ éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
                }
            }
            
            // æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥ï¼ˆä¼˜åŒ–ç‰ˆï¼šé˜²æ­¢é‡å¤é€šçŸ¥å †ç§¯ï¼‰- å›é€€å‡½æ•°
            function showNotification() {
                if (alertSystem && alertSystem.showNotification) {
                    alertSystem.showNotification();
                    return;
                }
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒé€šçŸ¥
                if (!('Notification' in window)) {
                    console.warn('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥');
                    return;
                }
                
                // æ£€æŸ¥æƒé™çŠ¶æ€
                if (Notification.permission !== 'granted') {
                    console.warn('âš ï¸ é€šçŸ¥æƒé™æœªæˆäºˆ');
                    return;
                }
                
                try {
                    // ä½¿ç”¨tagé˜²æ­¢é‡å¤é€šçŸ¥å †ç§¯
                    const notification = new Notification(language === 'zh' ? 'âš ï¸ å§¿åŠ¿æé†’' : 'âš ï¸ Posture Alert', {
                        body: language === 'zh' ? 'æ£€æµ‹åˆ°ä¸è‰¯å§¿åŠ¿å·²æŒç»­5ç§’ï¼Œè¯·è°ƒæ•´åå§¿' : 'Bad posture detected for 5 seconds, please adjust your sitting posture',
                        tag: 'posture-alert', // å…³é”®ï¼šç›¸åŒtagä¼šæ›¿æ¢æ—§é€šçŸ¥
                        requireInteraction: false,
                        silent: true, // é™éŸ³ï¼ˆå› ä¸ºæœ‰éŸ³æ•ˆäº†ï¼‰
                        renotify: false
                    });
                    
                    // 3ç§’åè‡ªåŠ¨å…³é—­
                    setTimeout(() => {
                        notification.close();
                    }, 3000);
                    
                    console.log('ğŸ”” é€šçŸ¥å·²æ˜¾ç¤º');
                } catch (error) {
                    console.error('âŒ é€šçŸ¥æ˜¾ç¤ºå¤±è´¥:', error);
                }
            }
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            function requestNotificationPermission() {
                if (alertSystem && alertSystem.requestNotificationPermission) {
                    alertSystem.requestNotificationPermission();
                    return;
                }
                
                if (!('Notification' in window)) {
                    alert(language === 'zh' ? 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ¡Œé¢é€šçŸ¥' : 'Your browser does not support desktop notifications');
                    return;
                }
                
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        alert(language === 'zh' ? 'âœ… é€šçŸ¥æƒé™å·²å¼€å¯' : 'âœ… Notification permission granted');
                        // å‘é€æµ‹è¯•é€šçŸ¥
                        new Notification(language === 'zh' ? 'âœ“ æµ‹è¯•é€šçŸ¥' : 'âœ“ Test Notification', {
                            body: language === 'zh' ? 'æ‚¨å°†åœ¨æ£€æµ‹åˆ°ä¸è‰¯å§¿åŠ¿æ—¶æ”¶åˆ°æé†’' : 'You will receive alerts when bad posture is detected'
                        });
                    } else {
                        alert(language === 'zh' ? 'âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯' : 'âŒ Notification permission denied\n\nPlease enable it manually in browser settings');
                    }
                }).catch(error => {
                    console.error('æƒé™è¯·æ±‚å¤±è´¥:', error);
                });
            }
            
            // ========== ä¿®å¤ä»»åŠ¡3: åŒºåˆ†å½“å‰æŠ¥å‘Šå’Œå†å²æŠ¥å‘Š ==========
            // å¯¼å‡ºå½“å‰å®æ—¶æŠ¥å‘Šï¼ˆå¦‚æœæ­£åœ¨å½•åˆ¶ï¼‰
            function exportCurrentReport() {
                if (recordingState.status !== 'recording' || !currentSession) {
                    alert(language === 'zh' ? 'âš ï¸ è¯·å…ˆå¼€å§‹å½•åˆ¶' : 'âš ï¸ Please start recording first');
                    return;
                }
                
                // ç”Ÿæˆå®æ—¶æŠ¥å‘Š
                const currentDuration = recordingState.duration;
                const totalFrames = currentSession.goodFrames + currentSession.badFrames;
                const currentGoodPercent = totalFrames > 0
                    ? ((currentSession.goodFrames / totalFrames) * 100).toFixed(1)
                    : 0;
                
                const reportText = `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      å®æ—¶å§¿åŠ¿ç›‘æµ‹æŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â±ï¸  å½“å‰å½•åˆ¶æ—¶é•¿: ${Math.floor(currentDuration / 60)}åˆ†${currentDuration % 60}ç§’
âœ“ è‰¯å¥½å§¿åŠ¿å¸§æ•°: ${currentSession.goodFrames}
âœ— ä¸è‰¯å§¿åŠ¿å¸§æ•°: ${currentSession.badFrames}
ğŸ“Š è‰¯å¥½å§¿åŠ¿å æ¯”: ${currentGoodPercent}%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’¡ è¿™æ˜¯å®æ—¶å¿«ç…§ï¼Œç»§ç»­å½•åˆ¶ä»¥è·å–æ›´å¤šæ•°æ®

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
    `.trim();
                
                const blob = new Blob(['\ufeff' + reportText], { 
                    type: 'text/plain;charset=utf-8' 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å®æ—¶æŠ¥å‘Š_${new Date().toLocaleTimeString('zh-CN').replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // ========== æ•°æ®å¤„ç†å‡½æ•° - å·²æå–åˆ° js/data-handler.js ==========
            function exportRecordReport(record) {
                if (window.exportRecordReport) {
                    window.exportRecordReport(record, language, formatDuration);
                }
            }
            
            function exportRecordCSV(record) {
                if (window.exportRecordCSV) {
                    window.exportRecordCSV(record, language);
                }
            }
            
            function deleteRecord(id) {
                if (window.deleteRecord) {
                    window.deleteRecord(id, history, setHistory, language);
                }
            }
            
            // å¯¼å‡ºè¶‹åŠ¿æŠ¥å‘Šï¼ˆå·²åˆå¹¶åˆ°ç”Ÿæˆåˆ†ææŠ¥å‘Šä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹ï¼‰
            function exportTrendReport() {
                // ç›´æ¥è°ƒç”¨ç”Ÿæˆåˆ†ææŠ¥å‘ŠåŠŸèƒ½
                const report = generatePostureReport(history, language);
                const reportText = formatReport(report, language);
                const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `posture_report_${new Date().toISOString().split('T')[0]}.txt`;
                link.click();
                URL.revokeObjectURL(url);
                alert(language === 'zh' ? 'âœ… è¶‹åŠ¿æŠ¥å‘Šå·²å¯¼å‡º' : 'âœ… Trend report exported');
            }

            // çŠ¶æ€ï¼šè®¾ç½®æŠ½å±‰
            const [settingsOpen, setSettingsOpen] = useState(false);
            
            // çŠ¶æ€ï¼šæ˜¾ç¤ºè¾…åŠ©çº¿
            const [showGuides, setShowGuides] = useState(false);
            
            // è®¡ç®—ç›‘æµ‹æ—¶é•¿
            const [monitoringDuration, setMonitoringDuration] = useState(0);
            useEffect(() => {
                if (isMonitoring) {
                    const interval = setInterval(() => {
                        setMonitoringDuration(prev => prev + 1);
                    }, 1000);
                    return () => clearInterval(interval);
                } else {
                    setMonitoringDuration(0);
                }
            }, [isMonitoring]);
            
            // æ ¼å¼åŒ–æ—¶é•¿ - å·²æå–åˆ° js/ui-utils.js
            const formatMonitoringDuration = window.formatMonitoringDuration || function(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            
            // é”®ç›˜å¿«æ·é”®
            useEffect(() => {
                function handleKeyPress(e) {
                    // å¿½ç•¥åœ¨è¾“å…¥æ¡†ä¸­çš„å¿«æ·é”®
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                        return;
                    }
                    
                    // Alt + å¿«æ·é”®
                    if (e.altKey) {
                        switch(e.key.toLowerCase()) {
                            case 's':
                                e.preventDefault();
                                setSettingsOpen(true);
                                break;
                            case 'g':
                                e.preventDefault();
                                setShowGuide(true);
                                break;
                            case 'm':
                                e.preventDefault();
                                setIsMonitoring(!isMonitoring);
                                break;
                            case 'r':
                                e.preventDefault();
                                if (recordingState.status === 'recording') {
                                    stopRecording();
                                } else {
                                    startRecording();
                                }
                                break;
                        }
                        return;
                    }
                    
                    // å•é”®å¿«æ·é”®
                    switch(e.key) {
                        case ' ': // Space - æš‚åœ/ç»§ç»­ç›‘æµ‹
                            e.preventDefault();
                            setIsMonitoring(!isMonitoring);
                            break;
                        case 'f':
                        case 'F': // F - å…¨å±
                            e.preventDefault();
                            toggleFullscreen();
                            break;
                        case 's':
                        case 'S': // S - æˆªå›¾
                            e.preventDefault();
                            captureScreenshot();
                            break;
                        case 'h':
                        case 'H': // H - æ˜¾ç¤º/éšè—è¾…åŠ©çº¿
                            e.preventDefault();
                            setShowGuides(!showGuides);
                            break;
                        case '?': // ? - å¸®åŠ©
                            e.preventDefault();
                            setShowGuide(true);
                            break;
                        case 'Escape': // Esc - å…³é—­å¼¹çª—
                            if (settingsOpen) setSettingsOpen(false);
                            if (showGuide) setShowGuide(false);
                            break;
                    }
                }
                
                // ç›‘å¬æ— éšœç¢è®¿é—®åŠ¨ä½œäº‹ä»¶
                function handleAccessibilityAction(e) {
                    switch(e.detail.action) {
                        case 'settings':
                            setSettingsOpen(true);
                            break;
                        case 'guide':
                            setShowGuide(true);
                            break;
                        case 'monitoring':
                            setIsMonitoring(!isMonitoring);
                            break;
                        case 'recording':
                            if (recordingState.status === 'recording') {
                                stopRecording();
                            } else {
                                startRecording();
                            }
                            break;
                        case 'close':
                            setSettingsOpen(false);
                            setShowGuide(false);
                            break;
                    }
                }
                
                window.addEventListener('keydown', handleKeyPress);
                document.addEventListener('accessibility-action', handleAccessibilityAction);
                return () => {
                    window.removeEventListener('keydown', handleKeyPress);
                    document.removeEventListener('accessibility-action', handleAccessibilityAction);
                };
            }, [showGuides, settingsOpen, showGuide, isMonitoring, recordingState.status]);
            
            // å…¨å±åŠŸèƒ½ - å·²æå–åˆ° js/ui-utils.js
            const toggleFullscreen = window.toggleFullscreen || function() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error('æ— æ³•è¿›å…¥å…¨å±:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            };
            
            // æˆªå›¾åŠŸèƒ½ - å·²æå–åˆ° js/ui-utils.js
            function captureScreenshot() {
                if (canvasRef.current && window.captureScreenshot) {
                    window.captureScreenshot(canvasRef.current);
                }
            }
            
            // ========== OnboardingFlow ç»„ä»¶å‡½æ•° ==========
            function OnboardingFlow() {
                // å¦‚æœå·²å®Œæˆï¼Œä¸æ˜¾ç¤º
                if (onboardingStep === -1) {
                    return null;
                }
                
                // æ­¥éª¤1: æ¬¢è¿ç•Œé¢
                if (onboardingStep === 0) {
            return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.9)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10000,
                            backdropFilter: 'blur(10px)'
                        }}>
                            <div style={{
                                background: 'var(--bg-card)',
                                borderRadius: 'var(--radius-lg)',
                                padding: 'var(--space-xl)',
                                maxWidth: '600px',
                                width: '90%',
                                textAlign: 'center',
                                boxShadow: 'var(--shadow-lg)',
                                animation: 'slideIn 0.5s ease'
                            }}>
                                <div style={{ fontSize: '64px', marginBottom: 'var(--space-md)' }}>
                                    ğŸ¥
                                </div>
                                <h1 style={{
                                    fontSize: 'var(--font-h1)',
                                    fontWeight: 600,
                                    marginBottom: 'var(--space-sm)',
                                    color: 'var(--text-primary)'
                                }}>
                                    {language === 'zh' ? 'æ¬¢è¿ä½¿ç”¨ PostureGuard' : 'Welcome to PostureGuard'}
                                </h1>
                                <p style={{
                                    fontSize: 'var(--font-body-large)',
                                    color: 'var(--text-secondary)',
                                    marginBottom: 'var(--space-xl)',
                                    lineHeight: 1.6
                                }}>
                                    {language === 'zh' 
                                        ? 'ä¸ºæ‚¨çš„å¥åº·ä¿é©¾æŠ¤èˆª'
                                        : 'Protecting your health and well-being'
                                    }
                                </p>
                                {/* å¿«é€Ÿå¼€å§‹æŒ‰é’® */}
                                <button
                                    onClick={async () => {
                                        // å¿«é€Ÿå¼€å§‹ï¼šè·³è¿‡æ‰€æœ‰æ­¥éª¤ï¼Œç›´æ¥å¼€å§‹ç›‘æµ‹
                                        try {
                                            // è‡ªåŠ¨è¯·æ±‚æ‘„åƒå¤´æƒé™
                                            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                                            stream.getTracks().forEach(track => track.stop());
                                            setCameraPermissionGranted(true);
                                            
                                            // è®¾ç½®é»˜è®¤SCIæ¨¡å¼ï¼ˆå¦‚æœç”¨æˆ·æ˜¯SCIæ‚£è€…ï¼‰
                                            if (window.setThresholdMode) {
                                                // å¯ä»¥æ ¹æ®localStorageæˆ–å…¶ä»–æ–¹å¼åˆ¤æ–­ï¼Œè¿™é‡Œé»˜è®¤ä½¿ç”¨æ ‡å‡†æ¨¡å¼
                                                window.setThresholdMode('standard', null);
                                            }
                                            
                                            // è·³è¿‡æ‰€æœ‰æ­¥éª¤ï¼Œç›´æ¥å¼€å§‹
                                            setOnboardingStep(-1);
                                            setHasSeenGuide(true);
                                            localStorage.setItem('hasSeenGuide', 'true');
                                            setIsMonitoring(true);
                                        } catch (error) {
                                            // å¦‚æœå¿«é€Ÿå¼€å§‹å¤±è´¥ï¼Œè¿›å…¥æ­£å¸¸æµç¨‹
                                            setOnboardingStep(1);
                                        }
                                    }}
                                    style={{
                                        padding: 'var(--space-sm) var(--space-xl)',
                                        background: 'var(--primary-green)',
                                        border: 'none',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        fontSize: 'var(--font-body-large)',
                                        fontWeight: 600,
                                        cursor: 'pointer',
                                        marginBottom: 'var(--space-sm)',
                                        minHeight: 'var(--min-touch-target)',
                                        width: '100%',
                                        transition: 'all 0.3s'
                                    }}
                                    onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                                    onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                                    aria-label={language === 'zh' ? 'å¿«é€Ÿå¼€å§‹ç›‘æµ‹' : 'Quick Start Monitoring'}
                                >
                                    âš¡ {language === 'zh' ? 'å¿«é€Ÿå¼€å§‹' : 'Quick Start'}
                                </button>
                                
                                <div style={{
                                    fontSize: 'var(--font-body-small)',
                                    color: 'var(--text-secondary)',
                                    marginBottom: 'var(--space-md)',
                                    textAlign: 'center'
                                }}>
                                    {language === 'zh' ? 'æˆ–' : 'or'}
                                </div>
                                
                                <button
                                    onClick={() => setOnboardingStep(1)}
                                    style={{
                                        padding: 'var(--space-sm) var(--space-xl)',
                                        background: 'var(--primary-blue)',
                                        border: 'none',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        fontSize: 'var(--font-body-large)',
                                        fontWeight: 600,
                                        cursor: 'pointer',
                                        transition: 'all 0.3s'
                                    }}
                                    onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                                    onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                                >
                                    {language === 'zh' ? 'å¼€å§‹è®¾ç½®' : 'Get Started'}
                                </button>
                            </div>
                        </div>
                    );
                }
                
                // æ­¥éª¤2: æ‘„åƒå¤´æƒé™
                if (onboardingStep === 1) {
                    return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.9)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10000,
                            backdropFilter: 'blur(10px)'
                        }}>
                            <div style={{
                                background: 'var(--bg-card)',
                                borderRadius: 'var(--radius-lg)',
                                padding: 'var(--space-xl)',
                                maxWidth: '600px',
                                width: '90%',
                                textAlign: 'center',
                                boxShadow: 'var(--shadow-lg)'
                            }}>
                                <div style={{ fontSize: '64px', marginBottom: 'var(--space-md)' }}>
                                    ğŸ“¹
                                </div>
                                <h2 style={{
                                    fontSize: 'var(--font-h2)',
                                    fontWeight: 600,
                                    marginBottom: 'var(--space-sm)',
                                    color: 'var(--text-primary)'
                                }}>
                                    {language === 'zh' ? 'æ‘„åƒå¤´æƒé™' : 'Camera Permission'}
                                </h2>
                                <p style={{
                                    fontSize: 'var(--font-body)',
                                    color: 'var(--text-secondary)',
                                    marginBottom: 'var(--space-lg)',
                                    lineHeight: 1.6
                                }}>
                                    {language === 'zh' 
                                        ? 'æˆ‘ä»¬éœ€è¦è®¿é—®æ‚¨çš„æ‘„åƒå¤´æ¥è¿›è¡Œå®æ—¶å§¿æ€ç›‘æµ‹ã€‚è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å…è®¸è®¿é—®ã€‚'
                                        : 'We need access to your camera for real-time posture monitoring. Please click the button below to allow access.'
                                    }
                                </p>
                                <div style={{
                                    display: 'flex',
                                    gap: 'var(--space-sm)',
                                    justifyContent: 'center'
                                }}>
                                    <button
                                        onClick={() => setOnboardingStep(0)}
                                        style={{
                                            padding: 'var(--space-sm) var(--space-lg)',
                                            background: 'var(--bg-dark)',
                                            border: '1px solid rgba(255,255,255,0.2)',
                                            borderRadius: 'var(--radius-sm)',
                                            color: 'var(--text-primary)',
                                            fontSize: 'var(--font-body)',
                                            fontWeight: 600,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {language === 'zh' ? 'è¿”å›' : 'Back'}
                                    </button>
                                    <button
                                        onClick={async () => {
                                            try {
                                                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                                                setCameraPermissionGranted(true);
                                                // åœæ­¢æµï¼ˆæˆ‘ä»¬ä¼šåœ¨ä¸»åº”ç”¨ä¸­é‡æ–°è¯·æ±‚ï¼‰
                                                stream.getTracks().forEach(track => track.stop());
                                                setOnboardingStep(2);
                                            } catch (error) {
                                                alert(language === 'zh' 
                                                    ? 'æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚'
                                                    : 'Cannot access camera. Please check browser permissions.'
                                                );
                                            }
                                        }}
                                        style={{
                                            padding: 'var(--space-sm) var(--space-lg)',
                                            background: 'var(--primary-blue)',
                                            border: 'none',
                                            borderRadius: 'var(--radius-sm)',
                                            color: 'white',
                                            fontSize: 'var(--font-body)',
                                            fontWeight: 600,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {language === 'zh' ? 'å…è®¸è®¿é—®' : 'Allow Access'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // æ­¥éª¤3: ä½ç½®è°ƒæ•´
                if (onboardingStep === 2) {
                    return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10000,
                            backdropFilter: 'blur(5px)'
                        }}>
                            <div style={{
                                background: 'var(--bg-card)',
                                borderRadius: 'var(--radius-lg)',
                                padding: 'var(--space-xl)',
                                maxWidth: '700px',
                                width: '90%',
                                textAlign: 'center',
                                boxShadow: 'var(--shadow-lg)'
                            }}>
                                <div style={{ fontSize: '64px', marginBottom: 'var(--space-md)' }}>
                                    ğŸ“
                                </div>
                                <h2 style={{
                                    fontSize: 'var(--font-h2)',
                                    fontWeight: 600,
                                    marginBottom: 'var(--space-sm)',
                                    color: 'var(--text-primary)'
                                }}>
                                    {language === 'zh' ? 'ä½ç½®è°ƒæ•´' : 'Position Adjustment'}
                                </h2>
                                <p style={{
                                    fontSize: 'var(--font-body)',
                                    color: 'var(--text-secondary)',
                                    marginBottom: 'var(--space-lg)',
                                    lineHeight: 1.6
                                }}>
                                    {language === 'zh' 
                                        ? 'è¯·è°ƒæ•´æ‚¨çš„ä½ç½®ï¼Œä½¿èº«ä½“åœ¨ç”»é¢ä¸­å¿ƒã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æ˜¾ç¤ºè¾…åŠ©çº¿å¸®åŠ©æ‚¨å¯¹é½ã€‚'
                                        : 'Please adjust your position so your body is centered in the frame. The system will automatically show guide lines to help you align.'
                                    }
                                </p>
                                
                                <div style={{
                                    background: 'rgba(59, 130, 246, 0.1)',
                                    border: '2px solid var(--primary-blue)',
                                    borderRadius: 'var(--radius-md)',
                                    padding: 'var(--space-md)',
                                    marginBottom: 'var(--space-lg)',
                                    textAlign: 'left'
                                }}>
                                    <p style={{
                                        fontSize: 'var(--font-body-small)',
                                        color: 'var(--text-primary)',
                                        margin: 0,
                                        marginBottom: 'var(--space-xs)'
                                    }}>
                                        <strong>ğŸ’¡ {language === 'zh' ? 'æç¤º' : 'Tip'}:</strong>
                                    </p>
                                    <ul style={{
                                        fontSize: 'var(--font-body-small)',
                                        color: 'var(--text-secondary)',
                                        margin: 0,
                                        paddingLeft: 'var(--space-md)',
                                        lineHeight: 1.8
                                    }}>
                                        <li>{language === 'zh' ? 'ä¾§é¢å¯¹å‡†æ‘„åƒå¤´ï¼ˆæ¨èï¼‰' : 'Face the camera sideways (recommended)'}</li>
                                        <li>{language === 'zh' ? 'ç¡®ä¿è‚©è†€åœ¨ç”»é¢ä¸­å¿ƒ' : 'Ensure shoulders are centered in the frame'}</li>
                                        <li>{language === 'zh' ? 'ä¿æŒå¤´éƒ¨å’Œèº¯å¹²å¯è§' : 'Keep head and torso visible'}</li>
                                    </ul>
                                </div>
                                
                                <div style={{
                                    display: 'flex',
                                    gap: 'var(--space-sm)',
                                    justifyContent: 'center'
                                }}>
                                    <button
                                        onClick={() => setOnboardingStep(1)}
                                        style={{
                                            padding: 'var(--space-sm) var(--space-lg)',
                                            background: 'var(--bg-dark)',
                                            border: '1px solid rgba(255,255,255,0.2)',
                                            borderRadius: 'var(--radius-sm)',
                                            color: 'var(--text-primary)',
                                            fontSize: 'var(--font-body)',
                                            fontWeight: 600,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {language === 'zh' ? 'è¿”å›' : 'Back'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowGuides(true);
                                            setOnboardingStep(3);
                                        }}
                                        style={{
                                            padding: 'var(--space-sm) var(--space-lg)',
                                            background: 'var(--primary-green)',
                                            border: 'none',
                                            borderRadius: 'var(--radius-sm)',
                                            color: 'white',
                                            fontSize: 'var(--font-body)',
                                            fontWeight: 600,
                                            cursor: 'pointer'
                                        }}
                                    >
                                        {language === 'zh' ? 'å®Œæˆæ ¡å‡†' : 'Complete Calibration'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // æ­¥éª¤4: å¿«é€Ÿæ•™ç¨‹
                if (onboardingStep === 3) {
                    return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.9)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10000,
                            backdropFilter: 'blur(10px)'
                        }}>
                            <div style={{
                                background: 'var(--bg-card)',
                                borderRadius: 'var(--radius-lg)',
                                padding: 'var(--space-xl)',
                                maxWidth: '700px',
                                width: '90%',
                                textAlign: 'center',
                                boxShadow: 'var(--shadow-lg)'
                            }}>
                                <div style={{ fontSize: '64px', marginBottom: 'var(--space-md)' }}>
                                    ğŸ“š
                                </div>
                                <h2 style={{
                                    fontSize: 'var(--font-h2)',
                                    fontWeight: 600,
                                    marginBottom: 'var(--space-lg)',
                                    color: 'var(--text-primary)'
                                }}>
                                    {language === 'zh' ? 'å¿«é€Ÿæ•™ç¨‹' : 'Quick Tutorial'}
                                </h2>
                                
                                <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: 'var(--space-md)',
                                    marginBottom: 'var(--space-xl)',
                                    textAlign: 'left'
                                }}>
                                    <div style={{
                                        background: 'rgba(16, 185, 129, 0.1)',
                                        border: '2px solid var(--primary-green)',
                                        borderRadius: 'var(--radius-md)',
                                        padding: 'var(--space-md)',
                                        display: 'flex',
                                        gap: 'var(--space-sm)',
                                        alignItems: 'flex-start'
                                    }}>
                                        <div style={{ fontSize: '32px', flexShrink: 0 }}>âœ…</div>
                                            <div>
                                            <h3 style={{
                                                fontSize: 'var(--font-h3)',
                                                fontWeight: 600,
                                                marginBottom: 'var(--space-xs)',
                                                color: 'var(--text-primary)'
                                            }}>
                                                {language === 'zh' ? '1. ç»¿è‰² = è‰¯å¥½å§¿æ€' : '1. Green = Good Posture'}
                                            </h3>
                                            <p style={{
                                                fontSize: 'var(--font-body)',
                                                color: 'var(--text-secondary)',
                                                margin: 0,
                                                lineHeight: 1.6
                                            }}>
                                                {language === 'zh' 
                                                    ? 'å½“çŠ¶æ€æ˜¾ç¤ºä¸ºç»¿è‰²æ—¶ï¼Œè¡¨ç¤ºæ‚¨çš„åå§¿è‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼'
                                                    : 'When the status shows green, it means your sitting posture is good. Keep it up!'
                                                }
                                                </p>
                                            </div>
                                        </div>
                                    
                                    <div style={{
                                        background: 'rgba(239, 68, 68, 0.1)',
                                        border: '2px solid var(--danger-red)',
                                        borderRadius: 'var(--radius-md)',
                                        padding: 'var(--space-md)',
                                        display: 'flex',
                                        gap: 'var(--space-sm)',
                                        alignItems: 'flex-start'
                                    }}>
                                        <div style={{ fontSize: '32px', flexShrink: 0 }}>âŒ</div>
                                        <div>
                                            <h3 style={{
                                                fontSize: 'var(--font-h3)',
                                                fontWeight: 600,
                                                marginBottom: 'var(--space-xs)',
                                                color: 'var(--text-primary)'
                                            }}>
                                                {language === 'zh' ? '2. çº¢è‰² = éœ€è¦è°ƒæ•´' : '2. Red = Needs Adjustment'}
                                            </h3>
                                            <p style={{
                                                fontSize: 'var(--font-body)',
                                                color: 'var(--text-secondary)',
                                                margin: 0,
                                                lineHeight: 1.6
                                            }}>
                                                {language === 'zh' 
                                                    ? 'å½“çŠ¶æ€æ˜¾ç¤ºä¸ºçº¢è‰²æ—¶ï¼Œè¯·ç«‹å³è°ƒæ•´åå§¿ï¼Œé¿å…é•¿æ—¶é—´ä¿æŒä¸è‰¯å§¿åŠ¿ã€‚'
                                                    : 'When the status shows red, please adjust your sitting posture immediately to avoid maintaining bad posture for long periods.'
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div style={{
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        border: '2px solid var(--primary-blue)',
                                        borderRadius: 'var(--radius-md)',
                                        padding: 'var(--space-md)',
                                        display: 'flex',
                                        gap: 'var(--space-sm)',
                                        alignItems: 'flex-start'
                                    }}>
                                        <div style={{ fontSize: '32px', flexShrink: 0 }}>âš™ï¸</div>
                                        <div>
                                            <h3 style={{
                                                fontSize: 'var(--font-h3)',
                                                fontWeight: 600,
                                                marginBottom: 'var(--space-xs)',
                                                color: 'var(--text-primary)'
                                            }}>
                                                {language === 'zh' ? '3. ç‚¹å‡»è®¾ç½®è°ƒæ•´çµæ•åº¦' : '3. Click Settings to Adjust Sensitivity'}
                                            </h3>
                                            <p style={{
                                                fontSize: 'var(--font-body)',
                                                color: 'var(--text-secondary)',
                                                margin: 0,
                                                lineHeight: 1.6
                                            }}>
                                                {language === 'zh' 
                                                    ? 'æ‚¨å¯ä»¥åœ¨è®¾ç½®ä¸­è°ƒæ•´æ£€æµ‹é˜ˆå€¼ï¼Œä»¥é€‚åº”ä¸åŒçš„èº«ä½“çŠ¶å†µå’Œéœ€æ±‚ã€‚'
                                                    : 'You can adjust detection thresholds in settings to adapt to different physical conditions and needs.'
                                                }
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <button
                                    onClick={() => {
                                        setOnboardingStep(-1);
                                        setHasSeenGuide(true);
                                        localStorage.setItem('hasSeenGuide', 'true');
                                    }}
                                    style={{
                                        padding: 'var(--space-sm) var(--space-xl)',
                                        background: 'var(--primary-green)',
                                        border: 'none',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        fontSize: 'var(--font-body-large)',
                                        fontWeight: 600,
                                        cursor: 'pointer',
                                        transition: 'all 0.3s',
                                        width: '100%'
                                    }}
                                    onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                                    onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                                >
                                    {language === 'zh' ? 'å¼€å§‹ç›‘æµ‹' : 'Start Monitoring'}
                                </button>
                            </div>
                        </div>
                    );
                }
                
                return null;
            }

            return (
                <div className="flex flex-col h-screen" style={{ background: 'var(--bg-dark)', color: 'var(--text-primary)' }} role="main" id="main-content">
                    <OnboardingFlow />
                    
                    <header role="banner" style={{ 
                        background: 'var(--bg-card)', 
                        padding: 'var(--space-sm)', 
                        boxShadow: 'var(--shadow-md)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        flexShrink: 0
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-sm)' }}>
                            <h1 style={{ fontSize: 'var(--font-h2)', fontWeight: 600, margin: 0 }}>
                                ğŸ¥ {i18n[language].title}
                            </h1>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-sm)' }}>
                            <span style={{ fontSize: 'var(--font-body-small)', color: 'var(--text-secondary)' }}>
                                {i18n[language].fps}: {fps}
                            </span>
                            <button
                                onClick={() => handleLanguageChange(language === 'zh' ? 'en' : 'zh')}
                                style={{
                                    padding: 'var(--space-xs) var(--space-sm)',
                                    borderRadius: 'var(--radius-sm)',
                                    background: 'var(--bg-dark)',
                                    border: '1px solid rgba(255,255,255,0.2)',
                                    color: 'var(--text-primary)',
                                    cursor: 'pointer',
                                    fontSize: 'var(--font-body-small)'
                                }}
                            >
                                {language === 'zh' ? i18n[language].switchToEnglish : i18n[language].switchToChinese}
                            </button>
                            <button
                                onClick={() => setShowGuide(true)}
                                style={{
                                    padding: 'var(--space-xs) var(--space-sm)',
                                    borderRadius: 'var(--radius-sm)',
                                    background: 'var(--primary-blue)',
                                    border: 'none',
                                    color: 'white',
                                    cursor: 'pointer',
                                    fontSize: 'var(--font-body-small)'
                                }}
                                aria-label={i18n[language].guide}
                            >
                                â“ {i18n[language].guide}
                            </button>
                            <button
                                onClick={() => setSettingsOpen(true)}
                                style={{
                                    padding: 'var(--space-xs) var(--space-sm)',
                                    borderRadius: 'var(--radius-sm)',
                                    background: 'var(--bg-dark)',
                                    border: '1px solid rgba(255,255,255,0.2)',
                                    color: 'var(--text-primary)',
                                    cursor: 'pointer',
                                    fontSize: 'var(--font-body-small)',
                                    minHeight: 'var(--min-touch-target)',
                                    minWidth: 'var(--min-touch-target)'
                                }}
                                aria-label={i18n[language].settings}
                                title={`${i18n[language].settings} (Alt+S)`}
                            >
                                âš™ï¸ {i18n[language].settings}
                            </button>
                        </div>
                    </header>

                    <div style={{ 
                        display: 'flex', 
                        flex: 1, 
                        overflow: 'hidden',
                        minHeight: 0,
                        position: 'relative'
                    }}>
                        <div style={{ 
                            flex: '1',
                            padding: 'var(--space-md)',
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            overflowY: 'auto',
                            background: 'var(--bg-dark)'
                        }}>
                            <div 
                                className="video-container" 
                                style={{ 
                                    width: '100%', 
                                    maxWidth: '100%',
                                    position: 'relative'
                                }}
                            >
                                {/* è§†é¢‘å’Œç”»å¸ƒ */}
                                <div style={{ position: 'relative', width: '100%', height: '100%' }}>
                                    <video 
                                        ref={videoRef}
                                        style={{
                                            width: '100%',
                                            height: '100%',
                                            objectFit: 'cover',
                                        display: 'none'
                                        }}
                                        autoPlay
                                        playsInline
                                    muted
                                    />
                                    <canvas 
                                        ref={canvasRef}
                                        className={`overlay-canvas ${isGoodPosture ? 'good-posture-border' : 'bad-posture-border'}`}
                                        style={{
                                            width: '100%',
                                            height: '100%',
                                            objectFit: 'contain',
                                            display: 'block',
                                            borderRadius: '12px',
                                            transition: 'box-shadow 0.3s ease'
                                        }}
                                    />
                                    
                                    {/* å§¿åŠ¿çŠ¶æ€è¾¹æ¡†åŠ¨ç”» */}
                                    {isGoodPosture && (
                                        <div 
                                            className="posture-status-indicator good"
                                            style={{
                                                position: 'absolute',
                                                top: 0,
                                                left: 0,
                                                right: 0,
                                                bottom: 0,
                                                border: '3px solid rgba(16, 185, 129, 0.6)',
                                                borderRadius: '12px',
                                                pointerEvents: 'none',
                                                animation: 'pulse-green 2s ease-in-out infinite'
                                            }}
                                        />
                                    )}
                                    {!isGoodPosture && (
                                        <div 
                                            className="posture-status-indicator bad"
                                            style={{
                                                position: 'absolute',
                                                top: 0,
                                                left: 0,
                                                right: 0,
                                                bottom: 0,
                                                border: '3px solid rgba(239, 68, 68, 0.6)',
                                                borderRadius: '12px',
                                                pointerEvents: 'none',
                                                animation: 'pulse-red 1s ease-in-out infinite'
                                            }}
                                        />
                                    )}
                                
                                    {/* è¾…åŠ©çº¿ */}
                                    {showGuides && !simplifiedView && (
                                    <div className="alignment-guides">
                                        <div className="vertical-guide" />
                                        <div className="horizontal-guide" />
                                </div>
                                )}
                                
                                    {/* é¡¶éƒ¨ï¼šæ¨¡å¼æŒ‡ç¤ºå™¨ */}
                                    {!simplifiedView && (
                                        <div style={{
                                            position: 'absolute',
                                            top: 'var(--space-sm)',
                                            left: 'var(--space-sm)',
                                            background: 'rgba(0, 0, 0, 0.7)',
                                            backdropFilter: 'blur(10px)',
                                            padding: 'var(--space-xs) var(--space-sm)',
                                            borderRadius: 'var(--radius-md)',
                                            fontSize: 'var(--font-body-small)',
                                            fontWeight: 600,
                                            color: 'white',
                                            zIndex: 10
                                        }}>
                                            {viewMode === 'side' ? 'ğŸ“ ' : 'ğŸ‘ï¸ '}
                                            {viewMode === 'side' 
                                                ? (language === 'zh' ? 'ä¾§è§†å›¾æ¨¡å¼' : 'Side View')
                                                : (language === 'zh' ? 'æ­£è§†å›¾æ¨¡å¼' : 'Front View')
                                            }
                                        </div>
                                    )}
                                    
                                    
                                </div>
                            </div>
                            
                            {/* æµ®åŠ¨æ§åˆ¶é¢æ¿ */}
                            <div className="camera-control-panel" style={{
                                position: 'absolute',
                                bottom: 'var(--space-md)',
                                right: 'var(--space-md)',
                                background: 'rgba(0, 0, 0, 0.8)',
                                backdropFilter: 'blur(10px)',
                                borderRadius: 'var(--radius-lg)',
                                padding: 'var(--space-sm)',
                                display: 'flex',
                                gap: 'var(--space-xs)',
                                boxShadow: '0 4px 16px rgba(0,0,0,0.4)',
                                zIndex: 20
                            }}>
                                <button 
                                    className="control-icon-btn" 
                                    onClick={toggleFullscreen} 
                                    aria-label={i18n[language].fullscreen}
                                    title={`${i18n[language].fullscreen} (F)`}
                                    style={{
                                        padding: 'var(--space-sm)',
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        border: '1px solid rgba(255, 255, 255, 0.2)',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontSize: '20px',
                                        transition: 'all 0.3s',
                                        minWidth: '44px',
                                        minHeight: '44px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = 'rgba(255, 255, 255, 0.2)';
                                        e.target.style.transform = 'scale(1.1)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                                        e.target.style.transform = 'scale(1)';
                                    }}
                                >
                                    â›¶
                                </button>
                                <button 
                                    className="control-icon-btn" 
                                    onClick={captureScreenshot} 
                                    aria-label={i18n[language].screenshot}
                                    title={`${i18n[language].screenshot} (S)`}
                                    style={{
                                        padding: 'var(--space-sm)',
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        border: '1px solid rgba(255, 255, 255, 0.2)',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontSize: '20px',
                                        transition: 'all 0.3s',
                                        minWidth: '44px',
                                        minHeight: '44px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = 'rgba(255, 255, 255, 0.2)';
                                        e.target.style.transform = 'scale(1.1)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                                        e.target.style.transform = 'scale(1)';
                                    }}
                                >
                                    ğŸ“·
                                </button>
                                <button
                                    className="control-icon-btn" 
                                    onClick={() => setShowGuides(!showGuides)}
                                    aria-label={i18n[language].auxiliaryLines}
                                    title={`${i18n[language].auxiliaryLines} (H)`}
                                    style={{
                                        padding: 'var(--space-sm)',
                                        background: showGuides ? 'rgba(59, 130, 246, 0.3)' : 'rgba(255, 255, 255, 0.1)',
                                        border: showGuides ? '1px solid rgba(59, 130, 246, 0.5)' : '1px solid rgba(255, 255, 255, 0.2)',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontSize: '20px',
                                        transition: 'all 0.3s',
                                        minWidth: '44px',
                                        minHeight: '44px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = showGuides ? 'rgba(59, 130, 246, 0.4)' : 'rgba(255, 255, 255, 0.2)';
                                        e.target.style.transform = 'scale(1.1)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = showGuides ? 'rgba(59, 130, 246, 0.3)' : 'rgba(255, 255, 255, 0.1)';
                                        e.target.style.transform = 'scale(1)';
                                    }}
                                >
                                    {showGuides ? 'âœ“' : 'âŠ'}
                                </button>
                                <button
                                    className="control-icon-btn" 
                                    onClick={() => setSimplifiedView(!simplifiedView)}
                                    aria-label={language === 'zh' ? 'ç®€åŒ–è§†å›¾' : 'Simplified View'}
                                    title={simplifiedView ? (language === 'zh' ? 'æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯' : 'Show Details') : (language === 'zh' ? 'ç®€åŒ–è§†å›¾' : 'Simplified View')}
                                    style={{
                                        padding: 'var(--space-sm)',
                                        background: simplifiedView ? 'rgba(139, 92, 246, 0.3)' : 'rgba(255, 255, 255, 0.1)',
                                        border: simplifiedView ? '1px solid rgba(139, 92, 246, 0.5)' : '1px solid rgba(255, 255, 255, 0.2)',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontSize: '20px',
                                        transition: 'all 0.3s',
                                        minWidth: '44px',
                                        minHeight: '44px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = simplifiedView ? 'rgba(139, 92, 246, 0.4)' : 'rgba(255, 255, 255, 0.2)';
                                        e.target.style.transform = 'scale(1.1)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = simplifiedView ? 'rgba(139, 92, 246, 0.3)' : 'rgba(255, 255, 255, 0.1)';
                                        e.target.style.transform = 'scale(1)';
                                    }}
                                >
                                    ğŸ‘ï¸
                                </button>
                            </div>
                        </div>

                        <div style={{ 
                            flex: '0 0 40%',
                            background: 'var(--bg-card)',
                            padding: 'var(--space-md)',
                            overflowY: 'auto',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: 'var(--space-md)'
                        }}>
                            {/* ========== æ£€æµ‹ç»“æœå’Œå»ºè®® ========== */}
                            <div className="info-group">
                                <div className="info-group-title">
                                    {language === 'zh' ? 'ğŸ’¡ æ£€æµ‹ç»“æœ' : 'ğŸ’¡ Detection Results'}
                                </div>
                                
                            {(viewMode === 'side' && sideAnalysis) || (viewMode === 'front' && frontAnalysis) ? (
                                <div className="mb-4">
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        {((viewMode === 'side' && sideAnalysis.issues.length > 0) || 
                                          (viewMode === 'front' && frontAnalysis.issues.length > 0)) ? (
                                            <div className="space-y-2">
                                                {(viewMode === 'side' ? sideAnalysis.issues : frontAnalysis.issues).map((issue, i) => (
                                                    <div key={i} className="p-3 bg-red-900 bg-opacity-50 border border-red-500 border-opacity-50 rounded-lg text-sm">
                                                        âš ï¸ {issue}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <div className="p-3 bg-green-900 bg-opacity-50 border border-green-500 border-opacity-50 rounded-lg text-center font-bold text-green-400">
                                                âœ“ {viewMode === 'side' 
                                                    ? i18n[language].goodPostureText
                                                    : i18n[language].bodySymmetrical}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : null}

                            {/* ä¸ªæ€§åŒ–åº·å¤å»ºè®® */}
                            {((viewMode === 'side' && sideAnalysis) || (viewMode === 'front' && frontAnalysis)) && window.personalizedSuggestions && (
                                <div className="mb-4">
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        {(() => {
                                            const currentAnalysis = viewMode === 'side' ? sideAnalysis : frontAnalysis;
                                            const suggestions = window.personalizedSuggestions.generateSuggestions(
                                                currentAnalysis,
                                                history,
                                                language
                                            );
                                            
                                            if (suggestions.length === 0) {
                                                return (
                                                    <div className="p-3 bg-green-900 bg-opacity-50 border border-green-500 border-opacity-50 rounded-lg text-center text-green-400">
                                                        ğŸ’¡ {i18n[language].noSuggestions || (language === 'zh' ? 'æš‚æ— å»ºè®®' : 'No suggestions')}
                                                    </div>
                                                );
                                            }
                                            
                                            return (
                                                <div className="space-y-2">
                                                    {suggestions.map((suggestion, i) => (
                                                        <div 
                                                            key={i} 
                                                            className="p-3 rounded-lg text-sm"
                                                            style={{
                                                                background: suggestion.priority === 'high' 
                                                                    ? 'rgba(239, 68, 68, 0.2)' 
                                                                    : suggestion.priority === 'medium'
                                                                    ? 'rgba(245, 158, 11, 0.2)'
                                                                    : 'rgba(59, 130, 246, 0.2)',
                                                                border: suggestion.priority === 'high'
                                                                    ? '1px solid rgba(239, 68, 68, 0.5)'
                                                                    : suggestion.priority === 'medium'
                                                                    ? '1px solid rgba(245, 158, 11, 0.5)'
                                                                    : '1px solid rgba(59, 130, 246, 0.5)'
                                                            }}
                                                        >
                                                            <span style={{ marginRight: 'var(--space-xs)' }}>{suggestion.icon}</span>
                                                            {suggestion.text}
                                                        </div>
                                                    ))}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                    
                                    {/* æ¯æ—¥å°è´´å£« */}
                                    {window.personalizedSuggestions && (
                                        <div style={{
                                            marginTop: 'var(--space-sm)',
                                            padding: 'var(--space-sm)',
                                            background: 'rgba(251, 191, 36, 0.1)',
                                            border: '1px solid rgba(251, 191, 36, 0.3)',
                                            borderRadius: 'var(--radius-sm)',
                                            fontSize: 'var(--font-body-small)'
                                        }}>
                                            <strong>ğŸ’¡ {language === 'zh' ? 'æ¯æ—¥å°è´´å£«' : 'Daily Tip'}:</strong> {window.personalizedSuggestions.getDailyTip(language)}
                                        </div>
                                    )}
                                </div>
                            )}
                            </div>
                                    
                            <div className="info-group">
                                <div className="info-group-title">
                                    ğŸ“ {i18n[language].keyMetrics}
                                </div>
                                
                                {viewMode === 'side' && sideAnalysis && (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--space-sm)' }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: 'var(--space-xs)',
                                            background: 'rgba(255,255,255,0.05)',
                                            borderRadius: 'var(--radius-sm)'
                                        }}>
                                            <span style={{ fontSize: 'var(--font-body)', color: 'var(--text-secondary)' }}>
                                                {i18n[language].angles.neck}
                                                        </span>
                                            <span style={{ 
                                                fontSize: 'var(--font-body-large)', 
                                                fontWeight: 600,
                                                color: sideAnalysis.neckAngle < neckThreshold ? 'var(--primary-green)' : 'var(--danger-red)'
                                            }}>
                                                {sideAnalysis.neckAngle.toFixed(1)}Â° {sideAnalysis.neckAngle < neckThreshold ? 'âœ“' : 'âœ—'}
                                                        </span>
                                                    </div>
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: 'var(--space-xs)',
                                            background: 'rgba(255,255,255,0.05)',
                                            borderRadius: 'var(--radius-sm)'
                                        }}>
                                            <span style={{ fontSize: 'var(--font-body)', color: 'var(--text-secondary)' }}>
                                                {i18n[language].angles.torso}
                                            </span>
                                            <span style={{ 
                                                fontSize: 'var(--font-body-large)', 
                                                fontWeight: 600,
                                                color: sideAnalysis.torsoAngle < torsoThreshold ? 'var(--primary-green)' : 'var(--danger-red)'
                                            }}>
                                                {sideAnalysis.torsoAngle.toFixed(1)}Â° {sideAnalysis.torsoAngle < torsoThreshold ? 'âœ“' : 'âœ—'}
                                            </span>
                                                    </div>
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: 'var(--space-xs)',
                                            background: 'rgba(255,255,255,0.05)',
                                            borderRadius: 'var(--radius-sm)'
                                        }}>
                                            <span style={{ fontSize: 'var(--font-body)', color: 'var(--text-secondary)' }}>
                                                {i18n[language].alignmentStatus}
                                            </span>
                                            <span style={{ 
                                                fontSize: 'var(--font-body-large)', 
                                                fontWeight: 600,
                                                color: isAligned ? 'var(--primary-green)' : 'var(--warning-yellow)'
                                            }}>
                                                {isAligned ? 'âœ“ ' + (language === 'zh' ? 'å·²å¯¹é½' : 'Aligned') : 'âš ï¸ ' + (language === 'zh' ? 'æœªå¯¹é½' : 'Not Aligned')}
                                                        </span>
                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                            
                            <div className="info-group">
                                <div className="info-group-title">
                                    ğŸ›ï¸ {i18n[language].quickControls}
                                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--space-xs)' }}>
                                    <button
                                        onClick={() => {
                                            if (recordingState.status === 'recording') {
                                                stopRecording();
                                            } else {
                                                startRecording();
                                            }
                                        }}
                                        style={{
                                            padding: 'var(--space-sm)',
                                            borderRadius: 'var(--radius-sm)',
                                            background: recordingState.status === 'recording' ? 'var(--danger-red)' : 'var(--primary-green)',
                                            border: 'none',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: 'var(--font-body)',
                                            fontWeight: 600,
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: 'var(--space-xs)'
                                        }}
                                        aria-label={recordingState.status === 'recording' ? i18n[language].stopRecording : i18n[language].startRecording}
                                    >
                                        {recordingState.status === 'recording' ? 'â¸ï¸ ' : 'ğŸ”´ '}
                                        {recordingState.status === 'recording' 
                                            ? i18n[language].stopRecording
                                            : i18n[language].startRecording
                                        }
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (isMonitoring) {
                                                setIsMonitoring(false);
                                            } else {
                                                setIsMonitoring(true);
                                            }
                                        }}
                                        style={{
                                            padding: 'var(--space-sm)',
                                            borderRadius: 'var(--radius-sm)',
                                            background: isMonitoring ? 'var(--warning-yellow)' : 'var(--primary-blue)',
                                            border: 'none',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: 'var(--font-body)',
                                            fontWeight: 600,
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: 'var(--space-xs)'
                                        }}
                                        aria-label={isMonitoring ? i18n[language].pauseMonitoring : i18n[language].startMonitoring}
                                    >
                                        {isMonitoring ? 'â¸ï¸ ' : 'â–¶ï¸ '}
                                        {isMonitoring 
                                            ? i18n[language].pauseMonitoring
                                            : i18n[language].startMonitoring
                                        }
                                    </button>
                                        </div>
                                </div>


                            {history.length > 0 && (
                                <div className="info-group">
                                    <div className="info-group-title">
                                        ğŸ“ˆ {i18n[language].todayHistory}
                                    </div>
                                    <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                        {history.slice(0, 5).map((record) => (
                                            <div key={record.id} style={{
                                                padding: 'var(--space-sm)',
                                                background: 'rgba(255,255,255,0.05)',
                                                borderRadius: 'var(--radius-sm)',
                                                marginBottom: 'var(--space-xs)',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <div>
                                                    <div style={{ fontSize: 'var(--font-body-small)', fontWeight: 600 }}>
                                                        {record.startTime 
                                                            ? new Date(record.startTime).toLocaleTimeString(language === 'zh' ? 'zh-CN' : 'en-US', { hour: '2-digit', minute: '2-digit' })
                                                            : (record.date ? new Date(record.date).toLocaleTimeString(language === 'zh' ? 'zh-CN' : 'en-US', { hour: '2-digit', minute: '2-digit' }) : '--:--')
                                                        }
                                    </div>
                                                    <div style={{ fontSize: 'var(--font-body-small)', color: 'var(--text-secondary)' }}>
                                                        {formatDuration(record.duration || 0)} â€¢ {
                                                            record.summary?.goodPercentage !== undefined 
                                                                ? record.summary.goodPercentage 
                                                                : (record.goodTime && record.badTime 
                                                                    ? ((record.goodTime / (record.goodTime + record.badTime)) * 100).toFixed(1)
                                                                    : (record.goodFrames && record.badFrames
                                                                        ? ((record.goodFrames / (record.goodFrames + record.badFrames)) * 100).toFixed(1)
                                                                        : 0))
                                                        }% {i18n[language].good}
                                </div>
                                    </div>
                                                <button
                                                    onClick={() => {
                                                        try {
                                                            exportRecordReport(record);
                                                        } catch (error) {
                                                            console.error('å¯¼å‡ºå¤±è´¥:', error);
                                                            alert((language === 'zh' ? 'å¯¼å‡ºå¤±è´¥: ' : 'Export failed: ') + error.message);
                                                        }
                                                    }}
                                                    style={{
                                                        padding: 'var(--space-xs) var(--space-sm)',
                                                        background: 'var(--primary-blue)',
                                                        border: 'none',
                                                        borderRadius: 'var(--radius-sm)',
                                                        color: 'white',
                                                        cursor: 'pointer',
                                                        fontSize: 'var(--font-body-small)'
                                                    }}
                                                >
                                                    {i18n[language].view}
                                                </button>
                                    </div>
                                        ))}
                                </div>
                                </div>
                            )}
                            </div>

                            {viewMode === 'side' && sideAnalysis && (
                                <div className="info-group">
                                    <div className="info-group-title">
                                        ğŸ“ {i18n[language].angleMonitoring}
                                    </div>
                                    
                                    {/* è§’åº¦ä»ªè¡¨ç›˜ */}
                                    <div className="mb-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="tooltip">
                                                <AngleGauge
                                                    angle={smoothedNeck}
                                                    threshold={neckThreshold}
                                                    label={i18n[language].angles.neck}
                                                    color="blue"
                                                    language={language}
                                                />
                                                <span className="tooltiptext">
                                                    {language === 'zh' 
                                                        ? `é¢ˆéƒ¨å‰å€¾è§’åº¦ï¼š${smoothedNeck.toFixed(1)}Â°\næ ‡å‡†å€¼ï¼š< ${neckThreshold}Â°\nè¶…è¿‡é˜ˆå€¼è¡¨ç¤ºé¢ˆéƒ¨å‰å€¾`
                                                        : `Neck forward angle: ${smoothedNeck.toFixed(1)}Â°\nStandard: < ${neckThreshold}Â°\nExceeding threshold indicates forward head posture`}
                                                </span>
                                            </div>
                                            <div className="tooltip">
                                                <AngleGauge
                                                    angle={smoothedTorso}
                                                    threshold={torsoThreshold}
                                                    label={i18n[language].angles.torso}
                                                    color="purple"
                                                    language={language}
                                                />
                                                <span className="tooltiptext">
                                                    {language === 'zh' 
                                                        ? `èº¯å¹²å‰å€¾è§’åº¦ï¼š${smoothedTorso.toFixed(1)}Â°\næ ‡å‡†å€¼ï¼š< ${torsoThreshold}Â°\nè¶…è¿‡é˜ˆå€¼è¡¨ç¤ºé©¼èƒŒ`
                                                        : `Torso forward angle: ${smoothedTorso.toFixed(1)}Â°\nStandard: < ${torsoThreshold}Â°\nExceeding threshold indicates hunchback`}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* å®æ—¶è§’åº¦å›¾è¡¨ */}
                                    <div className="mb-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-semibold text-gray-300">
                                                {i18n[language].angles.realtimeChart}
                                            </span>
                                            <div className="tooltip">
                                                <button
                                                    onClick={() => {
                                                        const canvas = document.getElementById('angle-chart-canvas');
                                                        if (canvas) {
                                                            canvas.toBlob((blob) => {
                                                                if (blob) {
                                                                    const url = URL.createObjectURL(blob);
                                                                    const link = document.createElement('a');
                                                                    link.href = url;
                                                                    link.download = `angle_chart_${new Date().toISOString().split('T')[0]}_${Date.now()}.png`;
                                                                    link.click();
                                                                    URL.revokeObjectURL(url);
                                                                }
                                                            }, 'image/png');
                                                        }
                                                    }}
                                                    className="text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-700"
                                                    title={i18n[language].exportChart}
                                                >
                                                    ğŸ“·
                                                </button>
                                                <span className="tooltiptext">
                                                    {i18n[language].chartTooltip}
                                                </span>
                                            </div>
                                        </div>
                                        <AngleChart
                                            neckAngle={smoothedNeck}
                                            torsoAngle={smoothedTorso}
                                            neckThreshold={neckThreshold}
                                            torsoThreshold={torsoThreshold}
                                            language={language}
                                        />
                                    </div>
                                    
                                    {/* åŸå§‹è§’åº¦æ•°å€¼æ˜¾ç¤º */}
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="text-center">
                                                <p className="text-xs text-gray-400 mb-1">{i18n[language].angles.neck}</p>
                                                <p className="text-2xl font-bold text-blue-400">
                                                    {sideAnalysis.neckAngle.toFixed(1)}Â°
                                                </p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    {i18n[language].standard}: &lt;{neckThreshold}Â°
                                                </p>
                                            </div>
                                            <div className="text-center">
                                                <p className="text-xs text-gray-400 mb-1">{i18n[language].angles.torso}</p>
                                                <p className="text-2xl font-bold text-purple-400">
                                                    {sideAnalysis.torsoAngle.toFixed(1)}Â°
                                                </p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    {i18n[language].standard}: &lt;{torsoThreshold}Â°
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* è§’åº¦è¶‹åŠ¿åˆ†æ */}
                                    {angleHistoryRef.current.length >= 10 && (
                                        <div className="mb-4">
                                            <h3 className="text-sm font-bold mb-2 text-gray-300">{i18n[language].trendAnalysis}</h3>
                                            <div className="bg-gray-700 p-4 rounded-lg space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-300">{i18n[language].trendNeck}:</span>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-sm font-bold ${
                                                            angleTrend.neckTrend === 'improving' ? 'text-green-400' :
                                                            angleTrend.neckTrend === 'worsening' ? 'text-red-400' :
                                                            'text-gray-400'
                                                        }`}>
                                                            {angleTrend.neckTrend === 'improving' ? 'ğŸ“‰ ' + i18n[language].trendImproving :
                                                             angleTrend.neckTrend === 'worsening' ? 'ğŸ“ˆ ' + i18n[language].trendWorsening :
                                                             'â¡ï¸ ' + i18n[language].trendStable}
                                                        </span>
                                                        {Math.abs(angleTrend.neckChange) > 0.5 && (
                                                            <span className={`text-xs ${
                                                                angleTrend.neckChange < 0 ? 'text-green-400' : 'text-red-400'
                                                            }`}>
                                                                ({angleTrend.neckChange > 0 ? '+' : ''}{angleTrend.neckChange.toFixed(1)}Â°)
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm text-gray-300">{i18n[language].trendTorso}:</span>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-sm font-bold ${
                                                            angleTrend.torsoTrend === 'improving' ? 'text-green-400' :
                                                            angleTrend.torsoTrend === 'worsening' ? 'text-red-400' :
                                                            'text-gray-400'
                                                        }`}>
                                                            {angleTrend.torsoTrend === 'improving' ? 'ğŸ“‰ ' + i18n[language].trendImproving :
                                                             angleTrend.torsoTrend === 'worsening' ? 'ğŸ“ˆ ' + i18n[language].trendWorsening :
                                                             'â¡ï¸ ' + i18n[language].trendStable}
                                                        </span>
                                                        {Math.abs(angleTrend.torsoChange) > 0.5 && (
                                                            <span className={`text-xs ${
                                                                angleTrend.torsoChange < 0 ? 'text-green-400' : 'text-red-400'
                                                            }`}>
                                                                ({angleTrend.torsoChange > 0 ? '+' : ''}{angleTrend.torsoChange.toFixed(1)}Â°)
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-400 mt-2">
                                                    {i18n[language].trendBasedOn}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* è§’åº¦å†å²çƒ­åŠ›å›¾ */}
                                    {angleHistoryRef.current.length >= 30 && (
                                        <div className="mb-4">
                                            <h3 className="text-sm font-bold mb-2 text-gray-300">
                                                {i18n[language].angleHistoryHeatmap}
                                            </h3>
                                            <div className="bg-gray-700 p-4 rounded-lg">
                                                <div className="grid grid-cols-10 gap-1">
                                                    {angleHistoryRef.current.slice(-100).map((entry, idx) => {
                                                        // æ ¹æ®è§’åº¦å€¼è®¡ç®—é¢œè‰²å¼ºåº¦
                                                        const neckIntensity = Math.min(100, (entry.neck / 60) * 100);
                                                        const torsoIntensity = Math.min(100, (entry.torso / 30) * 100);
                                                        const avgIntensity = (neckIntensity + torsoIntensity) / 2;
                                                        
                                                        // é¢œè‰²æ˜ å°„ï¼šç»¿è‰²(å¥½) -> é»„è‰²(ä¸­ç­‰) -> çº¢è‰²(å·®)
                                                        let color;
                                                        if (avgIntensity < 33) {
                                                            color = `rgba(34, 197, 94, ${0.3 + avgIntensity / 100})`; // ç»¿è‰²
                                                        } else if (avgIntensity < 66) {
                                                            color = `rgba(234, 179, 8, ${0.3 + (avgIntensity - 33) / 100})`; // é»„è‰²
                                                        } else {
                                                            color = `rgba(239, 68, 68, ${0.3 + (avgIntensity - 66) / 100})`; // çº¢è‰²
                                                        }
                                                        
                                                        return (
                                                            <div
                                                                key={idx}
                                                                className="w-full aspect-square rounded"
                                                                style={{ backgroundColor: color }}
                                                                title={`${language === 'zh' ? 'é¢ˆéƒ¨' : 'Neck'}: ${entry.neck.toFixed(1)}Â° | ${language === 'zh' ? 'èº¯å¹²' : 'Torso'}: ${entry.torso.toFixed(1)}Â°`}
                                                            />
                                                        );
                                                    })}
                                                </div>
                                                <div className="flex items-center justify-between mt-3 text-xs text-gray-400">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-4 h-4 rounded bg-green-500 opacity-50"></div>
                                                        <span>{i18n[language].good}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-4 h-4 rounded bg-yellow-500 opacity-50"></div>
                                                        <span>{i18n[language].moderate}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-4 h-4 rounded bg-red-500 opacity-50"></div>
                                                        <span>{i18n[language].needsImprovement}</span>
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-400 mt-2 text-center">
                                                    {i18n[language].eachSquare}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    

                    {/* å†å²è®°å½•åº•éƒ¨æŠ½å±‰ */}
                    <div
                        className="history-drawer"
                        style={{
                            position: 'fixed',
                            bottom: 0,
                            left: 0,
                            right: 0,
                            height: historyCollapsed ? '60px' : '60vh',
                            maxHeight: '80vh',
                            background: 'var(--bg-card)',
                            borderTop: '2px solid rgba(59, 130, 246, 0.5)',
                            boxShadow: '0 -4px 20px rgba(0,0,0,0.3)',
                            zIndex: 100,
                            transition: 'height 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                            display: 'flex',
                            flexDirection: 'column',
                            overflow: 'hidden'
                        }}
                    >
                        {/* æŠ½å±‰å¤´éƒ¨ - å¯ç‚¹å‡»å±•å¼€/æ”¶èµ· */}
                        <div 
                            className="history-drawer-header"
                                onClick={() => setHistoryCollapsed(!historyCollapsed)}
                            style={{
                                padding: 'var(--space-md)',
                                background: 'var(--bg-dark)',
                                borderBottom: '1px solid rgba(255,255,255,0.1)',
                                cursor: 'pointer',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                userSelect: 'none',
                                minHeight: '60px'
                            }}
                            onMouseEnter={(e) => {
                                e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)';
                            }}
                            onMouseLeave={(e) => {
                                e.currentTarget.style.background = 'var(--bg-dark)';
                            }}
                        >
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-sm)' }}>
                                <div style={{
                                    width: '40px',
                                    height: '4px',
                                    background: 'rgba(59, 130, 246, 0.5)',
                                    borderRadius: '2px',
                                    marginRight: 'var(--space-xs)'
                                }} />
                                <h2 style={{ 
                                    fontSize: 'var(--font-h3)', 
                                    fontWeight: 700,
                                    margin: 0,
                                    color: 'var(--text-primary)'
                                }}>
                                    {i18n[language].history} ({i18n[language].last7Days})
                                </h2>
                                {history.length > 0 && (
                                    <span style={{
                                        padding: '2px 8px',
                                        background: 'rgba(59, 130, 246, 0.2)',
                                        borderRadius: 'var(--radius-full)',
                                        fontSize: 'var(--font-body-small)',
                                        color: 'var(--primary-blue)'
                                    }}>
                                        {history.length}
                                    </span>
                                )}
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-sm)' }}>
                                {!historyCollapsed && (
                                    <>
                                <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                        const report = generatePostureReport(history, language);
                                        const reportText = formatReport(report, language);
                                        const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
                                        const url = URL.createObjectURL(blob);
                                        const link = document.createElement('a');
                                        link.href = url;
                                        link.download = `posture_report_${new Date().toISOString().split('T')[0]}.txt`;
                                        link.click();
                                        URL.revokeObjectURL(url);
                                    }}
                                            style={{
                                                padding: 'var(--space-xs) var(--space-sm)',
                                                borderRadius: 'var(--radius-sm)',
                                                background: 'rgba(99, 102, 241, 0.8)',
                                                border: 'none',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontSize: 'var(--font-body-small)',
                                                fontWeight: 600,
                                                transition: 'all 0.3s'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.target.style.background = 'rgba(99, 102, 241, 1)';
                                                e.target.style.transform = 'translateY(-2px)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.target.style.background = 'rgba(99, 102, 241, 0.8)';
                                                e.target.style.transform = 'translateY(0)';
                                            }}
                                    title={i18n[language].generateReportTooltip}
                                >
                                    ğŸ“Š {i18n[language].generateReport}
                                </button>
                                <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                exportAllHistoryData();
                                            }}
                                            style={{
                                                padding: 'var(--space-xs) var(--space-sm)',
                                                borderRadius: 'var(--radius-sm)',
                                                background: 'rgba(139, 92, 246, 0.8)',
                                                border: 'none',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontSize: 'var(--font-body-small)',
                                                fontWeight: 600,
                                                transition: 'all 0.3s'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.target.style.background = 'rgba(139, 92, 246, 1)';
                                                e.target.style.transform = 'translateY(-2px)';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.target.style.background = 'rgba(139, 92, 246, 0.8)';
                                                e.target.style.transform = 'translateY(0)';
                                            }}
                                    title={i18n[language].exportAllHistoryTooltip}
                                >
                                    ğŸ’¾ {i18n[language].exportAllHistory}
                                </button>
                                    </>
                                )}
                                <div style={{
                                    fontSize: '24px',
                                    color: 'var(--primary-blue)',
                                    transition: 'transform 0.3s',
                                    transform: historyCollapsed ? 'rotate(0deg)' : 'rotate(180deg)'
                                }}>
                                    â–¼
                            </div>
                        </div>
                        </div>
                        
                        {/* æŠ½å±‰å†…å®¹ */}
                        <div style={{
                            flex: 1,
                            overflowY: 'auto',
                            overflowX: 'hidden',
                            padding: 'var(--space-md)',
                            display: historyCollapsed ? 'none' : 'block'
                        }}>
                        {/* å­˜å‚¨ç©ºé—´ä¿¡æ¯ */}
                        {(() => {
                            const storageInfo = checkStorageSpace();
                            if (storageInfo.usage > 0) {
                                return (
                                    <div className={`mt-2 p-2 rounded text-xs ${storageInfo.warning ? 'bg-yellow-900 text-yellow-200' : 'bg-gray-700 text-gray-300'}`}>
                                        <span>{i18n[language].storageInfo}: </span>
                                        <span className={storageInfo.warning ? 'font-bold' : ''}>
                                            {(storageInfo.usage / 1024 / 1024).toFixed(2)} MB / {(storageInfo.limit / 1024 / 1024).toFixed(0)} MB ({storageInfo.percentage}%)
                                        </span>
                                        {storageInfo.warning && (
                                            <span className="ml-2">âš ï¸ {i18n[language].considerExporting}</span>
                                        )}
                                    </div>
                                );
                            }
                            return null;
                        })()}
                        
                        {/* å†å²è®°å½•å®¹å™¨ - å¸¦æ»šåŠ¨æŒ‡ç¤ºå™¨ */}
                            {history.length === 0 ? (
                                <div className="text-center p-8 bg-gray-700 rounded-lg">
                                    <p className="text-gray-400 mb-2">{i18n[language].noHistory}</p>
                                    <p className="text-xs text-gray-500">{i18n[language].clickToStartRecording}</p>
                                </div>
                            ) : (
                            <div style={{ position: 'relative' }}>
                                {/* æ»šåŠ¨æŒ‡ç¤ºå™¨ - å·¦ä¾§ç®­å¤´ */}
                                <button
                                    onClick={() => {
                                        const container = document.getElementById('history-scroll-container');
                                        if (container) {
                                            container.scrollBy({ left: -320, behavior: 'smooth' });
                                        }
                                    }}
                                    className="history-scroll-btn history-scroll-btn-left"
                                    aria-label={language === 'zh' ? 'å‘å·¦æ»šåŠ¨' : 'Scroll left'}
                                    style={{
                                        position: 'absolute',
                                        left: '-10px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        zIndex: 10,
                                        background: 'rgba(59, 130, 246, 0.8)',
                                        border: 'none',
                                        borderRadius: '50%',
                                        width: '36px',
                                        height: '36px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '18px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.3)',
                                        transition: 'all 0.3s'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = 'rgba(59, 130, 246, 1)';
                                        e.target.style.transform = 'translateY(-50%) scale(1.1)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = 'rgba(59, 130, 246, 0.8)';
                                        e.target.style.transform = 'translateY(-50%) scale(1)';
                                    }}
                                >
                                    â—€
                                </button>
                                
                                {/* æ»šåŠ¨å®¹å™¨ */}
                                <div 
                                    id="history-scroll-container"
                                    className="overflow-x-auto overflow-y-hidden"
                                    style={{
                                        scrollbarWidth: 'thin',
                                        scrollbarColor: 'rgba(59, 130, 246, 0.5) transparent',
                                        padding: '0 40px'
                                    }}
                                >
                                    <div className="flex space-x-4 flex-nowrap" style={{ paddingBottom: '8px' }}>
                                    {history.slice(0, 7).map((entry) => {
                                        // å…¼å®¹æ–°æ—§æ ¼å¼
                                        const totalTime = entry.duration || (entry.goodTime + entry.badTime);
                                            const goodPercentage = parseFloat(entry.summary ? entry.summary.goodPercentage : (totalTime > 0 ? ((entry.goodTime / totalTime) * 100).toFixed(1) : 0));
                                            const badPercentage = parseFloat(entry.summary ? entry.summary.badPercentage : (totalTime > 0 ? ((entry.badTime / totalTime) * 100).toFixed(1) : 0));
                                        const date = entry.startTime ? new Date(entry.startTime) : new Date(entry.date || Date.now());
                                            
                                            // çŠ¶æ€åˆ¤æ–­
                                            const statusClass = goodPercentage >= 80 ? 'excellent' : goodPercentage >= 60 ? 'good' : 'needs-improvement';
                                            const statusText = goodPercentage >= 80 
                                                ? (language === 'zh' ? 'â­ ä¼˜ç§€' : 'â­ Excellent')
                                                : goodPercentage >= 60 
                                                ? (language === 'zh' ? 'âœ“ è‰¯å¥½' : 'âœ“ Good')
                                                : (language === 'zh' ? 'âš ï¸ éœ€æ”¹è¿›' : 'âš ï¸ Needs Improvement');
                                            
                                            const avgNeck = entry.summary ? entry.summary.avgNeckAngle : (entry.avgNeck || 0);
                                            const avgTorso = entry.summary ? entry.summary.avgTorsoAngle : (entry.avgTorso || 0);
                                            const alertCount = entry.summary ? entry.summary.alertCount : (entry.alertCount || 0);
                                        
                                        return (
                                                <div 
                                                    key={entry.id || entry.date} 
                                                    className={`history-card-enhanced history-card-${statusClass}`}
                                                    style={{
                                                        background: goodPercentage >= 80 
                                                            ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%)'
                                                            : goodPercentage >= 60
                                                            ? 'linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%)'
                                                            : 'linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(251, 191, 36, 0.1) 100%)',
                                                        border: goodPercentage >= 80
                                                            ? '2px solid rgba(16, 185, 129, 0.5)'
                                                            : goodPercentage >= 60
                                                            ? '2px solid rgba(59, 130, 246, 0.5)'
                                                            : '2px solid rgba(245, 158, 11, 0.5)',
                                                        padding: 'var(--space-md)',
                                                        borderRadius: 'var(--radius-lg)',
                                                        minWidth: '320px',
                                                        flexShrink: 0,
                                                        transition: 'all 0.3s ease',
                                                        cursor: 'pointer',
                                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                                                    }}
                                                    onMouseEnter={(e) => {
                                                        e.currentTarget.style.transform = 'translateY(-4px)';
                                                        e.currentTarget.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        e.currentTarget.style.transform = 'translateY(0)';
                                                        e.currentTarget.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                                                    }}
                                                >
                                                    {/* é¡¶éƒ¨ï¼šæ—¥æœŸå’ŒçŠ¶æ€å¾½ç«  */}
                                                    <div style={{ 
                                                        display: 'flex', 
                                                        justifyContent: 'space-between', 
                                                        alignItems: 'flex-start',
                                                        marginBottom: 'var(--space-md)'
                                                    }}>
                                                    <div>
                                                            <div style={{ 
                                                                fontSize: 'var(--font-h3)', 
                                                                fontWeight: 700,
                                                                color: 'var(--text-primary)',
                                                                marginBottom: 'var(--space-xs)'
                                                            }}>
                                                                ğŸ“… {date.toLocaleDateString(language === 'zh' ? 'zh-CN' : 'en-US', { 
                                                                    month: 'short', 
                                                                    day: 'numeric',
                                                                    year: 'numeric'
                                                                })}
                                                    </div>
                                                            <div style={{ 
                                                                fontSize: 'var(--font-body-small)', 
                                                                color: 'var(--text-secondary)'
                                                            }}>
                                                                â° {date.toLocaleTimeString(language === 'zh' ? 'zh-CN' : 'en-US', { 
                                                                    hour: '2-digit', 
                                                                    minute: '2-digit' 
                                                                })}
                                                            </div>
                                                        </div>
                                                        <div style={{
                                                            padding: 'var(--space-xs) var(--space-sm)',
                                                            borderRadius: 'var(--radius-md)',
                                                            background: goodPercentage >= 80
                                                                ? 'rgba(16, 185, 129, 0.2)'
                                                                : goodPercentage >= 60
                                                                ? 'rgba(59, 130, 246, 0.2)'
                                                                : 'rgba(245, 158, 11, 0.2)',
                                                            border: goodPercentage >= 80
                                                                ? '1px solid rgba(16, 185, 129, 0.5)'
                                                                : goodPercentage >= 60
                                                                ? '1px solid rgba(59, 130, 246, 0.5)'
                                                                : '1px solid rgba(245, 158, 11, 0.5)',
                                                            fontSize: 'var(--font-body-small)',
                                                            fontWeight: 600,
                                                            color: goodPercentage >= 80
                                                                ? 'rgb(16, 185, 129)'
                                                                : goodPercentage >= 60
                                                                ? 'rgb(59, 130, 246)'
                                                                : 'rgb(245, 158, 11)'
                                                        }}>
                                                            {statusText}
                                                        </div>
                                                </div>
                                                
                                                    {/* ä¸­é—´ï¼šå¯è§†åŒ–è¿›åº¦ - å¤§æ•°å­—æ˜¾ç¤º */}
                                                    <div style={{ 
                                                        textAlign: 'center',
                                                        marginBottom: 'var(--space-md)'
                                                    }}>
                                                        <div style={{
                                                            fontSize: '48px',
                                                            fontWeight: 700,
                                                            color: goodPercentage >= 80
                                                                ? 'rgb(16, 185, 129)'
                                                                : goodPercentage >= 60
                                                                ? 'rgb(59, 130, 246)'
                                                                : 'rgb(245, 158, 11)',
                                                            lineHeight: 1,
                                                            marginBottom: 'var(--space-xs)'
                                                        }}>
                                                            {goodPercentage.toFixed(1)}%
                                                        </div>
                                                        <div style={{
                                                            fontSize: 'var(--font-body-small)',
                                                            color: 'var(--text-secondary)',
                                                            marginBottom: 'var(--space-sm)'
                                                        }}>
                                                            {language === 'zh' ? 'è‰¯å¥½å§¿åŠ¿å æ¯”' : 'Good Posture'}
                                                        </div>
                                                        
                                                        {/* åŒè¿›åº¦æ¡ */}
                                                        <div style={{ 
                                                            width: '100%', 
                                                            background: 'rgba(255,255,255,0.1)', 
                                                            borderRadius: 'var(--radius-full)', 
                                                            height: '8px',
                                                            overflow: 'hidden',
                                                            marginBottom: 'var(--space-xs)'
                                                        }}>
                                                            <div 
                                                                style={{ 
                                                                    width: `${goodPercentage}%`,
                                                                    height: '100%',
                                                                    background: goodPercentage >= 80
                                                                        ? 'linear-gradient(90deg, rgb(16, 185, 129), rgb(34, 197, 94))'
                                                                        : goodPercentage >= 60
                                                                        ? 'linear-gradient(90deg, rgb(59, 130, 246), rgb(99, 102, 241))'
                                                                        : 'linear-gradient(90deg, rgb(245, 158, 11), rgb(251, 191, 36))',
                                                                    transition: 'width 0.3s ease'
                                                                }}
                                                    />
                                                </div>
                                                        <div style={{ 
                                                            display: 'flex', 
                                                            justifyContent: 'space-between',
                                                            fontSize: 'var(--font-body-small)'
                                                        }}>
                                                            <span style={{ color: 'rgb(16, 185, 129)' }}>âœ“ {goodPercentage.toFixed(1)}%</span>
                                                            <span style={{ color: 'rgb(239, 68, 68)' }}>âœ— {badPercentage.toFixed(1)}%</span>
                                                        </div>
                                                </div>
                                                
                                                    {/* åº•éƒ¨ï¼šå…³é”®æŒ‡æ ‡ */}
                                                    <div style={{ 
                                                        marginTop: 'var(--space-md)',
                                                        paddingTop: 'var(--space-md)',
                                                        borderTop: '1px solid rgba(255,255,255,0.1)'
                                                    }}>
                                                        <div style={{ 
                                                            display: 'flex', 
                                                            justifyContent: 'space-between',
                                                            marginBottom: 'var(--space-xs)',
                                                            fontSize: 'var(--font-body-small)'
                                                        }}>
                                                            <span style={{ color: 'var(--text-secondary)' }}>â±ï¸ {language === 'zh' ? 'æ—¶é•¿' : 'Duration'}</span>
                                                            <span style={{ fontWeight: 600, color: 'var(--text-primary)' }}>{formatDuration(totalTime)}</span>
                                                    </div>
                                                        <div style={{ 
                                                            display: 'flex', 
                                                            justifyContent: 'space-between',
                                                            marginBottom: 'var(--space-xs)',
                                                            fontSize: 'var(--font-body-small)'
                                                        }}>
                                                            <span style={{ color: 'var(--text-secondary)' }}>ğŸ“Š {language === 'zh' ? 'å¹³å‡è§’åº¦' : 'Avg Angles'}</span>
                                                            <span style={{ fontWeight: 600, color: 'var(--text-primary)' }}>
                                                                {avgNeck.toFixed(1)}Â° / {avgTorso.toFixed(1)}Â°
                                                            </span>
                                                    </div>
                                                        <div style={{ 
                                                            display: 'flex', 
                                                            justifyContent: 'space-between',
                                                            fontSize: 'var(--font-body-small)'
                                                        }}>
                                                            <span style={{ color: 'var(--text-secondary)' }}>âš ï¸ {i18n[language].alerts}</span>
                                                            <span style={{ fontWeight: 600, color: alertCount > 0 ? 'rgb(239, 68, 68)' : 'var(--text-primary)' }}>
                                                                {alertCount}
                                                            </span>
                                                    </div>
                                                </div>
                                                
                                                    {/* æ“ä½œæŒ‰é’® */}
                                                    <div style={{ 
                                                        marginTop: 'var(--space-md)',
                                                        display: 'flex',
                                                        gap: 'var(--space-xs)'
                                                    }}>
                                                    <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                            try {
                                                                exportRecordReport(entry);
                                                            } catch (error) {
                                                                console.error('å¯¼å‡ºå¤±è´¥:', error);
                                                                alert((language === 'zh' ? 'å¯¼å‡ºå¤±è´¥: ' : 'Export failed: ') + error.message);
                                                            }
                                                        }}
                                                            style={{
                                                                flex: 1,
                                                                padding: 'var(--space-sm)',
                                                                borderRadius: 'var(--radius-sm)',
                                                                background: 'rgba(139, 92, 246, 0.8)',
                                                                border: '1px solid rgba(139, 92, 246, 0.5)',
                                                                color: 'white',
                                                                cursor: 'pointer',
                                                                fontSize: 'var(--font-body-small)',
                                                                fontWeight: 600,
                                                                transition: 'all 0.3s'
                                                            }}
                                                            onMouseEnter={(e) => {
                                                                e.target.style.background = 'rgba(139, 92, 246, 1)';
                                                                e.target.style.transform = 'translateY(-2px)';
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                e.target.style.background = 'rgba(139, 92, 246, 0.8)';
                                                                e.target.style.transform = 'translateY(0)';
                                                            }}
                                                    >
                                                        ğŸ“„ {i18n[language].export}
                                                    </button>
                                                    <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                if (window.confirm(language === 'zh' ? 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ' : 'Are you sure you want to delete this record?')) {
                                                                    deleteRecord(entry.id || entry.date);
                                                                }
                                                            }}
                                                            style={{
                                                                flex: 1,
                                                                padding: 'var(--space-sm)',
                                                                borderRadius: 'var(--radius-sm)',
                                                                background: 'rgba(239, 68, 68, 0.8)',
                                                                border: '1px solid rgba(239, 68, 68, 0.5)',
                                                                color: 'white',
                                                                cursor: 'pointer',
                                                                fontSize: 'var(--font-body-small)',
                                                                fontWeight: 600,
                                                                transition: 'all 0.3s'
                                                            }}
                                                            onMouseEnter={(e) => {
                                                                e.target.style.background = 'rgba(239, 68, 68, 1)';
                                                                e.target.style.transform = 'translateY(-2px)';
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                e.target.style.background = 'rgba(239, 68, 68, 0.8)';
                                                                e.target.style.transform = 'translateY(0)';
                                                            }}
                                                    >
                                                        ğŸ—‘ï¸ {i18n[language].delete}
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                        </div>
                                
                                {/* æ»šåŠ¨æŒ‡ç¤ºå™¨ - å³ä¾§ç®­å¤´ */}
                                <button
                                    onClick={() => {
                                        const container = document.getElementById('history-scroll-container');
                                        if (container) {
                                            container.scrollBy({ left: 320, behavior: 'smooth' });
                                        }
                                    }}
                                    className="history-scroll-btn history-scroll-btn-right"
                                    aria-label={language === 'zh' ? 'å‘å³æ»šåŠ¨' : 'Scroll right'}
                                    style={{
                                        position: 'absolute',
                                        right: '-10px',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        zIndex: 10,
                                        background: 'rgba(59, 130, 246, 0.8)',
                                        border: 'none',
                                        borderRadius: '50%',
                                        width: '36px',
                                        height: '36px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '18px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.3)',
                                        transition: 'all 0.3s'
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = 'rgba(59, 130, 246, 1)';
                                        e.target.style.transform = 'translateY(-50%) scale(1.1)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = 'rgba(59, 130, 246, 0.8)';
                                        e.target.style.transform = 'translateY(-50%) scale(1)';
                                    }}
                                >
                                    â–¶
                                </button>
                                
                                {/* æ»šåŠ¨æç¤º */}
                                {history.length > 3 && (
                                    <div style={{
                                        textAlign: 'center',
                                        marginTop: 'var(--space-sm)',
                                        fontSize: 'var(--font-body-small)',
                                        color: 'var(--text-secondary)'
                                    }}>
                                        {language === 'zh' ? 'â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š â†’' : 'â† Swipe to see more â†’'}
                                    </div>
                                )}
                            </div>
                            )}
                        </div>
                    </div>

                    {showGuide && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-gray-800 p-6 rounded-lg max-w-3xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-bold">ğŸ“– {i18n[language].guide}</h2>
                                    <button
                                        onClick={() => {
                                            setShowGuide(false);
                                            setHasSeenGuide(true);
                                            localStorage.setItem('hasSeenGuide', 'true');
                                        }}
                                        className="text-gray-400 hover:text-white text-2xl"
                                    >
                                        Ã—
                                    </button>
                                </div>
                                
                                <div className="space-y-6 text-sm">
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>ğŸ¥</span> {i18n[language].guideCameraSetup}
                                        </h3>
                                        <ul className="list-disc list-inside space-y-2 text-gray-300">
                                            <li>{i18n[language].guideCameraSetupDesc1} <strong>{i18n[language].guideCameraSetupDesc1Bold}</strong>{i18n[language].guideCameraSetupDesc1Note}</li>
                                            <li>{i18n[language].guideCameraSetupDesc2}</li>
                                            <li>{i18n[language].guideCameraSetupDesc3}</li>
                                            <li>{i18n[language].guideCameraSetupDesc4}</li>
                                        </ul>
                                        <div className="mt-3 p-3 bg-gray-600 rounded text-xs">
                                            <strong>{i18n[language].guideCameraSetupDiagram}</strong> {i18n[language].guideCameraSetupDiagramDesc}
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>ğŸ“</span> {i18n[language].guideAlignmentCheck}
                                        </h3>
                                        <ul className="list-disc list-inside space-y-2 text-gray-300">
                                            <li><span className="text-green-400">âœ“ {i18n[language].guideAlignmentPerfect}</span>: {i18n[language].guideAlignmentPerfectDesc}</li>
                                            <li><span className="text-yellow-400">âš ï¸ {i18n[language].guideAlignmentAligned}</span>: {i18n[language].guideAlignmentAlignedDesc}</li>
                                            <li><span className="text-red-400">âœ— {i18n[language].guideAlignmentNotAligned}</span>: {i18n[language].guideAlignmentNotAlignedDesc}</li>
                                        </ul>
                                        <p className="mt-2 text-xs text-gray-400">
                                            {i18n[language].guideAlignmentThreshold} &lt; 150px {i18n[language].guideAlignmentThresholdPerfect} | &lt; 250px {i18n[language].guideAlignmentThresholdAligned} | &gt; 250px {i18n[language].guideAlignmentThresholdNotAligned}
                                        </p>
                                    </div>
                                    
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>âš™ï¸</span> {i18n[language].guideThresholdSettings}
                                        </h3>
                                        <div className="space-y-3 text-gray-300">
                                            <div>
                                                <p className="font-semibold mb-1">â€¢ {i18n[language].guideNeckAngle}</p>
                                                <ul className="list-disc list-inside ml-4 space-y-1 text-xs">
                                                    <li>{i18n[language].guideNeckAngleStandard} <strong>40Â°</strong> {i18n[language].guideNeckAngleStandardDesc}</li>
                                                    <li>{i18n[language].guideNeckAngleSCI} <strong>45-50Â°</strong></li>
                                                </ul>
                                            </div>
                                            <div>
                                                <p className="font-semibold mb-1">â€¢ {i18n[language].guideTorsoAngle}</p>
                                                <ul className="list-disc list-inside ml-4 space-y-1 text-xs">
                                                    <li>{i18n[language].guideTorsoAngleStandard} <strong>10Â°</strong> {i18n[language].guideTorsoAngleStandardDesc}</li>
                                                    <li>{i18n[language].guideTorsoAngleSCI} <strong>15-20Â°</strong></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>ğŸ¥</span> {i18n[language].guideRehabMode}
                                        </h3>
                                        <p className="text-gray-300 mb-2">{i18n[language].guideRehabModeDesc}</p>
                                        <ul className="list-disc list-inside space-y-1 text-gray-300 text-xs">
                                            <li>{i18n[language].guideRehabMode1}</li>
                                            <li>{i18n[language].guideRehabMode2}</li>
                                            <li>{i18n[language].guideRehabMode3}</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>ğŸ“Š</span> {i18n[language].guideDataRecording}
                                        </h3>
                                        <ul className="list-disc list-inside space-y-1 text-gray-300 text-xs">
                                            <li>{i18n[language].guideDataRecording1}</li>
                                            <li>{i18n[language].guideDataRecording2}</li>
                                            <li>{i18n[language].guideDataRecording3}</li>
                                            <li>{i18n[language].guideDataRecording4}</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>ğŸ’¡</span> {i18n[language].guideFAQ}
                                        </h3>
                                        <div className="space-y-3 text-xs">
                                            <div>
                                                <p className="font-semibold text-yellow-400 mb-1">{i18n[language].guideFAQ1Q}</p>
                                                <p className="text-gray-300 ml-4">{i18n[language].guideFAQ1A}</p>
                                            </div>
                                            <div>
                                                <p className="font-semibold text-yellow-400 mb-1">{i18n[language].guideFAQ2Q}</p>
                                                <p className="text-gray-300 ml-4">{i18n[language].guideFAQ2A}</p>
                                            </div>
                                            <div>
                                                <p className="font-semibold text-yellow-400 mb-1">{i18n[language].guideFAQ3Q}</p>
                                                <p className="text-gray-300 ml-4">{i18n[language].guideFAQ3A}</p>
                                            </div>
                                            <div>
                                                <p className="font-semibold text-yellow-400 mb-1">{i18n[language].guideFAQ4Q}</p>
                                                <p className="text-gray-300 ml-4">{i18n[language].guideFAQ4A}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gray-700 p-4 rounded-lg">
                                        <h3 className="font-bold text-lg mb-3 flex items-center gap-2">
                                            <span>ğŸ¬</span> {i18n[language].guideRecording}
                                        </h3>
                                        <ul className="list-disc list-inside space-y-1 text-gray-300 text-xs">
                                            <li>{i18n[language].guideRecording1}</li>
                                            <li>{i18n[language].guideRecording2}</li>
                                            <li>{i18n[language].guideRecording3}</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div className="mt-6 flex justify-end">
                                    <button
                                        onClick={() => {
                                            setShowGuide(false);
                                            setHasSeenGuide(true);
                                            localStorage.setItem('hasSeenGuide', 'true');
                                        }}
                                        className="px-6 py-2 rounded bg-green-600 hover:bg-green-700 font-bold"
                                    >
                                        {i18n[language].guideGotIt}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ========== è®¾ç½®æŠ½å±‰ - Settings Drawer ========== */}
                    <div className={`settings-drawer ${settingsOpen ? 'open' : ''}`}>
                        <div style={{ marginBottom: 'var(--space-lg)' }}>
                            <h2 style={{ fontSize: 'var(--font-h2)', fontWeight: 600, marginBottom: 'var(--space-md)' }}>
                                âš™ï¸ {language === 'zh' ? 'ç³»ç»Ÿè®¾ç½®' : 'System Settings'}
                            </h2>
                            <button
                                onClick={() => setSettingsOpen(false)}
                                style={{
                                    position: 'absolute',
                                    top: 'var(--space-md)',
                                    right: 'var(--space-md)',
                                    background: 'transparent',
                                    border: 'none',
                                    color: 'var(--text-primary)',
                                    fontSize: '24px',
                                    cursor: 'pointer'
                                }}
                                aria-label="å…³é—­è®¾ç½®"
                            >
                                âœ•
                            </button>
                        </div>
                        
                        {/* æ£€æµ‹è®¾ç½® */}
                        <div className="setting-group">
                            <label>{language === 'zh' ? 'é¢ˆéƒ¨è§’åº¦é˜ˆå€¼' : 'Neck Angle Threshold'}</label>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-sm)' }}>
                                <input
                                    type="range"
                                    min="20"
                                    max="60"
                                    value={neckThreshold}
                                    onChange={(e) => setNeckThreshold(Number(e.target.value))}
                                    style={{ flex: 1 }}
                                />
                                <span className="threshold-value">{neckThreshold}Â°</span>
                            </div>
                        </div>
                        
                        <div className="setting-group">
                            <label>{language === 'zh' ? 'èº¯å¹²è§’åº¦é˜ˆå€¼' : 'Torso Angle Threshold'}</label>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-sm)' }}>
                                <input
                                    type="range"
                                    min="5"
                                    max="30"
                                    value={torsoThreshold}
                                    onChange={(e) => setTorsoThreshold(Number(e.target.value))}
                                    style={{ flex: 1 }}
                                />
                                <span className="threshold-value">{torsoThreshold}Â°</span>
                            </div>
                        </div>
                        
                        {/* æé†’è®¾ç½® */}
                        <div className="setting-group">
                            <label style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-xs)' }}>
                                <input
                                    type="checkbox"
                                    checked={alertSoundEnabled}
                                    onChange={(e) => setAlertSoundEnabled(e.target.checked)}
                                />
                                {language === 'zh' ? 'å£°éŸ³æé†’' : 'Sound Alert'}
                            </label>
                        </div>
                        
                        <div className="setting-group">
                            <label style={{ display: 'flex', alignItems: 'center', gap: 'var(--space-xs)' }}>
                                <input
                                    type="checkbox"
                                    checked={alertNotificationEnabled}
                                    onChange={(e) => setAlertNotificationEnabled(e.target.checked)}
                                />
                                {language === 'zh' ? 'æ¡Œé¢é€šçŸ¥' : 'Desktop Notification'}
                            </label>
                            {alertNotificationEnabled && Notification.permission !== 'granted' && (
                                <button
                                    onClick={requestNotificationPermission}
                                    style={{
                                        marginTop: 'var(--space-xs)',
                                        padding: 'var(--space-xs) var(--space-sm)',
                                        background: 'var(--primary-blue)',
                                        border: 'none',
                                        borderRadius: 'var(--radius-sm)',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontSize: 'var(--font-body-small)'
                                    }}
                                >
                                    {language === 'zh' ? 'è¯·æ±‚é€šçŸ¥æƒé™' : 'Request Permission'}
                                </button>
                            )}
                        </div>
                        
                        {/* æ•´åˆçš„æ‚£è€…æ¨¡å¼å’Œåº·å¤é˜¶æ®µé€‰æ‹© */}
                        <div className="setting-group">
                            <label style={{ 
                                fontSize: 'var(--font-body)', 
                                fontWeight: 600, 
                                marginBottom: 'var(--space-sm)',
                                display: 'block'
                            }}>
                                {language === 'zh' ? 'ğŸ¥ æ‚£è€…é…ç½®' : 'ğŸ¥ Patient Configuration'}
                            </label>
                            
                            {/* ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ‚£è€…ç±»å‹ */}
                            <div style={{ marginBottom: 'var(--space-md)' }}>
                                <label style={{ 
                                    fontSize: 'var(--font-body-small)', 
                                    fontWeight: 600, 
                                    marginBottom: 'var(--space-xs)',
                                    display: 'block',
                                    color: 'var(--text-secondary)'
                                }}>
                                    {language === 'zh' ? '1. æ‚£è€…ç±»å‹' : '1. Patient Type'}
                                </label>
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                    gap: 'var(--space-sm)'
                                }}>
                                    {/* å¥åº·äººç¾¤ */}
                                    <div
                                        role="button"
                                        tabIndex={0}
                                        aria-label={language === 'zh' ? 'å¥åº·äººç¾¤ï¼šæ ‡å‡†é˜ˆå€¼' : 'Healthy People: Standard Thresholds'}
                                        onClick={() => {
                                        if (window.setThresholdMode) {
                                                window.setThresholdMode('standard', setCurrentThresholdModeState);
                                                const thresholds = window.getCurrentThresholds ? window.getCurrentThresholds() : SCI_THRESHOLDS.standard;
                                                setNeckThreshold(thresholds.neck);
                                                setTorsoThreshold(thresholds.torso);
                                                setShoulderThreshold(thresholds.shoulder);
                                                setHeadThreshold(thresholds.head);
                                                console.log(`âœ… å·²åˆ‡æ¢åˆ°æ ‡å‡†æ¨¡å¼: é¢ˆéƒ¨ ${thresholds.neck}Â°, èº¯å¹² ${thresholds.torso}Â°`);
                                            }
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' || e.key === ' ') {
                                                e.preventDefault();
                                                if (window.setThresholdMode) {
                                                    window.setThresholdMode('standard', setCurrentThresholdModeState);
                                                    const thresholds = window.getCurrentThresholds ? window.getCurrentThresholds() : SCI_THRESHOLDS.standard;
                                                    setNeckThreshold(thresholds.neck);
                                                    setTorsoThreshold(thresholds.torso);
                                                }
                                            }
                                        }}
                                        style={{
                                            padding: 'var(--space-sm)',
                                            borderRadius: 'var(--radius-sm)',
                                            border: currentThresholdMode === 'standard' 
                                                ? '3px solid var(--primary-green)' 
                                                : '2px solid rgba(255,255,255,0.2)',
                                            background: currentThresholdMode === 'standard' 
                                                ? 'rgba(16, 185, 129, 0.1)' 
                                                : 'rgba(255,255,255,0.05)',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s',
                                            minHeight: 'var(--min-touch-target)',
                                            textAlign: 'center'
                                        }}
                                    >
                                        <div style={{ fontSize: '24px', marginBottom: 'var(--space-xs)' }}>â­</div>
                                        <div style={{ fontWeight: 600, fontSize: 'var(--font-body-small)' }}>
                                            {language === 'zh' ? 'å¥åº·äººç¾¤' : 'Healthy'}
                                        </div>
                                        <div style={{ fontSize: 'var(--font-body-small)', color: 'var(--text-secondary)', marginTop: 'var(--space-xs)' }}>
                                            {language === 'zh' ? '40Â°/15Â°' : '40Â°/15Â°'}
                                        </div>
                                    </div>

                                    {/* SCIæ‚£è€… */}
                                    <div
                                        role="button"
                                        tabIndex={0}
                                        aria-label={language === 'zh' ? 'SCIæ‚£è€…ï¼šæ ¹æ®åº·å¤é˜¶æ®µè°ƒæ•´' : 'SCI Patient: Adjust by rehabilitation stage'}
                                        onClick={() => {
                                            // åˆ‡æ¢åˆ°SCIæ¨¡å¼ï¼ˆæ ¹æ®å½“å‰åº·å¤é˜¶æ®µé€‰æ‹©å¯¹åº”çš„æ¨¡å¼ï¼‰
                                            // æ€¥æ€§æœŸ -> sciRelaxed, æ¢å¤æœŸ -> sciRelaxed, ç¨³å®šæœŸ -> sciStrict
                                            let sciMode = 'sciRelaxed'; // é»˜è®¤ä½¿ç”¨å®½æ¾æ¨¡å¼
                                            if (rehabStage === 'stable') {
                                                sciMode = 'sciStrict'; // ç¨³å®šæœŸä½¿ç”¨ä¸¥æ ¼æ¨¡å¼
                                            }
                                            
                                            if (window.setThresholdMode) {
                                                window.setThresholdMode(sciMode, setCurrentThresholdModeState);
                                                // ç„¶åæ ¹æ®åº·å¤é˜¶æ®µåº”ç”¨é˜ˆå€¼
                                                if (adaptiveThresholdRef.current) {
                                                    applyRehabStageThresholds(rehabStage);
                                                }
                                                console.log(`âœ… å·²åˆ‡æ¢åˆ°SCIæ‚£è€…æ¨¡å¼ (${sciMode})ï¼Œåº·å¤é˜¶æ®µ: ${rehabStage}`);
                                            }
                                        }}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' || e.key === ' ') {
                                                e.preventDefault();
                                                let sciMode = 'sciRelaxed';
                                                if (rehabStage === 'stable') {
                                                    sciMode = 'sciStrict';
                                                }
                                                if (window.setThresholdMode) {
                                                    window.setThresholdMode(sciMode, setCurrentThresholdModeState);
                                                    if (adaptiveThresholdRef.current) {
                                                        applyRehabStageThresholds(rehabStage);
                                                    }
                                                }
                                            }
                                        }}
                                        style={{
                                            padding: 'var(--space-sm)',
                                            borderRadius: 'var(--radius-sm)',
                                            border: currentThresholdMode !== 'standard' 
                                                ? '3px solid var(--primary-blue)' 
                                                : '2px solid rgba(255,255,255,0.2)',
                                            background: currentThresholdMode !== 'standard' 
                                                ? 'rgba(59, 130, 246, 0.1)' 
                                                : 'rgba(255,255,255,0.05)',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s',
                                            minHeight: 'var(--min-touch-target)',
                                            textAlign: 'center'
                                        }}
                                    >
                                        <div style={{ fontSize: '24px', marginBottom: 'var(--space-xs)' }}>â™¿</div>
                                        <div style={{ fontWeight: 600, fontSize: 'var(--font-body-small)' }}>
                                            {language === 'zh' ? 'SCIæ‚£è€…' : 'SCI Patient'}
                                        </div>
                                        <div style={{ fontSize: 'var(--font-body-small)', color: 'var(--text-secondary)', marginTop: 'var(--space-xs)' }}>
                                            {language === 'zh' ? 'è‡ªé€‚åº”' : 'Adaptive'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* ç¬¬äºŒæ­¥ï¼šå¦‚æœæ˜¯SCIæ‚£è€…ï¼Œæ˜¾ç¤ºåº·å¤é˜¶æ®µé€‰æ‹©å™¨ */}
                            {currentThresholdMode !== 'standard' && (
                                <div style={{ marginTop: 'var(--space-md)' }}>
                                    <label style={{ 
                                        fontSize: 'var(--font-body-small)', 
                                        fontWeight: 600, 
                                        marginBottom: 'var(--space-xs)',
                                        display: 'block',
                                        color: 'var(--text-secondary)'
                                    }}>
                                        {language === 'zh' ? '2. åº·å¤é˜¶æ®µï¼ˆä»…SCIæ‚£è€…ï¼‰' : '2. Rehabilitation Stage (SCI Patients Only)'}
                            </label>
                                    <select
                                        value={rehabStage}
                                        onChange={(e) => {
                                            const newStage = e.target.value;
                                            setRehabStage(newStage);
                                            console.log(`ğŸ“… åº·å¤é˜¶æ®µå·²é€‰æ‹©: ${newStage}`);
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: 'var(--space-sm)',
                                            borderRadius: 'var(--radius-sm)',
                                            background: 'var(--bg-dark)',
                                            border: '1px solid rgba(255,255,255,0.2)',
                                            color: 'var(--text-primary)',
                                            fontSize: 'var(--font-body)',
                                            minHeight: 'var(--min-touch-target)',
                                            cursor: 'pointer'
                                        }}
                                        aria-label={language === 'zh' ? 'é€‰æ‹©åº·å¤é˜¶æ®µ' : 'Select rehabilitation stage'}
                                    >
                                        <option value="acute">
                                            {language === 'zh' ? 'æ€¥æ€§æœŸï¼ˆ0-3ä¸ªæœˆï¼‰- æœ€å®½æ¾é˜ˆå€¼' : 'Acute Stage (0-3 months) - Most Relaxed'}
                                        </option>
                                        <option value="recovery">
                                            {language === 'zh' ? 'æ¢å¤æœŸï¼ˆ3-12ä¸ªæœˆï¼‰- ä¸­ç­‰é˜ˆå€¼' : 'Recovery Stage (3-12 months) - Moderate'}
                                        </option>
                                        <option value="stable">
                                            {language === 'zh' ? 'ç¨³å®šæœŸï¼ˆ12ä¸ªæœˆä»¥ä¸Šï¼‰- æ ‡å‡†é˜ˆå€¼' : 'Stable Stage (12+ months) - Standard'}
                                        </option>
                                    </select>
                            <p style={{ 
                                fontSize: 'var(--font-body-small)', 
                                color: 'var(--text-secondary)',
                                marginTop: 'var(--space-xs)'
                            }}>
                                {language === 'zh' 
                                            ? `å½“å‰é˜ˆå€¼: é¢ˆéƒ¨ ${neckThreshold}Â°, èº¯å¹² ${torsoThreshold}Â°`
                                            : `Current thresholds: Neck ${neckThreshold}Â°, Torso ${torsoThreshold}Â°`
                                }
                            </p>
                                </div>
                            )}
                            
                            {/* å½“å‰æ¨¡å¼æ˜¾ç¤º */}
                            <div style={{ 
                                marginTop: 'var(--space-md)',
                                padding: 'var(--space-sm)',
                                background: 'rgba(59, 130, 246, 0.1)',
                                border: '1px solid rgba(59, 130, 246, 0.3)',
                                borderRadius: 'var(--radius-sm)'
                            }}>
                                <div style={{ fontSize: 'var(--font-body-small)', fontWeight: 600, marginBottom: 'var(--space-xs)' }}>
                                    {language === 'zh' ? 'å½“å‰é…ç½®' : 'Current Configuration'}
                                </div>
                                <div style={{ fontSize: 'var(--font-body-small)', color: 'var(--text-secondary)' }}>
                                    {currentThresholdMode === 'standard' ? (
                                        <span>{language === 'zh' ? 'â­ æ ‡å‡†æ¨¡å¼ - é€‚ç”¨äºå¥åº·äººç¾¤' : 'â­ Standard Mode - For healthy people'}</span>
                                    ) : (
                                        <span>
                                            {language === 'zh' 
                                                ? `â™¿ SCIæ‚£è€…æ¨¡å¼ - ${rehabStage === 'acute' ? 'æ€¥æ€§æœŸ' : rehabStage === 'recovery' ? 'æ¢å¤æœŸ' : 'ç¨³å®šæœŸ'} (é¢ˆéƒ¨ ${neckThreshold}Â°, èº¯å¹² ${torsoThreshold}Â°)`
                                                : `â™¿ SCI Patient Mode - ${rehabStage === 'acute' ? 'Acute' : rehabStage === 'recovery' ? 'Recovery' : 'Stable'} Stage (Neck ${neckThreshold}Â°, Torso ${torsoThreshold}Â°)`
                                            }
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* æ— éšœç¢è®¿é—®è®¾ç½® */}
                        <div className="setting-group">
                            <label style={{ 
                                fontSize: 'var(--font-body)', 
                                fontWeight: 600, 
                                marginBottom: 'var(--space-sm)',
                                display: 'block'
                            }}>
                                {language === 'zh' ? 'â™¿ æ— éšœç¢è®¿é—®' : 'â™¿ Accessibility'}
                            </label>
                            
                            {/* å¤§å­—ä½“æ¨¡å¼ */}
                            <div style={{ marginBottom: 'var(--space-md)' }}>
                                <label style={{ 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    justifyContent: 'space-between',
                                    marginBottom: 'var(--space-xs)'
                                }}>
                                    <span>{language === 'zh' ? 'å­—ä½“å¤§å°' : 'Font Size'}</span>
                                    <span style={{ 
                                        color: 'var(--primary-blue)', 
                                        fontWeight: 600,
                                        fontSize: 'var(--font-body-large)'
                                    }}>
                                        {fontSize}%
                                    </span>
                                </label>
                                <input
                                    type="range"
                                    min="100"
                                    max="200"
                                    step="10"
                                    value={fontSize}
                                    onChange={(e) => {
                                        const newSize = parseInt(e.target.value);
                                        // æ›´æ–°ReactçŠ¶æ€
                                        setFontSize(newSize);
                                        
                                        // ç«‹å³åº”ç”¨å­—ä½“å¤§å°
                                        if (window.accessibilityManager) {
                                            window.accessibilityManager.setFontSize(newSize);
                                        } else {
                                            // å¦‚æœaccessibilityManagerè¿˜æ²¡åˆå§‹åŒ–ï¼Œç›´æ¥åº”ç”¨æ ·å¼
                                            const root = document.documentElement;
                                            const scale = newSize / 100;
                                            root.style.setProperty('--font-scale', scale.toString());
                                            root.style.setProperty('--font-h1', `${32 * scale}px`);
                                            root.style.setProperty('--font-h2', `${24 * scale}px`);
                                            root.style.setProperty('--font-h3', `${20 * scale}px`);
                                            root.style.setProperty('--font-body-large', `${18 * scale}px`);
                                            root.style.setProperty('--font-body', `${16 * scale}px`);
                                            root.style.setProperty('--font-body-small', `${14 * scale}px`);
                                            if (document.body) {
                                                document.body.style.fontSize = `${16 * scale}px`;
                                            }
                                            localStorage.setItem('accessibility_fontSize', newSize.toString());
                                        }
                                        
                                        console.log(`âœ… å­—ä½“å¤§å°å·²æ›´æ–°ä¸º: ${newSize}%`);
                                    }}
                                    style={{ width: '100%', cursor: 'pointer' }}
                                    aria-label={language === 'zh' ? 'è°ƒæ•´å­—ä½“å¤§å°' : 'Adjust font size'}
                                />
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between',
                                    fontSize: 'var(--font-body-small)',
                                    color: 'var(--text-secondary)',
                                    marginTop: 'var(--space-xs)'
                                }}>
                                    <span>100%</span>
                                    <span>150%</span>
                                    <span>200%</span>
                                </div>
                            </div>

                            {/* é«˜å¯¹æ¯”åº¦æ¨¡å¼ */}
                            <label style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: 'var(--space-xs)',
                                minHeight: 'var(--min-touch-target)',
                                cursor: 'pointer'
                            }}>
                                <input
                                    type="checkbox"
                                    checked={highContrastMode}
                                    onChange={(e) => {
                                        const newValue = e.target.checked;
                                        
                                        // å…ˆæ›´æ–°ReactçŠ¶æ€
                                        setHighContrastMode(newValue);
                                        
                                        // åº”ç”¨é«˜å¯¹æ¯”åº¦æ ·å¼
                                        if (window.accessibilityManager) {
                                            // ç¡®ä¿accessibilityManagerçš„çŠ¶æ€ä¸ç›®æ ‡çŠ¶æ€ä¸€è‡´
                                            const currentState = window.accessibilityManager.isHighContrast();
                                            if (currentState !== newValue) {
                                                // çŠ¶æ€ä¸ä¸€è‡´ï¼Œéœ€è¦åˆ‡æ¢
                                                window.accessibilityManager.toggleHighContrast();
                                            }
                                        } else {
                                            // å¦‚æœaccessibilityManagerè¿˜æ²¡åˆå§‹åŒ–ï¼Œç›´æ¥åº”ç”¨æ ·å¼
                                            const root = document.documentElement;
                                            if (newValue) {
                                                root.classList.add('high-contrast-mode');
                                                root.style.setProperty('--bg-dark', '#000000', 'important');
                                                root.style.setProperty('--bg-card', '#1a1a1a', 'important');
                                                root.style.setProperty('--text-primary', '#FFFFFF', 'important');
                                                root.style.setProperty('--text-secondary', '#CCCCCC', 'important');
                                                root.style.setProperty('--primary-green', '#00FF00', 'important');
                                                root.style.setProperty('--danger-red', '#FF0000', 'important');
                                                root.style.setProperty('--primary-blue', '#00BFFF', 'important');
                                                root.style.setProperty('--warning-yellow', '#FFFF00', 'important');
                                            } else {
                                                root.classList.remove('high-contrast-mode');
                                                root.style.removeProperty('--bg-dark');
                                                root.style.removeProperty('--bg-card');
                                                root.style.removeProperty('--text-primary');
                                                root.style.removeProperty('--text-secondary');
                                                root.style.removeProperty('--primary-green');
                                                root.style.removeProperty('--danger-red');
                                                root.style.removeProperty('--primary-blue');
                                                root.style.removeProperty('--warning-yellow');
                                            }
                                            localStorage.setItem('accessibility_highContrast', newValue.toString());
                                        }
                                        
                                        console.log(`ğŸ¨ é«˜å¯¹æ¯”åº¦æ¨¡å¼: ${newValue ? 'å¼€å¯' : 'å…³é—­'}`);
                                    }}
                                    style={{ 
                                        width: '24px', 
                                        height: '24px',
                                        cursor: 'pointer'
                                    }}
                                    aria-label={language === 'zh' ? 'é«˜å¯¹æ¯”åº¦æ¨¡å¼' : 'High contrast mode'}
                                />
                                <span>{language === 'zh' ? 'é«˜å¯¹æ¯”åº¦æ¨¡å¼' : 'High Contrast Mode'}</span>
                            </label>
                        </div>
                        
                        {/* åº•éƒ¨æŒ‰é’® */}
                        <div className="drawer-footer">
                            <button className="btn-secondary" onClick={() => {
                                if (window.setThresholdMode) window.setThresholdMode('standard', null);
                                setNeckThreshold(DEFAULT_NECK_THRESHOLD_VALUE);
                                setTorsoThreshold(DEFAULT_TORSO_THRESHOLD_VALUE);
                            }}>
                                {language === 'zh' ? 'æ¢å¤é»˜è®¤' : 'Reset to Default'}
                            </button>
                            <button className="btn-primary" onClick={() => {
                                // ç¡®ä¿å­—ä½“å¤§å°å·²ä¿å­˜å’Œåº”ç”¨
                                if (window.accessibilityManager && fontSize) {
                                    window.accessibilityManager.setFontSize(fontSize);
                                }
                                
                                // ç¡®ä¿é«˜å¯¹æ¯”åº¦æ¨¡å¼å·²ä¿å­˜
                                if (window.accessibilityManager && highContrastMode !== window.accessibilityManager.isHighContrast()) {
                                    window.accessibilityManager.toggleHighContrast();
                                }
                                
                                setSettingsOpen(false);
                                console.log('âœ… æ‰€æœ‰è®¾ç½®å·²ä¿å­˜');
                                alert(language === 'zh' ? 'âœ… è®¾ç½®å·²ä¿å­˜' : 'âœ… Settings saved');
                            }}>
                                {language === 'zh' ? 'ä¿å­˜è®¾ç½®' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                    
                    {/* è®¾ç½®æŠ½å±‰é®ç½© */}
                    {settingsOpen && (
                        <div
                            onClick={() => setSettingsOpen(false)}
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(0, 0, 0, 0.5)',
                                zIndex: 999
                            }}
                        ></div>
                    )}
                </div>
            );
        }

        // ============================================================================
        // 6. åº”ç”¨å…¥å£ (APPLICATION ENTRY)
        // ============================================================================
        // åˆå§‹åŒ– React åº”ç”¨å¹¶æ¸²æŸ“åˆ° DOM
        // ============================================================================
        
        // ç­‰å¾… DOM åŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        function initApp() {
            // è°ƒè¯•ï¼šæ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½
            console.log('=== ä¾èµ–æ£€æŸ¥ ===');
            console.log('React:', typeof React !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            console.log('ReactDOM:', typeof ReactDOM !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            console.log('PostureMonitor:', typeof PostureMonitor !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('POSE_LANDMARKS:', typeof POSE_LANDMARKS !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('isLandmarkValid:', typeof isLandmarkValid !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('AngleSmoother:', typeof window.AngleSmoother !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('AdaptiveThresholdManager:', typeof window.AdaptiveThresholdManager !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('HysteresisEvaluator:', typeof window.HysteresisEvaluator !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('detectViewAngle:', typeof window.detectViewAngle !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('i18n:', typeof window.i18n !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
            console.log('================');
            
            // æ£€æŸ¥ root å…ƒç´ 
            const rootElement = document.getElementById('root');
            console.log('Rootå…ƒç´ :', rootElement ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
            if (rootElement) {
                console.log('Rootå…ƒç´ å†…å®¹:', rootElement.innerHTML.substring(0, 100));
            }
        
            // Render app
            // ä½¿ç”¨ React 18 çš„ createRoot APIï¼Œå¦‚æœä¸å¯ç”¨åˆ™å›é€€åˆ° ReactDOM.render
            try {
                const rootElement = document.getElementById('root');
                if (!rootElement) {
                    console.error('âŒ æ‰¾ä¸åˆ° root å…ƒç´ ');
                    document.body.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šæ‰¾ä¸åˆ° root å…ƒç´ </h1><p>è¯·æ£€æŸ¥ HTML ç»“æ„</p></div>';
                    return;
                }
                
                // æ£€æŸ¥å¿…è¦çš„ä¾èµ–
                if (typeof React === 'undefined') {
                    console.error('âŒ React æœªåŠ è½½');
                    rootElement.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šReact æœªåŠ è½½</h1><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®</p></div>';
                    return;
                }
                
                if (typeof ReactDOM === 'undefined') {
                    console.error('âŒ ReactDOM æœªåŠ è½½');
                    rootElement.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šReactDOM æœªåŠ è½½</h1><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®</p></div>';
                    return;
                }
                
                if (typeof PostureMonitor === 'undefined') {
                    console.error('âŒ PostureMonitor ç»„ä»¶æœªå®šä¹‰');
                    rootElement.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šPostureMonitor ç»„ä»¶æœªå®šä¹‰</h1><p>è¯·æ£€æŸ¥ JavaScript ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯</p></div>';
                    return;
                }
                
                console.log('âœ… æ‰¾åˆ° root å…ƒç´ ï¼Œå¼€å§‹æ¸²æŸ“åº”ç”¨...');
                
                if (ReactDOM.createRoot) {
                    const root = ReactDOM.createRoot(rootElement);
                    root.render(<PostureMonitor />);
                    console.log('âœ… åº”ç”¨å·²ä½¿ç”¨ ReactDOM.createRoot æ¸²æŸ“');
                } else if (ReactDOM.render) {
                    // å›é€€åˆ° React 17 çš„ render æ–¹æ³•
                    ReactDOM.render(<PostureMonitor />, rootElement);
                    console.log('âœ… åº”ç”¨å·²ä½¿ç”¨ ReactDOM.render æ¸²æŸ“');
                } else {
                    console.error('âŒ ReactDOM ä¸å¯ç”¨');
                    rootElement.innerHTML = '<div style="color: red; padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šReactDOM ä¸å¯ç”¨</h1><p>è¯·æ£€æŸ¥ React åº“æ˜¯å¦æ­£ç¡®åŠ è½½</p></div>';
                }
            } catch (error) {
                console.error('âŒ æ¸²æŸ“åº”ç”¨æ—¶å‡ºé”™:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                const rootElement = document.getElementById('root');
                if (rootElement) {
                    rootElement.innerHTML = `<div style="color: red; padding: 20px; text-align: center;">
                        <h1>åº”ç”¨æ¸²æŸ“å¤±è´¥</h1>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p>è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</p>
                    </div>`;
                }
            }
        }
    </script>
</body>
</html>
